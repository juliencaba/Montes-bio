<!doctype html>
<html lang="fr" data-lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Montes BioPharma — Assistant Littérature</title>
<meta name="color-scheme" content="light"/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- pdf.js (extraction PDF locale) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
<!-- mammoth.js (extraction DOCX locale) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" crossorigin="anonymous"></script>
<style>
/* =================== THEME — Flat, blanc, bleu clinique, vert fluo =================== */
:root{
  --bg:#ffffff;
  --ink:#0d2a5a;          /* bleu clinique/foncé — couleur unique pour le texte UI */
  --ink-muted:#5a6a88;    /* bleu adouci pour métadonnées */
  --blue:#0d2a5a;         /* même bleu pour éléments interactifs (flat) */
  --green:#00ff6a;        /* vert fluo pour le texte des boutons */
  --border:#e6eaf2;       /* bordures discrètes */
  --radius:14px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:Outfit,system-ui,-apple-system,"Segoe UI",Ubuntu,Arial,sans-serif;
}
a{color:var(--blue);text-decoration:none} a:hover{text-decoration:underline}
img{display:block;max-width:100%}

/* =================== PARTICLES (fond, vert fluo) =================== */
#particlesCanvas{position:fixed;inset:0;z-index:0;pointer-events:none}

/* =================== HEADER (flat) =================== */
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
.nav{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:10px}
.logo{height:40px;width:auto}
.brand{font-weight:700;letter-spacing:.02em;color:var(--ink)}
.lang{margin-left:auto;display:flex;gap:8px}
.lang button{
  appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);
  padding:6px 12px;border-radius:999px;cursor:pointer;font-weight:600
}
.lang button.active{border-color:var(--blue);}

/* =================== LAYOUT principal : pile inversée (bas -> haut) =================== */
.container{
  max-width:1180px;margin:0 auto;padding:18px 16px 80px;position:relative;z-index:1;
  display:flex;flex-direction:column-reverse;gap:16px; /* << le cœur : du bas vers le haut */
}

/* =================== Panneaux accordéon (flat) =================== */
.block{
  border:1px solid var(--border); border-radius:var(--radius); background:#fff;
}
.block header{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;background:#fff;
}
.block header h2{margin:0;font-size:18px;color:var(--ink)}
.block .inner{padding:14px 16px;display:none}
.block.open .inner{display:block}

/* =================== Inputs / Buttons (flat) =================== */
.grid{display:grid;gap:12px}
.row{display:grid;gap:10px}
@media(min-width:760px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}

label,strong,em,small{font-weight:600}
input,select,textarea{
  width:100%;background:#fff;color:var(--ink);
  border:1px solid var(--border);border-radius:12px;padding:12px 14px;outline:none;
}
input:focus,select:focus,textarea:focus{border-color:var(--blue)}

.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.btn{
  appearance:none;border:1px solid var(--blue);background:var(--blue);
  color:var(--green);font-weight:700;border-radius:12px;padding:12px 18px;cursor:pointer;
}
.btn.secondary{
  background:#fff;color:var(--ink);border:1px solid var(--blue);
}

/* Cartes articles (flat) */
.pub-card{
  border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;display:grid;gap:6px
}
.muted{color:var(--ink-muted)}
.tag{font-size:11px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;color:var(--ink);background:#fff}
hr.sep{border:none;border-top:1px solid var(--border);margin:10px 0}
pre#preview{white-space:pre-wrap;background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;color:#000}

/* Upload (flat) */
.drop{
  display:grid;place-items:center;text-align:center;gap:8px;
  padding:22px;border:2px dashed var(--border);border-radius:12px;background:#fff
}
.drop.drag{border-color:var(--blue)}
.file-list{display:grid;gap:10px;margin-top:10px}
.file-item{padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff}

/* Aides */
.kv{display:flex;gap:10px;align-items:center}
footer{color:var(--ink-muted);text-align:center;margin:28px 0}
</style>
</head>
<body>
<canvas id="particlesCanvas"></canvas>

<header>
  <div class="nav">
    <img src="./assets/montes-biopharma-logo.svg" alt="Montes BioPharma" class="logo">
    <div class="brand">Montes BioPharma</div>
    <div class="lang">
      <button id="btnFR" class="active">FR</button>
      <button id="btnEN">EN</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- Bloc 6 (en bas visuel, mais DOM en haut) : Aperçu & PDF -->
  <section id="blk5" class="block open">
    <header><h2 data-i="s5Title">Aperçu & Export PDF</h2><small class="muted">Protocole documentaire</small></header>
    <div class="inner">
      <div class="kv">
        <div class="muted" data-i="safety">Note : sortie documentaire basée littérature. Aucun paramètre expérimental.</div>
      </div>
      <pre id="preview"></pre>
      <div class="controls">
        <button class="btn" id="exportPdf" data-i="btnPdf">Exporter le PDF</button>
      </div>
    </div>
  </section>

  <!-- Bloc 5 : Analyse IA -->
  <section id="blk4" class="block">
    <header><h2 data-i="s4Title">Analyse IA (articles sélectionnés)</h2><small id="selInfo" class="muted"></small></header>
    <div class="inner">
      <p class="muted" data-i="s4Text">Sélectionne au moins 1 article puis lance l’analyse. Résumé automatique (Hugging Face).</p>
      <div id="selectedList" class="grid"></div>
      <div class="controls">
        <button class="btn" id="analyzeBtn" data-i="btnAnalyze">Analyser</button>
        <button class="btn secondary" data-open="#blk5">Continuer</button>
      </div>
    </div>
  </section>

  <!-- Bloc 4 : Résultats de recherche -->
  <section id="blk3" class="block">
    <header><h2 data-i="s3Title">Résultats littérature (Europe PMC)</h2><small id="searchInfo" class="muted"></small></header>
    <div class="inner">
      <div id="results" class="grid"></div>
      <div class="controls">
        <button class="btn secondary" data-open="#blk4">Continuer</button>
      </div>
    </div>
  </section>

  <!-- Bloc 3 : Lancer la recherche -->
  <section id="blk2" class="block">
    <header><h2 data-i="searchTitle">Recherche littérature</h2><small class="muted">Europe PMC (OA + abstracts)</small></header>
    <div class="inner">
      <div class="row row-2">
        <div>
          <label data-i="labYears">Fenêtre (années)</label>
          <select id="yearsWindow">
            <option value="1">1</option><option value="2" selected>2</option><option value="5">5</option><option value="10">10</option>
          </select>
        </div>
        <div>
          <label data-i="labMax">Nombre max. d’articles</label>
          <select id="retMax"><option value="5">5</option><option value="10" selected>10</option><option value="20">20</option><option value="50">50</option></select>
        </div>
      </div>
      <label class="kv" style="margin-top:8px">
        <input type="checkbox" id="onlyOA" checked style="width:auto">
        <span data-i="labOA">Uniquement open access (texte intégral)</span>
      </label>
      <div class="controls">
        <button class="btn" id="runSearch" data-i="btnSearch">Lancer la recherche</button>
        <button class="btn secondary" data-open="#blk3">Continuer</button>
      </div>
    </div>
  </section>

  <!-- Bloc 2 : Paramètres -->
  <section id="blk1" class="block">
    <header><h2 data-i="s2Title">Paramètres & Techniques</h2><small class="muted">Contexte scientifique</small></header>
    <div class="inner">
      <div class="row row-3">
        <div><label data-i="labVector">Vecteur</label><input id="vector" placeholder="Adenovirus"></div>
        <div><label data-i="labSerotype">Sérotype</label><input id="serotype" placeholder="Ad5"></div>
        <div><label data-i="labCellLine">Lignée cellulaire</label><input id="cellLine" placeholder="HEK293 / PER.C6"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label data-i="labKeywords">Mots-clés complémentaires</label><input id="keywords" placeholder="chromatography, anion exchange, membrane, affinity"></div>
      </div>
      <div class="grid" style="margin-top:10px">
        <strong data-i="techTitle">Techniques Downstream</strong>
        <label><input type="checkbox" class="tech" value="Clarification"> Clarification</label>
        <label><input type="checkbox" class="tech" value="Capture"> Capture (affinité / AEX)</label>
        <label><input type="checkbox" class="tech" value="Polishing"> Polishing</label>
        <label><input type="checkbox" class="tech" value="TFF"> TFF (Concentration / Diafiltration)</label>
        <label><input type="checkbox" class="tech" value="QC"> Contrôles qualité (attributs)</label>
        <label><input type="checkbox" class="tech" value="Formulation"> Formulation / Documentation</label>
      </div>
      <div class="controls">
        <button class="btn secondary" data-open="#blk2">Continuer</button>
      </div>
    </div>
  </section>

  <!-- Bloc 1 (tout en haut visuel) : Conformité + Upload internes -->
  <section id="blk0" class="block">
    <header><h2 data-i="s1Title">Contexte & conformité</h2><small class="muted">Usage pro uniquement</small></header>
    <div class="inner">
      <label class="kv">
        <input type="checkbox" id="compliance" style="width:auto">
        <span data-i="s1Check">Je confirme être un professionnel habilité et m’appuyer sur des SOP internes validées.</span>
      </label>

      <hr class="sep">

      <h3 data-i="s6Title">Documents internes (analyse locale)</h3>
      <p class="muted" data-i="s6Text">Déposez des fichiers PDF, DOCX ou TXT. Le texte est extrait localement dans votre navigateur (sans envoi réseau). La synthèse utilise Hugging Face (si configuré).</p>
      <div id="drop" class="drop">
        <div>
          <strong data-i="s6DropTitle">Déposez vos fichiers ici</strong>
          <div class="muted" data-i="s6DropHint">ou cliquez pour sélectionner</div>
          <small data-i="s6DropTypes">Acceptés : PDF, DOCX, TXT</small>
        </div>
        <input id="fileInput" type="file" multiple accept=".pdf,.docx,.txt" style="display:none">
      </div>
      <div class="file-list" id="filesList"></div>
      <div class="controls">
        <button class="btn" id="runLocal" data-i="btnAnalyze">Analyser</button>
        <button class="btn secondary" data-open="#blk1">Continuer</button>
      </div>
    </div>
  </section>
</main>

<footer>
  © <span id="year"></span> Montes BioPharma — Europe PMC / PubMed. Hugging Face (optionnel). Aucune instruction expérimentale.
</footer>

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

<script>
/* =================== PARTICLES — vert fluo sur fond blanc =================== */
const cv=document.getElementById('particlesCanvas'),cx=cv.getContext('2d');let W,H,PTS=[];
function size(){W=cv.width=innerWidth;H=cv.height=innerHeight} size(); addEventListener('resize',size);
function R(a,b){return a+Math.random()*(b-a)}
function spawn(){return{x:R(0,W),y:R(0,H),vx:R(-.04,.04),vy:-R(.02,.07),r:R(1.0,2.2),t:R(0,6.28),tw:R(.6,1.2)}}
PTS=Array.from({length:Math.min(220,Math.round((W*H)/17000))},spawn);
(function loop(){requestAnimationFrame(loop);cx.clearRect(0,0,W,H);
for(const p of PTS){p.t+=.016;const a=.10+.35*Math.abs(Math.sin(p.t))*p.tw;p.x+=p.vx+Math.sin(p.t*.35)*.03;p.y+=p.vy;
if(p.x<-6)p.x=W+6;if(p.x>W+6)p.x=-6;if(p.y<-6){p.y=H+6;p.x=Math.random()*W;}
cx.beginPath();cx.arc(p.x,p.y,p.r,0,6.283);
cx.fillStyle=`rgba(0,255,106,${a})`; /* vert fluo */
cx.fill();}})();

/* =================== i18n basique =================== */
const I={
  fr:{s1Title:"Contexte & conformité",s1Check:"Je confirme être un professionnel habilité et m’appuyer sur des SOP internes validées.",s2Title:"Paramètres & Techniques",techTitle:"Techniques Downstream",labVector:"Vecteur",labSerotype:"Sérotype",labCellLine:"Lignée cellulaire",labKeywords:"Mots-clés complémentaires",searchTitle:"Recherche littérature",labYears:"Fenêtre (années)",labMax:"Nombre max. d’articles",labOA:"Uniquement open access (texte intégral)",btnSearch:"Lancer la recherche",s3Title:"Résultats littérature (Europe PMC)",s4Title:"Analyse IA (articles sélectionnés)",s4Text:"Sélectionne au moins 1 article puis lance l’analyse. Résumé automatique (Hugging Face).",btnAnalyze:"Analyser",s5Title:"Aperçu & Export PDF",btnPdf:"Exporter le PDF",safety:"Note : sortie documentaire basée littérature. Aucun paramètre expérimental.",s6Title:"Documents internes (analyse locale)",s6Text:"Déposez des fichiers PDF, DOCX ou TXT. Le texte est extrait localement (aucun envoi réseau). La synthèse peut utiliser Hugging Face si configuré.",s6DropTitle:"Déposez vos fichiers ici",s6DropHint:"ou cliquez pour sélectionner",s6DropTypes:"Acceptés : PDF, DOCX, TXT"},
  en:{s1Title:"Context & compliance",s1Check:"I confirm I am a qualified professional and rely on validated internal SOPs.",s2Title:"Parameters & Techniques",techTitle:"Downstream techniques",labVector:"Vector",labSerotype:"Serotype",labCellLine:"Cell line",labKeywords:"Additional keywords",searchTitle:"Literature search",labYears:"Recency (years)",labMax:"Max articles",labOA:"Open access only (full text)",btnSearch:"Run search",s3Title:"Literature results (Europe PMC)",s4Title:"AI analysis (selected articles)",s4Text:"Select at least one article and run the analysis. Automatic summary (Hugging Face).",btnAnalyze:"Analyze",s5Title:"Preview & PDF",btnPdf:"Export PDF",safety:"Note: literature-based documentary output. No experimental parameters.",s6Title:"Internal documents (local analysis)",s6Text:"Drop PDF, DOCX or TXT files. Text is extracted locally (no network). Summaries may use Hugging Face if configured.",s6DropTitle:"Drop your files here",s6DropHint:"or click to select",s6DropTypes:"Accepted: PDF, DOCX, TXT"}
};
function setLang(lang){
  document.documentElement.setAttribute('lang',lang);
  document.documentElement.dataset.lang=lang;
  for(const el of document.querySelectorAll('[data-i]')){
    const k=el.dataset.i; el.textContent = I[lang][k] || el.textContent;
  }
}
document.getElementById('btnFR').onclick=()=>{setLang('fr');btnFR.classList.add('active');btnEN.classList.remove('active');};
document.getElementById('btnEN').onclick=()=>{setLang('en');btnEN.classList.add('active');btnFR.classList.remove('active');};
setLang('fr');
document.getElementById('year').textContent=new Date().getFullYear();

/* =================== Accordéon + défilement bas -> haut =================== */
for(const blk of document.querySelectorAll('.block')){
  const head=blk.querySelector('header');
  head.addEventListener('click', (e)=>{
    // éviter de refermer si clic sur bouton data-open
    if(e.target.closest('button[data-open]')) return;
    blk.classList.toggle('open');
  });
}
// boutons "Continuer" : ouvrent le bloc ciblé (au-dessus à l’écran)
for(const btn of document.querySelectorAll('button[data-open]')){
  btn.addEventListener('click', ()=>{
    const sel = btn.getAttribute('data-open');
    const target = document.querySelector(sel);
    if(target){ target.classList.add('open'); target.scrollIntoView({behavior:'smooth',block:'center'}); }
  });
}

/* =================== État & utilitaires =================== */
const state={ vector:"",serotype:"",cellLine:"",techniques:[],yearsWindow:2,retMax:10,onlyOA:true,articles:[],abstracts:{},fulltexts:{},aiText:"",citations:[], uploads:[] };
const REDACT=/\b\d+(?:[\.,]\d+)?\s?(?:mL|ml|L|µL|uL|°C|C|rpm|g|xg|min|h|hours?|days?|M|mM|µM|uM|%|nm|mm|cm|kDa)\b/gi;
function sanitize(txt){return (txt||"").replace(REDACT,"[…]");}
function esc(s){return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}

/* =================== Recherche Europe PMC =================== */
document.getElementById('runSearch').onclick=runSearchEPMC;
async function runSearchEPMC(){
  if(!document.getElementById('compliance').checked){ alert(document.documentElement.dataset.lang==='fr'?'Merci de confirmer la conformité.':'Please confirm compliance.'); return; }
  state.vector=document.getElementById('vector').value.trim()||'adenovirus';
  state.serotype=document.getElementById('serotype').value.trim();
  state.cellLine=document.getElementById('cellLine').value.trim();
  const extra=(document.getElementById('keywords').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  state.yearsWindow=+document.getElementById('yearsWindow').value||2;
  state.retMax=+document.getElementById('retMax').value||10;
  state.onlyOA=document.getElementById('onlyOA').checked;

  const minYear=(new Date().getFullYear()-state.yearsWindow);
  const terms=[state.vector,state.serotype,state.cellLine,...extra].filter(Boolean).join(' ');
  let q = `${terms} AND PUB_YEAR:[${minYear} TO 3000] AND HAS_ABSTRACT:Y`; if(state.onlyOA) q+=` AND OPEN_ACCESS:Y`;
  const url = `https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(q)}&pageSize=${state.retMax}&format=json&sort_date:y`;

  const info=document.getElementById('searchInfo'); info.textContent=(document.documentElement.dataset.lang==='fr'?'Recherche…':'Searching…');
  try{
    const r=await fetch(url); const j=await r.json(); const res=(j.resultList?.result)||[];
    state.articles = res.map(x=>{
      const id = x.pmid ? x.pmid : x.pmcid; const src = x.pmid ? 'MED' : 'PMC';
      return { id, src, pmid:x.pmid||'', doi:x.doi||'', title:x.title||'', source:x.journalTitle||x.source||'', year:x.pubYear||'', authors:(x.authorString||'').split(', ').slice(0,6), oa:(x.isOpenAccess==="Y"||x.openAccess=="Y"||x.openAccess), selected:false, hasAbstractInline:!!x.abstractText, abstractInline:x.abstractText||'' };
    });
    renderResults();
    info.textContent = `${state.articles.length} ${(document.documentElement.dataset.lang==='fr'?'article(s)':'result(s)')}`;
    // Ouvrir auto le bloc Résultats
    document.querySelector('#blk3').classList.add('open');
    document.querySelector('#blk3').scrollIntoView({behavior:'smooth',block:'center'});
  }catch(e){
    console.error(e);
    document.getElementById('results').innerHTML='<div class="pub-card">Erreur Europe PMC.</div>';
    info.textContent='';
  }
}
function renderResults(){
  const box=document.getElementById('results'); box.innerHTML='';
  state.articles.forEach((a,idx)=>{
    const el=document.createElement('div'); el.className='pub-card';
    const link = a.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/` : `https://europepmc.org/article/${a.src}/${a.id}`;
    el.innerHTML=`
      <label style="display:flex;gap:10px;align-items:flex-start">
        <input type="checkbox" data-id="${a.id}" style="width:auto;margin-top:4px">
        <div>
          <div><strong>${esc(a.title)}</strong> ${a.oa?'<span class="tag">Open Access</span>':''}</div>
          <div class="muted">${esc(a.source)} · ${esc(a.year||'—')}</div>
          <div class="muted">${esc(a.authors.join(', '))}</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <span class="tag">${a.src}:${a.id}${a.pmid?` · PMID:${a.pmid}`:''}${a.doi?` · DOI:${a.doi}`:''}</span>
            <a class="tag" href="${link}" target="_blank" rel="noopener noreferrer">${document.documentElement.dataset.lang==='fr'?'Voir':'Open'}</a>
          </div>
          <div id="abs-${idx}" class="muted" style="margin-top:6px;font-size:13px"></div>
          ${a.oa?`<button class="btn secondary" data-full="${idx}" style="margin-top:8px">${document.documentElement.dataset.lang==='fr'?'Charger le texte intégral':'Load full text'}</button>`:''}
        </div>
      </label>`;
    el.querySelector('input').addEventListener('change',e=>{a.selected=e.target.checked; updateSelectionInfo();});
    box.appendChild(el);

    const absEl=el.querySelector(`#abs-${idx}`);
    if(a.abstractInline){absEl.textContent = a.abstractInline;}
    else if(a.pmid){
      fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/MED/${a.pmid}/abstractText?format=plain`).then(r=>r.text()).then(t=>absEl.textContent=t).catch(()=>{});
    }

    const btn=el.querySelector(`[data-full="${idx}"]`);
    if(btn){
      btn.onclick=async()=>{
        btn.disabled=true;
        const url=`https://www.ebi.ac.uk/europepmc/webservices/rest/${a.src}/${a.id}/fullTextXML`;
        try{
          const r=await fetch(url); const xml=await r.text();
          state.fulltexts[a.id]=xml;
          btn.textContent=document.documentElement.dataset.lang==='fr'?'Texte intégral chargé':'Full text loaded';
        }catch(e){btn.disabled=false;btn.textContent='Retry';}
      };
    }
  });
  updateSelectionInfo();
}
function updateSelectionInfo(){
  const n=state.articles.filter(a=>a.selected).length;
  const txt = `${n} ${document.documentElement.dataset.lang==='fr'?'sélectionné(s) — min: 1':'selected — min: 1'}`;
  const selInfo=document.getElementById('selInfo'); if(selInfo) selInfo.textContent=txt;
  const L=document.getElementById('selectedList'); if(!L) return;
  const chosen=state.articles.filter(a=>a.selected);
  L.innerHTML = chosen.length
    ? chosen.map(a=>`<div class="pub-card"><strong>${esc(a.title)}</strong><div class="muted">${esc(a.source)} · ${esc(a.year||'—')} — ${a.src}:${a.id}${a.doi?` — DOI:${a.doi}`:''}</div></div>`).join('')
    : `<div class="pub-card muted">${document.documentElement.dataset.lang==='fr'?'Aucune sélection.':'No selection.'}</div>`;
}

/* =================== IA Hugging Face (résumé) =================== */
document.getElementById('analyzeBtn').onclick=analyzeSelected;
async function analyzeSelected(){
  const chosen=state.articles.filter(a=>a.selected);
  if(chosen.length<1){alert(document.documentElement.dataset.lang==='fr'?'Sélectionne au moins 1 article.':'Select at least 1 article.');return;}
  const techs=[...document.querySelectorAll('.tech:checked')].map(x=>x.value);
  if(!techs.length){alert(document.documentElement.dataset.lang==='fr'?'Sélectionne au moins une technique.':'Select at least one technique.');return;}

  const HF_TOKEN = "hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; // <-- remplace si tu utilises Hugging Face
  const HF_MODEL = "facebook/bart-large-cnn";

  document.getElementById('selInfo').textContent=(document.documentElement.dataset.lang==='fr'?'Analyse IA…':'AI analysis…');

  const docs = [];
  for(const a of chosen.slice(0,8)){
    let text="";
    if(state.fulltexts[a.id]) text = extractTextFromFullTextXML(state.fulltexts[a.id]);
    else{
      const abs = a.abstractInline || await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/${a.src}/${a.id}/abstractText?format=plain`).then(r=>r.text()).catch(()=> '');
      text = abs;
    }
    text = (text||"").replace(/\s+/g,' ').slice(0, 4000);
    docs.push({ meta:a, text });
  }

  const summaries=[];
  for(const d of docs){
    try{
      const response = await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`,{
        headers:{Authorization:`Bearer ${HF_TOKEN}`,"Content-Type":"application/json"},
        method:"POST", body: JSON.stringify({ inputs: d.text })
      });
      const result = await response.json();
      const summary = (Array.isArray(result) && result[0]?.summary_text) ? result[0].summary_text : "(summary unavailable)";
      summaries.push({ meta:d.meta, summary });
    }catch(e){ console.error("HF error", e); }
  }

  const lang=document.documentElement.dataset.lang;
  let body = (lang==='fr'?`## Synthèse interprétée (documentaire)\n`:`## Interpreted synthesis (documentary)\n`);
  body += (lang==='fr'
    ? `Demande: vecteur=${document.getElementById('vector').value||'Adenovirus'}; sérotype=${document.getElementById('serotype').value||''}; lignée=${document.getElementById('cellLine').value||''}; techniques=${techs.join(', ')}.\n\n`
    : `Request: vector=${document.getElementById('vector').value||'Adenovirus'}; serotype=${document.getElementById('serotype').value||''}; cell line=${document.getElementById('cellLine').value||''}; techniques=${techs.join(', ')}.\n\n`);

  body += (lang==='fr'?`### Articles analysés\n`:`### Analyzed articles\n`);
  summaries.forEach((s,i)=>{
    body += `**[${i+1}] ${s.meta.title}** (${s.meta.year}, ${s.meta.source}) — ${sanitize(s.summary)}\n\n`;
  });

  body += (lang==='fr'
    ? `### Proposition documentaire (non-opérationnelle)\nSynthèse des pratiques : amont cellulaire, récolte & clarification, capture (affinité/AEX), TFF, polishing, contrôles qualité. Paramètres opératoires volontairement absents.\n\n`
    : `### Documentary proposal (non-operational)\nPractices synthesized: upstream cell production, harvest & clarification, capture (affinity/AEX), TFF, polishing, quality controls. Operational parameters intentionally omitted.\n\n`);

  state.aiText = body;
  state.citations = summaries.map((s,i)=>({
    n:i+1,title:s.meta.title,year:s.meta.year,source:s.meta.source,
    pmid:s.meta.pmid,doi:s.meta.doi,
    url: s.meta.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${s.meta.pmid}/` : `https://europepmc.org/article/${s.meta.src}/${s.meta.id}`
  }));

  renderPreview();
  // ouvrir le bloc Aperçu
  const b=document.querySelector('#blk5'); b.classList.add('open'); b.scrollIntoView({behavior:'smooth',block:'center'});
}

/* =================== Fulltext XML → texte =================== */
function extractTextFromFullTextXML(xmlString){
  const parser=new DOMParser();
  let text=''; try{
    const xml=parser.parseFromString(xmlString,'text/xml');
    const wanted=['materials','methods','materials and methods','results','discussion','introduction','conclusion'];
    const secs=[...xml.querySelectorAll('sec')];
    for(const s of secs){
      const title=(s.querySelector('title')?.textContent||'').toLowerCase();
      if(wanted.some(w=>title.includes(w))){
        const ps=[...s.querySelectorAll('p')].map(p=>p.textContent.trim()).join('\n');
        text += (title?(`\n\n### ${title}\n`):'\n\n') + ps;
      }
    }
    if(!text){ text = [...xml.querySelectorAll('p')].map(p=>p.textContent.trim()).join('\n'); }
  }catch(e){}
  return text;
}

/* =================== Upload local (PDF/DOCX/TXT) =================== */
const drop = document.getElementById('drop');
const input = document.getElementById('fileInput');
const list = document.getElementById('filesList');
drop.addEventListener('click',()=>input.click());
drop.addEventListener('dragover',(e)=>{e.preventDefault();drop.classList.add('drag');});
drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
drop.addEventListener('drop',(e)=>{e.preventDefault();drop.classList.remove('drag');handleFiles(e.dataTransfer.files);});
input.addEventListener('change',(e)=>handleFiles(e.target.files));

function handleFiles(files){
  [...files].forEach(f=>{
    state.uploads.push({file:f, text:null});
    const item=document.createElement('div'); item.className='file-item';
    item.textContent = `${f.name} — ${(f.size/1024/1024).toFixed(2)} MB`;
    list.appendChild(item);
  });
}
document.getElementById('runLocal').onclick = runLocalAnalysis;

async function runLocalAnalysis(){
  const texts=[];
  for(const u of state.uploads){
    if(u.text){ texts.push({name:u.file.name, text:u.text}); continue; }
    const ext = u.file.name.toLowerCase().split('.').pop();
    const buf = await u.file.arrayBuffer();

    if(ext==='pdf'){
      const pdfjsLib = window['pdfjsLib'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const pdf = await pdfjsLib.getDocument({data:buf}).promise;
      let out=''; for(let i=1;i<=pdf.numPages;i++){ const page = await pdf.getPage(i); const content=await page.getTextContent(); out += content.items.map(it=>it.str).join(' ') + '\n'; }
      u.text = out.replace(/\s+/g,' ').trim();
    }else if(ext==='docx'){
      const res = await window.mammoth.extractRawText({arrayBuffer:buf});
      u.text = (res.value||'').replace(/\s+/g,' ').trim();
    }else if(ext==='txt'){
      u.text = new TextDecoder().decode(new Uint8Array(buf)).replace(/\s+/g,' ').trim();
    }else{
      u.text = '';
    }
    texts.push({name:u.file.name, text:u.text});
  }

  if(!texts.length){ alert(document.documentElement.dataset.lang==='fr'?'Aucun fichier.':'No file.'); return; }

  const HF_TOKEN = "hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; // <-- optionnel
  const HF_MODEL = "facebook/bart-large-cnn";
  const summaries=[];
  for(const t of texts){
    const clip = (t.text||'').slice(0,4000);
    if(!clip){ summaries.push({name:t.name, summary:'(vide)'}); continue; }
    if(HF_TOKEN.startsWith("hf_")){
      try{
        const resp = await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`,{
          method:'POST',
          headers:{Authorization:`Bearer ${HF_TOKEN}`,'Content-Type':'application/json'},
          body:JSON.stringify({inputs: clip})
        });
        const j=await resp.json();
        const s=(Array.isArray(j)&&j[0]?.summary_text)?j[0].summary_text:'(summary unavailable)';
        summaries.push({name:t.name, summary:sanitize(s)});
      }catch(e){ summaries.push({name:t.name, summary:'(error)'}); }
    }else{
      // Pas de token : on se contente d'ajouter le texte brut (ou message)
      summaries.push({name:t.name, summary:'(IA non configurée — ajoute un token Hugging Face pour résumer automatiquement)'});
    }
  }

  const lang=document.documentElement.dataset.lang;
  let block = (lang==='fr'?`## Documents internes — Synthèse locale (documentaire)\n`:`## Internal documents — Local synthesis (documentary)\n`);
  summaries.forEach(s=>{ block += `**${s.name}** — ${s.summary}\n\n`; });

  state.aiText = (state.aiText||'') + '\n' + block;
  renderPreview();
  // ouvrir l’aperçu
  const b=document.querySelector('#blk5'); b.classList.add('open'); b.scrollIntoView({behavior:'smooth',block:'center'});
}

/* =================== Preview & Export PDF (fond blanc, titres bleus) =================== */
function renderPreview(){
  const lang=document.documentElement.dataset.lang;
  const meta=[
    document.getElementById('vector').value?`${lang==='fr'?'Vecteur':'Vector'} : ${document.getElementById('vector').value}`:null,
    document.getElementById('serotype').value?`${lang==='fr'?'Sérotype':'Serotype'} : ${document.getElementById('serotype').value}`:null,
    document.getElementById('cellLine').value?`${lang==='fr'?'Lignée cellulaire':'Cell line'} : ${document.getElementById('cellLine').value}`:null
  ].filter(Boolean).join('\n');

  const foot = (state.citations||[]).map(c=>`[${c.n}] ${c.title} (${c.year}), ${c.source}${c.doi?` — DOI:${c.doi}`:''}${c.pmid?` — PMID:${c.pmid}`:''} — ${c.url}`).join('\n');
  const doc = `${lang==='fr'
  ? `# Protocole documentaire — Purification Adénovirus\n\n${meta}\n\n## Résumé & méthode\nRevue Europe PMC (abstracts + OA). Synthèse IA (si configurée). Aucune instruction expérimentale.\n`
  : `# Documentary protocol — Adenovirus purification\n\n${meta}\n\n## Summary & method\nEurope PMC review (abstracts + OA). AI synthesis (if configured). No experimental instructions.\n`}

${state.aiText||''}

${lang==='fr'?'## Références (notes de bas de page)':'## References (footnotes)'}
${foot||'(none)'}
`;
  document.getElementById('preview').textContent=doc;
}
document.getElementById('exportPdf').onclick=exportPDF;

async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt',format:'a4'});
  const M=56, W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();

  // fond blanc
  pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F');

  // logo
  try{
    const res=await fetch('./assets/montes-biopharma-logo.svg'); const blob=await res.blob();
    const data=await blobToDataURL(blob);
    pdf.addImage(data,'PNG',M,M-8,160,40,'','FAST');
  }catch(e){}

  // titre
  setText(pdf,'#0d2a5a',18,'bold');
  const lang=document.documentElement.dataset.lang;
  pdf.text(lang==='fr'?'Protocole documentaire — Purification Adénovirus':'Documentary protocol — Adenovirus purification', M+180, M+14);
  setText(pdf,'#333333',11,'normal');

  // ligne bleue
  pdf.setDrawColor(13,42,90); pdf.setLineWidth(2); pdf.line(M, M+50, W-M, M+50);

  // contenu
  let y=M+74;
  const content=document.getElementById('preview').textContent||'';
  const lines=content.split('\n');
  for(const raw of lines){
    const line=raw.trim();
    if(!line){ y+=6; continue; }
    if(line.startsWith('# ')){ y=putHeading(pdf,line.replace(/^#\s+/,'').trim(),y,16,'#0d2a5a',M,W,H); }
    else if(line.startsWith('## ')){ y=putHeading(pdf,line.replace(/^##\s+/,'').trim(),y,13,'#0d2a5a',M,W,H); }
    else if(line.startsWith('### ')){ y=putHeading(pdf,line.replace(/^###\s+/,'').trim(),y,12,'#0d2a5a',M,W,H); }
    else { y=putParagraph(pdf,line,y,M,W,H,11); }
  }
  pdf.save(lang==='fr'?'protocole-documentaire-adenovirus.pdf':'documentary-protocol-adenovirus.pdf');
}
function setText(pdf,hex,size,weight){const [r,g,b]=hexToRGB(hex); pdf.setTextColor(r,g,b); pdf.setFont('helvetica', weight==='bold'?'bold':'normal'); pdf.setFontSize(size);}
function putHeading(pdf,text,y,size,color,M,W,H){
  if(y + size + 18 > H - M){ pdf.addPage(); pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F'); y=M; }
  setText(pdf,color,size,'bold'); pdf.text(text,M,y); y += size<14?12:16;
  pdf.setDrawColor(210,210,210); pdf.setLineWidth(.6); pdf.line(M,y,W-M,y);
  return y+12;
}
function putParagraph(pdf,text,y,M,W,H,size=11){
  setText(pdf,'#000000',size,'normal'); /* texte noir dans PDF pour lisibilité */
  const safe=(text||'').replace(REDACT,"[…]");
  const chunks=pdf.splitTextToSize(safe,W-2*M);
  for(const ln of chunks){
    if(y > H - M){ pdf.addPage(); pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F'); y=M; }
    pdf.text(ln,M,y); y += 14;
  }
  return y+4;
}
function hexToRGB(hex){const h=hex.replace('#','');const n=parseInt(h,16);return [(n>>16)&255,(n>>8)&255,n&255];}
function blobToDataURL(blob){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(blob);});}
</script>
</body>
</html>
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Montes BioPharma — Assistant Littérature (Europe PMC)</title>
<meta name="color-scheme" content="dark"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#060b19;--bg2:#0b1326;--text:#eaf2ff;--muted:#a6b8d6;
  --g:#7CF45B;--b:#2456FF;--glass:rgba(15,26,45,.42);
  --border:rgba(124,244,91,.38);--inner:rgba(36,86,255,.10);--radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Roboto,system-ui,-apple-system,"Segoe UI",Ubuntu,Arial,sans-serif;color:var(--text);
  background:
    radial-gradient(1000px 500px at 20% -10%, rgba(36,86,255,.22), transparent 60%),
    radial-gradient(900px 480px at 85% -8%, rgba(124,244,91,.12), transparent 65%),
    linear-gradient(180deg, var(--bg1), var(--bg2) 40%, #0a1122 100%);
  overflow-x:hidden;
}
#particlesCanvas{position:fixed;inset:0;z-index:0;pointer-events:none}

header{
  position:sticky;top:0;z-index:10;
  background:linear-gradient(90deg, rgba(124,244,91,.10), rgba(36,86,255,.16));
  backdrop-filter:blur(10px) saturate(160%);
  border-bottom:1px solid var(--border);
}
.nav{max-width:1180px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;gap:12px}
.logo{height:42px;width:auto;object-fit:contain}
.brand{font-weight:700;letter-spacing:.35px}

.container{max-width:1180px;margin:28px auto;padding:0 18px;position:relative;z-index:1}
.hero{display:flex;align-items:center;gap:16px;margin:14px 0}
.hero h1{
  margin:0;font-size:clamp(22px,4vw,36px);
  background:linear-gradient(90deg, var(--g), var(--b));
  -webkit-background-clip:text;background-clip:text;color:transparent;
  text-shadow:0 0 32px rgba(124,244,91,.55), 0 0 32px rgba(36,86,255,.45);
}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 30%), var(--glass);
  border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:0 18px 40px rgba(0,0,0,.55), inset 0 0 0 1px var(--inner);
  backdrop-filter: blur(12px) saturate(120%);
  padding:20px;margin-bottom:18px;
}
.muted{color:var(--muted)} a{color:var(--g)} a:hover{text-decoration:underline}
.btn{
  appearance:none;border:none;cursor:pointer;font-weight:700;border-radius:12px;
  padding:12px 18px;background:linear-gradient(90deg,var(--g),var(--b));color:#02121f;
  box-shadow:0 10px 28px rgba(36,86,255,.24),0 10px 28px rgba(124,244,91,.28);
}
.btn.secondary{background:rgba(9,20,40,.6);color:var(--text);border:1px solid rgba(124,244,91,.3)}
.controls{display:flex;gap:10px;flex-wrap:wrap}

.step{display:none} .step.active{display:block}
.grid{display:grid;gap:14px}
.row{display:grid;gap:10px}
@media(min-width:760px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
input,select,textarea{
  width:100%;background:rgba(9,20,40,.55);color:var(--text);
  border:1px solid rgba(124,244,91,.30);border-radius:12px;padding:12px 14px;outline:none;backdrop-filter: blur(6px);
  transition:border .2s, box-shadow .2s, background .2s;box-shadow: inset 0 0 0 1px rgba(36,86,255,.10);
}
input:focus,select:focus,textarea:focus{
  border-color:var(--g);background:rgba(9,20,40,.68);
  box-shadow:0 0 0 3px rgba(124,244,91,.18), inset 0 0 0 1px rgba(36,86,255,.12);
}
.pub-card{
  border:1px solid rgba(124,244,91,.28);border-radius:14px;padding:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%), rgba(12,21,42,.38);
  display:grid;gap:8px;backdrop-filter: blur(10px) saturate(120%);box-shadow: inset 0 0 0 1px rgba(36,86,255,.10);
}
.tag{font-size:11px;padding:4px 8px;border:1px solid rgba(124,244,91,.28);border-radius:999px;color:#cfe6ff;background:rgba(9,20,40,.45)}
hr.sep{border:none;border-top:1px solid rgba(124,244,91,.25);margin:10px 0}
pre#preview{white-space:pre-wrap}
</style>
</head>
<body>
<canvas id="particlesCanvas"></canvas>

<header>
  <div class="nav">
    <img src="./assets/montes-biopharma-logo.svg" alt="Montes BioPharma" class="logo">
    <div class="brand">Montes BioPharma</div>
    <div style="margin-left:auto" class="muted">Assistant Littérature — Europe PMC (CORS OK)</div>
  </div>
</header>

<main class="container">
  <div class="hero">
    <img src="./assets/montes-biopharma-logo.svg" alt="Montes BioPharma" class="logo" style="height:72px;filter:drop-shadow(0 10px 26px rgba(124,244,91,.30)) drop-shadow(0 12px 30px rgba(36,86,255,.22))">
    <h1>Purification Adénovirus — Sélection & Synthèse bibliographique</h1>
  </div>

  <!-- Étape 1: Contexte -->
  <section id="step1" class="card step active">
    <h2>Étape 1 — Contexte & conformité</h2>
    <p class="muted">Usage strictement professionnel. Cette application fournit une <em>ossature documentaire</em> basée sur la littérature. <strong>Aucun paramètre expérimental ni protocole opératoire n’est fourni.</strong></p>
    <label style="display:flex;align-items:flex-start;gap:10px;margin-top:8px">
      <input type="checkbox" id="compliance" style="width:auto;margin-top:4px">
      <span>Je confirme être un professionnel habilité et m’appuyer sur des SOP internes validées.</span>
    </label>
    <div class="controls" style="margin-top:10px">
      <button class="btn" id="to2">Continuer</button>
    </div>
  </section>

  <!-- Étape 2: Paramètres -->
  <section id="step2" class="card step">
    <h2>Étape 2 — Paramètres & techniques ciblées</h2>
    <div class="row row-3">
      <div><label>Vecteur</label><input id="vector" placeholder="Adénovirus"></div>
      <div><label>Sérotype</label><input id="serotype" placeholder="Ad5"></div>
      <div><label>Lignée cellulaire</label><input id="cellLine" placeholder="HEK293 / PER.C6"></div>
    </div>
    <div class="card" style="padding:14px;margin-top:12px">
      <strong>Techniques Downstream</strong>
      <div class="row row-3" style="margin-top:8px">
        <label><input type="checkbox" class="tech" value="Clarification"> Clarification</label>
        <label><input type="checkbox" class="tech" value="Capture"> Capture (affinité / AEX)</label>
        <label><input type="checkbox" class="tech" value="Polishing"> Polishing</label>
        <label><input type="checkbox" class="tech" value="TFF"> TFF (Concentration / Diafiltration)</label>
        <label><input type="checkbox" class="tech" value="QC"> Contrôles qualité (attributs)</label>
        <label><input type="checkbox" class="tech" value="Formulation"> Conditionnement / Documentation</label>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Mots-clés complémentaires</label><input id="keywords" placeholder="chromatography, anion exchange, membrane, affinity"></div>
    </div>
    <div class="controls" style="margin-top:12px">
      <button class="btn secondary" id="back2">Retour</button>
      <button class="btn" id="to3">Continuer</button>
    </div>
  </section>

  <!-- Étape 3: Recherche Europe PMC -->
  <section id="step3" class="card step">
    <h2>Étape 3 — Recherche (Europe PMC, abstracts réels)</h2>
    <div class="row row-2">
      <div>
        <label>Fenêtre (années récentes)</label>
        <select id="yearsWindow">
          <option value="1">1 an</option>
          <option value="2" selected>2 ans</option>
          <option value="5">5 ans</option>
          <option value="10">10 ans</option>
        </select>
      </div>
      <div>
        <label>Nombre max. d’articles</label>
        <select id="retMax">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>
    <div class="controls" style="margin-top:8px">
      <button class="btn" id="runSearch">Lancer la recherche</button>
      <span id="searchInfo" class="muted"></span>
    </div>
    <hr class="sep">
    <div id="results" class="grid"></div>
    <div class="controls" style="margin-top:12px">
      <button class="btn secondary" id="back3">Retour</button>
      <button class="btn" id="to4">Continuer</button>
    </div>
  </section>

  <!-- Étape 4: Sélection & analyse -->
  <section id="step4" class="card step">
    <h2>Étape 4 — Sélection des articles & analyse ciblée</h2>
    <p class="muted">Coche <strong>au moins 5 articles</strong> puis lance l’analyse. Nous extrayons des phrases pertinentes des <em>abstracts</em> en fonction des techniques choisies. <strong>Les paramètres opératoires sont masqués automatiquement.</strong></p>
    <div class="controls">
      <button class="btn" id="analyzeBtn">Analyser les articles sélectionnés</button>
      <span id="selInfo" class="muted"></span>
    </div>
    <hr class="sep">
    <div id="selectedList" class="grid"></div>
    <div class="controls" style="margin-top:12px">
      <button class="btn secondary" id="back4">Retour</button>
      <button class="btn" id="to5">Continuer</button>
    </div>
  </section>

  <!-- Étape 5: Aperçu & PDF -->
  <section id="step5" class="card step">
    <h2>Étape 5 — Aperçu & export PDF</h2>
    <pre id="preview"></pre>
    <div class="controls" style="margin-top:10px">
      <button class="btn" id="exportPdf">Exporter le PDF</button>
      <button class="btn secondary" id="restart">Recommencer</button>
    </div>
  </section>

  <p class="muted" style="text-align:center;margin:28px 0 48px">
    © <span id="year"></span> Montes BioPharma — Données issues d’Europe PMC (CORS OK). Aucun protocole expérimental.
  </p>
</main>

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

<script>
/* ========= Particules dérivantes ========= */
const cv=document.getElementById('particlesCanvas'),cx=cv.getContext('2d');let W,H,PTS=[];
function size(){W=cv.width=innerWidth;H=cv.height=innerHeight} size(); addEventListener('resize',size);
function R(a,b){return a+Math.random()*(b-a)}
function spawn(){return{x:R(0,W),y:R(0,H),vx:R(-.06,.06),vy:-R(.05,.16),r:R(.9,2.1),t:R(0,6.28),tw:R(.5,1.0)}}
PTS=Array.from({length:Math.min(220,Math.round((W*H)/15000))},spawn);
(function loop(){requestAnimationFrame(loop);cx.clearRect(0,0,W,H);
for(const p of PTS){p.t+=.02;const a=.2+.4*Math.abs(Math.sin(p.t))*p.tw;p.x+=p.vx+Math.sin(p.t*.5)*.04;p.y+=p.vy;
if(p.x<-5)p.x=W+5;if(p.x>W+5)p.x=-5;if(p.y<-5){p.y=H+5;p.x=Math.random()*W;}
cx.beginPath();cx.arc(p.x,p.y,p.r,0,6.283);cx.fillStyle=`rgba(124,244,91,${a})`;cx.shadowColor='rgba(124,244,91,.75)';cx.shadowBlur=8;cx.fill();cx.shadowBlur=0;}})();

/* ========= Wizard nav ========= */
const steps=['step1','step2','step3','step4','step5'];
function show(id){steps.forEach(s=>document.getElementById(s).classList.remove('active'));document.getElementById(id).classList.add('active');window.scrollTo({top:0,behavior:'smooth'});}
document.getElementById('year').textContent=new Date().getFullYear();
document.getElementById('to2').onclick=()=>{if(!document.getElementById('compliance').checked){alert("Merci de confirmer l'usage professionnel.");return;}show('step2');};
document.getElementById('back2').onclick=()=>show('step1');
document.getElementById('to3').onclick=()=>show('step3');
document.getElementById('back3').onclick=()=>show('step2');
document.getElementById('to4').onclick=()=>show('step4');
document.getElementById('back4').onclick=()=>show('step3');
document.getElementById('to5').onclick=()=>show('step5');
document.getElementById('restart').onclick=()=>{localStorage.removeItem('mbp_state');location.reload();};

/* ========= État & utilitaires ========= */
const state={
  vector:"", serotype:"", cellLine:"",
  techniques:[],
  yearsWindow:2, retMax:10,
  articles:[],      // {id, pmid, source, title, year, authors, selected}
  abstracts:{},     // id -> abstract text
  summaries:{}      // id -> {Technique: "..."}
};
const TECH_KEYWORDS={
  Clarification:["clarification","depth filter","microfiltration","centrifugation","filter"],
  Capture:["capture","affinity","anion exchange","aex","ion exchange","chromatography","membrane"],
  Polishing:["polishing","sec","size exclusion","mixed-mode","anion exchange","cation exchange"],
  TFF:["tff","tangential flow","diafiltration","buffer exchange","concentration"],
  QC:["quality","analytics","potency","purity","endotoxin","rca","residual"],
  Formulation:["formulation","stability","storage","buffer","excipient"]
};
const REDACT=/\b\d+(?:[\.,]\d+)?\s?(?:mL|ml|L|µL|uL|°C|C|rpm|g|xg|min|h|hours?|days?|M|mM|µM|uM|%|nm|mm|cm|kDa)\b/gi;
function sanitize(txt){return (txt||"").replace(REDACT,"[…]");}
function esc(s){return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}

/* ========= Europe PMC (CORS OK) =========
   - Recherche : /rest/search?query=...&pageSize=...&format=json
   - Abstract : /rest/{src}/{id}/abstractText?format=plain
   Sources possibles: MED (PubMed), PMC. */
document.getElementById('runSearch').onclick=runSearchEPMC;

async function runSearchEPMC(){
  state.vector=document.getElementById('vector').value.trim()||'adenovirus';
  state.serotype=document.getElementById('serotype').value.trim();
  state.cellLine=document.getElementById('cellLine').value.trim();
  const extra=(document.getElementById('keywords').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  state.yearsWindow=+document.getElementById('yearsWindow').value||2;
  state.retMax=+document.getElementById('retMax').value||10;

  const minYear=(new Date().getFullYear()-state.yearsWindow);
  // Requête Europe PMC : filtres + année + abstract
  const terms=[state.vector,state.serotype,state.cellLine,...extra].filter(Boolean).join(' ');
  const q = `${terms} AND PUB_YEAR:[${minYear} TO 3000] AND HAS_ABSTRACT:Y`;
  const url = `https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(q)}&pageSize=${state.retMax}&format=json&sort_date:y`;

  document.getElementById('searchInfo').textContent="Recherche en cours…";
  try{
    const r=await fetch(url);
    const j=await r.json();
    const res=(j.resultList?.result)||[];
    state.articles = res.map(x=>{
      // id & source : MED + pmid, ou PMC + pmcid
      const id = x.pmid ? x.pmid : x.pmcid;
      const src = x.pmid ? 'MED' : 'PMC';
      return {
        id, src,
        pmid: x.pmid || '',
        title: x.title || '',
        source: x.journalTitle || x.source || '',
        year: x.pubYear || '',
        authors: (x.authorString||'').split(', ').slice(0,6),
        selected:false,
        hasAbstractInline: !!x.abstractText,
        abstractInline: x.abstractText || ''
      };
    });
    renderResults();
    document.getElementById('searchInfo').textContent=`${state.articles.length} article(s) — Europe PMC (CORS OK).`;
  }catch(e){
    console.error(e);
    document.getElementById('results').innerHTML='<div class="card">Erreur Europe PMC (réseau).</div>';
    document.getElementById('searchInfo').textContent='';
  }
}

function renderResults(){
  const box=document.getElementById('results'); box.innerHTML='';
  state.articles.forEach(a=>{
    const el=document.createElement('div'); el.className='pub-card';
    const pubLink = a.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/` : `https://europepmc.org/article/${a.src}/${a.id}`;
    el.innerHTML=`
      <label style="display:flex;gap:10px;align-items:flex-start">
        <input type="checkbox" data-id="${a.id}" style="width:auto;margin-top:4px">
        <div>
          <div><strong>${esc(a.title)}</strong></div>
          <div class="muted">${esc(a.source)} · ${esc(a.year||'—')}</div>
          <div class="muted">Auteurs: ${esc(a.authors.join(', '))}</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <span class="tag">${a.src}:${a.id}${a.pmid?` · PMID:${a.pmid}`:''}</span>
            <a class="tag" href="${pubLink}" target="_blank" rel="noopener noreferrer">Voir l’article</a>
          </div>
        </div>
      </label>`;
    el.querySelector('input').addEventListener('change',e=>{
      a.selected=e.target.checked; updateSelectionInfo();
    });
    box.appendChild(el);
  });
  updateSelectionInfo();
}

function updateSelectionInfo(){
  const n=state.articles.filter(a=>a.selected).length;
  const txt=`${n} article(s) sélectionné(s) — minimum requis : 5`;
  const selInfo=document.getElementById('selInfo'); if(selInfo) selInfo.textContent=txt;
  const L=document.getElementById('selectedList');
  if(!L) return;
  const chosen=state.articles.filter(a=>a.selected);
  L.innerHTML = chosen.length
    ? chosen.map(a=>`<div class="pub-card"><strong>${esc(a.title)}</strong><div class="muted">${esc(a.source)} · ${esc(a.year||'—')} — ${a.src}:${a.id}</div></div>`).join('')
    : '<div class="pub-card muted">Aucune sélection pour l’instant.</div>';
}

/* ========= Analyse (récupère les abstracts réels) ========= */
document.getElementById('analyzeBtn').onclick=analyzeSelected;

async function analyzeSelected(){
  const chosen=state.articles.filter(a=>a.selected);
  if(chosen.length<5){alert("Sélectionne au moins 5 articles.");return;}
  const techs=[...document.querySelectorAll('.tech:checked')].map(x=>x.value);
  if(!techs.length){alert("Sélectionne au moins une technique (Étape 2).");return;}

  // Récup abstracts : si pas en ligne, appelle /rest/{src}/{id}/abstractText?format=plain
  state.abstracts={};
  for(const a of chosen){
    if(a.hasAbstractInline && a.abstractInline){
      state.abstracts[a.id]=a.abstractInline;
      continue;
    }
    const absUrl = `https://www.ebi.ac.uk/europepmc/webservices/rest/${a.src}/${a.id}/abstractText?format=plain`;
    try{
      const r=await fetch(absUrl);
      const t=await r.text();
      state.abstracts[a.id]=t||'';
    }catch(e){
      console.error(e); state.abstracts[a.id]='';
    }
  }

  // Génère résumés par technique (extraction de phrases contenant mots-clés)
  state.summaries={};
  chosen.forEach(a=>{
    const abs=(state.abstracts[a.id]||'').replace(/\s+/g,' ').trim();
    const perTech={};
    techs.forEach(t=>{
      const bullets = extractBullets(abs, t);
      perTech[t] = bullets.length ? bullets.map(b=>sanitize(b)).join(" • ") : "(aucune phrase saillante trouvée dans l’abstract pour cette technique)";
    });
    state.summaries[a.id]=perTech;
  });

  renderPreview();
  alert("Analyse terminée : synthèses par technique disponibles (Étape 5).");
}

function extractBullets(text, tech){
  if(!text) return [];
  const kws=(TECH_KEYWORDS[tech]||[]).map(k=>k.toLowerCase());
  const sentences=text.split(/(?<=[\.\!\?])\s+/);
  const hits=sentences.filter(s=>kws.some(k=>s.toLowerCase().includes(k)));
  return hits.slice(0,5).map(s=>s.replace(/\s+/g,' ').trim());
}

/* ========= Aperçu & Export PDF ========= */
function renderPreview(){
  const meta=[
    document.getElementById('vector').value?`Vecteur : ${document.getElementById('vector').value}`:null,
    document.getElementById('serotype').value?`Sérotype : ${document.getElementById('serotype').value}`:null,
    document.getElementById('cellLine').value?`Lignée cellulaire : ${document.getElementById('cellLine').value}`:null
  ].filter(Boolean).join('\n');

  const techs=[...document.querySelectorAll('.tech:checked')].map(x=>x.value);
  const chosen=state.articles.filter(a=>a.selected);
  const refs=chosen.map(a=>{
    const link = a.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/` : `https://europepmc.org/article/${a.src}/${a.id}`;
    return `- ${a.title} (${a.year||'—'}), ${a.source}. ${a.pmid?`PMID:${a.pmid}; `:''}${a.src}:${a.id} — ${link}`;
  }).join('\n');

  let synth='';
  techs.forEach(t=>{
    synth+=`### ${t}\n`;
    chosen.forEach(a=>{
      const s=state.summaries[a.id]?.[t];
      if(s) synth+=`• ${a.title} — ${s}\n`;
    });
    synth+='\n';
  });

  const outline = `# Protocole documentaire — Purification Adénovirus

${meta||''}

## 1. Portée et principes
Synthèse bibliographique ciblée (Europe PMC) des techniques sélectionnées. Ce document est une **ossature documentaire** : il **n’inclut aucun paramètre expérimental** ni instruction opératoire. Les détails proviennent de vos **SOP internes validées**.

## 2. Techniques sélectionnées
${techs.length?techs.join(', '):'(aucune)'}

## 3. Synthèses par techniques (extraits d’abstracts)
${synth || '(Aucune analyse disponible.)'}

## 4. Références
${refs || '(Aucune)'}
`;
  document.getElementById('preview').textContent=outline;
}
document.getElementById('exportPdf').onclick=exportPDF;

async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt',format:'a4'});
  const M=56, W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();

  // fond blanc
  pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F');

  // logo
  try{
    const res=await fetch('./assets/montes-biopharma-logo.svg'); const blob=await res.blob();
    const data=await blobToDataURL(blob);
    pdf.addImage(data,'PNG',M,M-8,160,40,'','FAST');
  }catch(e){/* logo optionnel */}

  // titre
  setText(pdf,'#2456FF',18,'bold');
  pdf.text('Protocole documentaire — Purification Adénovirus', M+180, M+14);
  setText(pdf,'#3a3a3a',11,'normal');
  const metaLine=[
    document.getElementById('vector').value?`Vecteur: ${document.getElementById('vector').value}`:null,
    document.getElementById('serotype').value?`Sérotype: ${document.getElementById('serotype').value}`:null,
    document.getElementById('cellLine').value?`Cell line: ${document.getElementById('cellLine').value}`:null
  ].filter(Boolean).join(' · ');
  if(metaLine) pdf.text(metaLine, M+180, M+34);

  // barres colorées
  pdf.setDrawColor(124,244,91); pdf.setLineWidth(2); pdf.line(M, M+50, W-M, M+50);
  pdf.setDrawColor(36,86,255); pdf.setLineWidth(2); pdf.line(M, M+54, W-M, M+54);

  // contenu
  let y=M+80;
  const content=document.getElementById('preview').textContent||'';
  const lines=content.split('\n');
  for(const raw of lines){
    const line=raw.trim();
    if(!line){ y+=6; continue; }
    if(line.startsWith('# ')){ y=putHeading(pdf,line.replace(/^#\s+/,'').trim(),y,16,'#2456FF',M,W,H); }
    else if(line.startsWith('## ')){ y=putHeading(pdf,line.replace(/^##\s+/,'').trim(),y,13,'#7CF45B',M,W,H); }
    else if(line.startsWith('### ')){ y=putHeading(pdf,line.replace(/^###\s+/,'').trim(),y,12,'#7CF45B',M,W,H); }
    else { y=putParagraph(pdf,line,y,M,W,H,11); }
  }
  pdf.save('protocole-documentaire-adenovirus.pdf');
}

function setText(pdf,hex,size,weight){
  const [r,g,b]=hexToRGB(hex); pdf.setTextColor(r,g,b);
  pdf.setFont('helvetica', weight==='bold'?'bold':'normal'); pdf.setFontSize(size);
}
function putHeading(pdf,text,y,size,color,M,W,H){
  if(y + size + 18 > H - M){ pdf.addPage(); pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F'); y=M; }
  setText(pdf,color,size,'bold'); pdf.text(text,M,y); y += size<14?12:16;
  pdf.setDrawColor(210,210,210); pdf.setLineWidth(.6); pdf.line(M,y,W-M,y);
  return y+12;
}
function putParagraph(pdf,text,y,M,W,H,size=11){
  setText(pdf,'#000000',size,'normal');
  const safe=sanitize(text);
  const chunks=pdf.splitTextToSize(safe,W-2*M);
  for(const ln of chunks){
    if(y > H - M){ pdf.addPage(); pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F'); y=M; }
    pdf.text(ln,M,y); y += 14;
  }
  return y+4;
}
function hexToRGB(hex){const h=hex.replace('#','');const n=parseInt(h,16);return [(n>>16)&255,(n>>8)&255,n&255];}
function blobToDataURL(blob){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(blob);});}
</script>
</body>
</html>

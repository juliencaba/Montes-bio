<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Montes BioPharma — Assistant IA PubMed</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<meta name="color-scheme" content="dark"/>
<style>
:root{
  --bg1:#060b19;--bg2:#0b1326;--text:#eaf2ff;--muted:#a6b8d6;
  --g:#7CF45B;--b:#2456FF;--card:rgba(15,26,45,.42);--border:rgba(124,244,91,.38);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Roboto,Arial,sans-serif;color:var(--text);
background:radial-gradient(1000px 500px at 20% -10%,rgba(36,86,255,.22),transparent 60%),
radial-gradient(900px 480px at 85% -8%,rgba(124,244,91,.12),transparent 65%),
linear-gradient(180deg,var(--bg1),var(--bg2) 40%,#0a1122 100%);}
header{position:sticky;top:0;z-index:5;
background:linear-gradient(90deg,rgba(124,244,91,.10),rgba(36,86,255,.16));
backdrop-filter:blur(10px);border-bottom:1px solid var(--border);}
.nav{max-width:1100px;margin:auto;padding:10px 18px;display:flex;align-items:center;gap:10px}
.logo{height:42px}
.container{max-width:1100px;margin:25px auto;padding:0 18px;position:relative;z-index:1}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;
padding:18px;margin-bottom:20px;backdrop-filter:blur(10px)}
.btn{cursor:pointer;background:linear-gradient(90deg,var(--g),var(--b));color:#02121f;
border:none;border-radius:10px;padding:10px 16px;font-weight:700;margin-top:8px}
.btn.secondary{background:rgba(9,20,40,.6);color:var(--text);border:1px solid rgba(124,244,91,.3)}
.pub-card{background:rgba(12,21,42,.38);border:1px solid rgba(124,244,91,.25);border-radius:12px;padding:10px;margin-bottom:8px}
.muted{color:var(--muted)}a{color:var(--g)}
.step{display:none}.step.active{display:block}
#particlesCanvas{position:fixed;inset:0;z-index:0;pointer-events:none}
</style>
</head>
<body>
<canvas id="particlesCanvas"></canvas>

<header>
 <div class="nav">
   <img src="./assets/montes-biopharma-logo.svg" alt="logo" class="logo">
   <strong>Montes BioPharma</strong>
   <span style="margin-left:auto;color:var(--muted)">Assistant Littérature</span>
 </div>
</header>

<main class="container">
 <!-- Étape 1 -->
 <section class="card step active" id="s1">
  <h2>1 – Contexte</h2>
  <p>Confirmez votre usage professionnel.</p>
  <label><input type="checkbox" id="ok"/> Je confirme être habilité</label><br>
  <button class="btn" id="next1">Continuer</button>
 </section>

 <!-- Étape 2 -->
 <section class="card step" id="s2">
  <h2>2 – Paramètres</h2>
  <label>Vecteur viral :</label><input id="vector" placeholder="Adénovirus"><br>
  <label>Sérotype :</label><input id="sero" placeholder="Ad5"><br>
  <label>Lignée cellulaire :</label><input id="cell" placeholder="HEK293"><br>
  <label>Techniques :</label><br>
  <label><input type="checkbox" class="tech" value="Clarification"> Clarification</label>
  <label><input type="checkbox" class="tech" value="Capture"> Capture</label>
  <label><input type="checkbox" class="tech" value="Polishing"> Polishing</label>
  <label><input type="checkbox" class="tech" value="TFF"> TFF</label>
  <label><input type="checkbox" class="tech" value="QC"> QC</label>
  <label><input type="checkbox" class="tech" value="Formulation"> Formulation</label><br>
  <button class="btn secondary" id="back2">Retour</button>
  <button class="btn" id="next2">Continuer</button>
 </section>

 <!-- Étape 3 -->
 <section class="card step" id="s3">
  <h2>3 – Recherche PubMed</h2>
  <label>Mots-clés supplémentaires :</label>
  <input id="kw" placeholder="chromatography, purification">
  <button class="btn" id="runSearch">Lancer la recherche</button>
  <p class="muted" id="info">Les résultats proviennent directement de PubMed.</p>
  <div id="pubResults"></div>
  <button class="btn secondary" id="back3">Retour</button>
  <button class="btn" id="next3">Continuer</button>
 </section>

 <!-- Étape 4 -->
 <section class="card step" id="s4">
  <h2>4 – Sélection et analyse</h2>
  <p>Sélectionnez au moins 5 articles, puis analysez.</p>
  <button class="btn" id="analyzeBtn">Analyser les articles</button>
  <div id="selectedList"></div>
  <button class="btn secondary" id="back4">Retour</button>
  <button class="btn" id="next4">Continuer</button>
 </section>

 <!-- Étape 5 -->
 <section class="card step" id="s5">
  <h2>5 – Aperçu et export PDF</h2>
  <pre id="preview" style="white-space:pre-wrap"></pre>
  <button class="btn" id="exportPdf">Exporter PDF</button>
  <button class="btn secondary" id="restart">Recommencer</button>
 </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
/* ========= Navigation ========= */
let step=1;const max=5;
function show(i){document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
document.getElementById('s'+i).classList.add('active');step=i;window.scrollTo(0,0);}
document.getElementById('next1').onclick=()=>{if(!ok.checked){alert('Cochez la case.');return;}show(2);}
document.getElementById('next2').onclick=()=>show(3);
document.getElementById('back2').onclick=()=>show(1);
document.getElementById('next3').onclick=()=>show(4);
document.getElementById('back3').onclick=()=>show(2);
document.getElementById('next4').onclick=()=>show(5);
document.getElementById('back4').onclick=()=>show(3);
document.getElementById('restart').onclick=()=>location.reload();

/* ========= Particules ========= */
const c=document.getElementById('particlesCanvas'),x=c.getContext('2d');let W,H,P=[];
function resize(){W=c.width=innerWidth;H=c.height=innerHeight}resize();addEventListener('resize',resize);
function r(a,b){return a+Math.random()*(b-a)}
for(let i=0;i<160;i++)P.push({x:r(0,W),y:r(0,H),vx:r(-.05,.05),vy:r(-.1,-.3),r:r(.8,2.2),t:r(0,6.28)});
!function loop(){requestAnimationFrame(loop);x.clearRect(0,0,W,H);
for(const p of P){p.t+=.02;p.x+=p.vx;p.y+=p.vy;if(p.y<-5)p.y=H+5;
x.beginPath();x.arc(p.x,p.y,p.r,0,6.28);const a=.3+.4*Math.abs(Math.sin(p.t));
x.fillStyle=`rgba(124,244,91,${a})`;x.shadowColor='rgba(124,244,91,.6)';x.shadowBlur=8;x.fill();x.shadowBlur=0;}}();

/* ========= PubMed Search ========= */
let articles=[],selected=[],abstracts={},summaries={};
const headers={'User-Agent':'MontesBioPharma/1.0 (https://github.com/JulienCM)'};

document.getElementById('runSearch').onclick=runPubMedSearch;
async function runPubMedSearch(){
 const base='https://eutils.ncbi.nlm.nih.gov/entrez/eutils/';
 const kw=[
  'adenovirus',
  document.getElementById('vector').value||'',
  document.getElementById('sero').value||'',
  document.getElementById('cell').value||'',
  document.getElementById('kw').value||''
 ].join(' ');
 const esearch=`${base}esearch.fcgi?db=pubmed&retmode=json&retmax=20&sort=date&term=${encodeURIComponent(kw)}`;
 let ids=[];try{
  const r=await fetch(esearch,{headers});const j=await r.json();ids=j.esearchresult.idlist||[];
 }catch(e){console.error(e);alert("Erreur CORS ou réseau.");return;}
 if(!ids.length){pubResults.innerHTML='<div class="card">Aucun résultat.</div>';return;}
 const esum=`${base}esummary.fcgi?db=pubmed&retmode=json&id=${ids.join(',')}`;
 try{
  const r=await fetch(esum,{headers});const j=await r.json();
  const recs=Object.values(j.result||{}).filter(v=>v.uid);
  articles=recs.map(v=>({pmid:v.uid,title:v.title||'',year:(v.pubdate||'').slice(0,4),
  journal:v.fulljournalname||v.source||'',authors:(v.authors||[]).map(a=>a.name).slice(0,5).join(', '),sel:false}));
 }catch(e){console.error(e);return;}
 renderResults();
}
function renderResults(){
 pubResults.innerHTML='';
 articles.forEach(a=>{
  const d=document.createElement('div');d.className='pub-card';
  d.innerHTML=`<label><input type="checkbox" data-id="${a.pmid}"> <strong>${a.title}</strong></label><br>
  <span class="muted">${a.journal} · ${a.year}</span><br><span class="muted">${a.authors}</span><br>
  <a href="https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/" target="_blank">Voir PubMed</a>`;
  d.querySelector('input').onchange=e=>{a.sel=e.target.checked;};
  pubResults.appendChild(d);
 });
 info.textContent="Sélectionnez au moins 5 articles.";
}

/* ========= Analyse ========= */
document.getElementById('analyzeBtn').onclick=analyze;
async function analyze(){
 selected=articles.filter(a=>a.sel);
 if(selected.length<5){alert("Sélectionnez au moins 5 articles.");return;}
 const ids=selected.map(a=>a.pmid);
 const base='https://eutils.ncbi.nlm.nih.gov/entrez/eutils/';
 const url=`${base}efetch.fcgi?db=pubmed&id=${ids.join(',')}&retmode=xml`;
 let xml;try{
  const r=await fetch(url,{headers});const t=await r.text();
  xml=new DOMParser().parseFromString(t,"text/xml");
 }catch(e){alert("Erreur EFetch.");return;}
 abstracts={};xml.querySelectorAll("PubmedArticle").forEach(a=>{
  const pmid=a.querySelector("PMID").textContent.trim();
  const ab=a.querySelector("AbstractText");abstracts[pmid]=ab?ab.textContent.trim():"";
 });
 const TECH={"Clarification":["clarification","filtration","centrifugation"],
 "Capture":["capture","affinity","ion exchange","chromatography"],
 "Polishing":["polishing","sec","size exclusion"],"TFF":["tff","diafiltration","buffer exchange"],
 "QC":["quality","analytics","purity"],"Formulation":["formulation","stability","storage"]};
 const techs=[...document.querySelectorAll('.tech:checked')].map(x=>x.value);
 summaries={};
 selected.forEach(a=>{
  const abs=abstracts[a.pmid]||"",S={};
  techs.forEach(t=>{
   const hits=abs.split(/(?<=[.!?])\s+/).filter(s=>TECH[t].some(k=>s.toLowerCase().includes(k)));
   S[t]=hits.slice(0,3).map(s=>s.replace(/\b\d+(?:[\.,]\d+)?\s?(mL|ml|g|rpm|°C|%|h|min)\b/gi,"[…]")).join(" • ");
  });
  summaries[a.pmid]=S;
 });
 renderPreview();
 alert("Analyse terminée !");
}
function renderPreview(){
 let out=`# Protocole documentaire Adénovirus\n\n## Techniques\n`;
 const techs=[...document.querySelectorAll('.tech:checked')].map(x=>x.value);
 out+=techs.join(', ')+"\n\n## Résumés par technique\n";
 selected.forEach(a=>{
  out+=`### ${a.title}\n`;
  techs.forEach(t=>{out+=`• ${t} → ${summaries[a.pmid][t]||"(aucune info)"}\n`;});
 });
 preview.textContent=out;
}

/* ========= Export PDF ========= */
document.getElementById('exportPdf').onclick=async()=>{
 const {jsPDF}=window.jspdf;const pdf=new jsPDF({unit:'pt',format:'a4'});
 const W=pdf.internal.pageSize.getWidth(),H=pdf.internal.pageSize.getHeight(),M=56;
 pdf.setFillColor(255,255,255);pdf.rect(0,0,W,H,'F');
 try{const res=await fetch('./assets/montes-biopharma-logo.svg');
 const blob=await res.blob();const fr=new FileReader();fr.onload=()=>{pdf.addImage(fr.result,'PNG',M,M-8,160,40,'','FAST');pdf.save('protocole.pdf');};
 fr.readAsDataURL(blob);}catch(e){pdf.save('protocole.pdf');}
};
</script>
</body>
</html>

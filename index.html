<!doctype html>
<html lang="fr" data-lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Montes BioPharma — Assistant Littérature</title>
<meta name="color-scheme" content="light"/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" crossorigin="anonymous"></script>

<style>
:root{
  --bg:#F6F7FB; --panel:#FFFFFF; --ink:#0F1226; --muted:#6C7392;
  --primary:#3A49FF; --accent:#00FF6A; --border:#E6E9F4;
  --radius:18px; --shadow:0 10px 30px rgba(15,18,38,.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Outfit,system-ui,-apple-system,"Segoe UI",Ubuntu,Arial,sans-serif}
a{color:var(--primary);text-decoration:none}a:hover{text-decoration:underline}
img{display:block;max-width:100%}
.hide{display:none}

/* Particles */
#particlesCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;mix-blend-mode:multiply;opacity:.75}

/* Header */
header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(180%) blur(10px);background:rgba(255,255,255,.7);border-bottom:1px solid var(--border)}
.nav{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;gap:14px}
.logo{height:40px;width:auto}
.brand{font-weight:800;letter-spacing:.02em;color:var(--ink)}
.lang{margin-left:auto;display:flex;gap:8px;align-items:center}
.icon-btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:10px}
#menuBtn .bars{position:relative;width:18px;height:12px}
#menuBtn .bars::before,#menuBtn .bars::after,#menuBtn .bar{content:"";position:absolute;left:0;right:0;height:2px;background:#3A49FF;border-radius:2px}
#menuBtn .bar{top:5px}#menuBtn .bars::before{top:0}#menuBtn .bars::after{bottom:0}

/* Dropdown menu (top) */
#menuDropdown{position:absolute;right:20px;top:56px;z-index:60;min-width:220px;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 14px 36px rgba(15,18,38,.12);display:none;overflow:hidden}
#menuDropdown.open{display:block}
.menu-item{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;border-bottom:1px solid var(--border);background:#fff}
.menu-item:last-child{border-bottom:none}
.menu-item:hover{background:#F6F8FF}
.menu-item .dot{width:8px;height:8px;border-radius:50%;background:#C8CEFF}

/* Gradient transition overlay */
#xfade{position:fixed;inset:0;pointer-events:none;z-index:50;opacity:0;background:radial-gradient(1200px 800px at 50% 50%, rgba(58,73,255,.18), rgba(0,0,0,0));transition:opacity .45s ease}
#xfade.show{opacity:1}

/* Hero + tiles (Intro) */
.hero{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:56px 20px 18px}
.kicker{color:var(--accent);font-weight:800;letter-spacing:.28em;font-size:13px;text-transform:uppercase}
h1.hero-title{margin:10px 0 10px;font-size:clamp(36px,6vw,64px);line-height:1.04;color:var(--primary);text-transform:uppercase;font-weight:800}
.hero-sub{color:var(--muted);font-size:18px;max-width:820px}
.cta{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px}
.btn{appearance:none;cursor:pointer;border-radius:999px;padding:14px 22px;font-weight:700;border:2px solid transparent;transition:transform .06s ease, box-shadow .2s ease, background .2s ease,color .2s ease}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
.btn.primary:hover{box-shadow:0 14px 36px rgba(58,73,255,.25)}
.btn.ghost{background:#fff;color:var(--primary);border-color:var(--primary)}
.btn.secondary{background:#fff;color:var(--primary);border:2px solid var(--primary)}
.btn.flat{background:#fff;color:#111;border-color:#E0E5FF}

/* Tiles */
.services{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:14px 20px 8px}
.tiles{display:grid;gap:16px}
@media(min-width:880px){.tiles{grid-template-columns:repeat(4,1fr)}}
.tile{background:linear-gradient(180deg,#F8F9FF,#EEF1FF);border:1px solid #E0E5FF;border-radius:18px;padding:18px;box-shadow:0 12px 24px rgba(58,73,255,.08);transition:transform .18s ease, box-shadow .18s ease}
.tile:hover{transform:translateY(-3px);box-shadow:0 18px 36px rgba(58,73,255,.16)}
.tile .badge{display:inline-block;font-size:12px;padding:4px 10px;border-radius:999px;background:#fff;border:1px solid #D7DEFF;color:#3A49FF;font-weight:800;letter-spacing:.04em}
.tile h3{margin:10px 0 6px;color:#0F1226}
.tile p{margin:0;color:var(--muted);font-size:14px}

/* Sections / Cards */
.section{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:22px 20px 10px}
.cards{display:grid;gap:18px}
@media(min-width:880px){.cards{grid-template-columns:1fr 1fr}}
.block{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.block header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:18px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#fff,#FBFCFF)}
.block header .overline{color:var(--accent);font-weight:800;letter-spacing:.18em;font-size:11px}
.block header h2{margin:2px 0 0;font-size:22px;color:var(--primary);text-transform:uppercase;letter-spacing:.02em}
.block .inner{padding:18px 20px}
.muted{color:var(--muted)}
hr.sep{border:none;border-top:1px solid var(--border);margin:14px 0}
.grid{display:grid;gap:12px}
.row{display:grid;gap:10px}
@media(min-width:760px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
input,select,textarea{width:100%;background:#fff;color:var(--ink);border:1.5px solid var(--border);border-radius:14px;padding:12px 14px;outline:none;transition:border .2s ease, box-shadow .2s ease}
input:focus,select:focus,textarea:focus{border-color:#C9D0FF;box-shadow:0 0 0 4px rgba(58,73,255,.12)}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

/* Pub cards & tags */
.pub-card{border:1px solid var(--border);border-radius:16px;padding:14px;background:#fff;display:grid;gap:6px;box-shadow:0 6px 16px rgba(15,18,38,.04)}
.tag{font-size:11px;padding:4px 10px;border:1px solid #E0E5FF;border-radius:999px;background:#fff;color:#3A49FF;font-weight:700;letter-spacing:.02em}

/* Tabs (top) */
.tab{display:none}.tab.active{display:block}

/* Subtabs (Application) */
.app-sub{display:none}.app-sub.active{display:block}

/* Ergonomic analysis workspace */
.workspace{display:grid;gap:16px}
@media(min-width:1024px){.workspace{grid-template-columns:320px 1fr}}
.sidebar{border:1px solid var(--border);border-radius:16px;background:#fff;padding:12px;height:100%}
.sidebar h4{margin:6px 0 10px;color:#3A49FF}
.source-item{display:flex;gap:8px;align-items:flex-start;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px}
.source-item input{width:auto}
.mainpanel{display:grid;gap:12px}
.panel{border:1px solid var(--border);border-radius:16px;background:#fff;padding:16px}
.panel h3{margin:0 0 8px;color:#3A49FF}
pre.code{white-space:pre-wrap;background:#FBFCFF;border:1px solid var(--border);border-radius:12px;padding:12px}

/* Modal for literature results */
.modal{position:fixed;inset:0;background:rgba(5,8,20,.38);display:none;align-items:center;justify-content:center;z-index:70}
.modal.open{display:flex}
.modal-card{width:min(980px,92vw);max-height:86vh;overflow:auto;background:#fff;border-radius:18px;box-shadow:0 18px 44px rgba(15,18,38,.22);padding:18px}
.modal-card header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
</style>
</head>

<body>
<canvas id="particlesCanvas"></canvas>
<div id="xfade"></div>

<header>
  <div class="nav">
    <picture>
      <source srcset="./assets/montes-biopharma-logo.svg" type="image/svg+xml">
      <img src="./assets/montes-biopharma-logo.jpg" alt="Montes BioPharma" class="logo" width="160" height="40">
    </picture>
    <div class="brand" data-i="brand">Montes BioPharma</div>

    <div class="lang">
      <button id="menuBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false" aria-controls="menuDropdown" title="Menu">
        <span class="bars" aria-hidden="true"><span class="bar"></span></span>
        <span class="sr-only" style="position:absolute;left:-9999px" data-i="menu">Menu</span>
      </button>
      <div id="menuDropdown" role="menu" aria-labelledby="menuBtn">
        <div class="menu-item" data-tab="intro" role="menuitem"><span class="dot"></span><span data-i="navIntro">Introduction</span></div>
        <div class="menu-item" data-tab="app" role="menuitem"><span class="dot"></span><span data-i="navApp">Application</span></div>
        <div class="menu-item" data-tab="contact" role="menuitem"><span class="dot"></span><span data-i="navContact">Contact</span></div>
      </div>
      <button id="btnFR" class="icon-btn active">FR</button>
      <button id="btnEN" class="icon-btn">EN</button>
    </div>
  </div>
</header>

<!-- ===== Tab 1: INTRO ===== -->
<section id="tab-intro" class="tab active" aria-labelledby="navIntro">
  <section class="hero">
    <div class="kicker" data-i="kicker">ASSISTANT LITTÉRATURE</div>
    <h1 class="hero-title" data-i="heroTitle">No learning curve,<br/>no complications</h1>
    <p class="hero-sub" data-i="heroSub">
      <span data-i="introP1">Recherche d’articles (Europe PMC), upload de documents internes, analyse IA et création de protocoles documentaires (adénovirus).</span>
    </p>
    <div class="cta">
      <button class="btn primary" id="openMenuCta" data-i="ctaOpenMenu">Ouvrir le menu</button>
      <button class="btn ghost" id="openMenuLearn" data-i="ctaOpenLearn">Que puis-je faire ?</button>
    </div>
  </section>

  <section class="services">
    <div class="tiles">
      <div class="tile">
        <span class="badge" data-i="t1Badge">Upload</span>
        <h3 data-i="t1Title">Documents internes</h3>
        <p data-i="t1Text">PDF, DOCX, TXT — extraction locale, aucune donnée envoyée.</p>
      </div>
      <div class="tile">
        <span class="badge">Europe PMC</span>
        <h3 data-i="t2Title">Recherche d’articles</h3>
        <p data-i="t2Text">Fenêtre temporelle, mots-clés, open access. Liens PubMed.</p>
      </div>
      <div class="tile">
        <span class="badge">AI</span>
        <h3 data-i="t3Title">Synthèse des contenus</h3>
        <p data-i="t3Text">Résumé automatique (Hugging Face) des abstracts / texte intégral.</p>
      </div>
      <div class="tile">
        <span class="badge">PDF</span>
        <h3 data-i="t4Title">Export documentaire</h3>
        <p data-i="t4Text">Protocole documentaire structuré (sans paramètres expérimentaux).</p>
      </div>
    </div>
  </section>
</section>

<!-- ===== Tab 2: APPLICATION ===== -->
<section id="tab-app" class="tab" aria-labelledby="navApp">
  <div class="section">
    <!-- Subtab 1: DEMANDE -->
    <section id="app-step1" class="app-sub active">
      <div class="cards">
        <section class="block open">
          <header>
            <div>
              <div class="overline">ANALYSE DE LA DEMANDE</div>
              <h2>Votre besoin</h2>
            </div>
          </header>
          <div class="inner">
            <div class="grid">
              <!-- Q1 -->
              <div>
                <label><strong>Quelle biomolécule voulez-vous produire ?</strong></label>
                <select id="bioSelect">
                  <option value="" selected disabled>— Sélectionner —</option>
                  <option value="Adenovirus">Adénovirus</option>
                </select>
              </div>

              <!-- Q2 -->
              <div id="domainWrap" class="hide">
                <label><strong>Quel est le domaine du pharmaceutique que vous souhaitez explorer ?</strong></label>
                <select id="domainSelect">
                  <option value="" selected disabled>— Sélectionner —</option>
                  <option>Upstream</option>
                  <option>Downstream</option>
                  <option>Fill & Finish</option>
                  <option>Analytique</option>
                  <option>Assurance Qualité</option>
                  <option>CMC</option>
                </select>
              </div>

              <!-- Q3 (contextuel) -->
              <div id="detailWrap" class="hide">
                <label><strong id="detailTitle">Spécifiez votre besoin</strong></label>
                <div id="detailChoices" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))"></div>
              </div>

              <div id="confirmWrap" class="hide">
                <div class="panel" style="border:1px dashed var(--border)">
                  <p id="confirmText" class="muted"></p>
                </div>
                <div class="controls">
                  <button class="btn primary" id="goToDocs">Passer à la suite</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- Subtab 2: DOCUMENTS & LITTÉRATURE -->
    <section id="app-step2" class="app-sub">
      <div class="cards">
        <section class="block open">
          <header>
            <div>
              <div class="overline">DOCUMENTS & LITTÉRATURE</div>
              <h2>Sources</h2>
            </div>
          </header>
          <div class="inner">
            <!-- Question documents internes -->
            <div class="grid">
              <div>
                <label><strong>Avez-vous des documents internes sur lesquels je peux me baser pour concevoir la méthode ?</strong></label>
                <div class="controls">
                  <button class="btn secondary" id="btnDocYes">Oui</button>
                  <button class="btn secondary" id="btnDocNo">Non</button>
                </div>
              </div>
              <div id="uploaderWrap" class="hide">
                <div id="drop" class="drop" style="margin-top:6px">
                  <div>
                    <strong>Déposez vos fichiers ici</strong>
                    <div class="muted">ou cliquez pour sélectionner</div>
                    <small>Acceptés : PDF, DOCX, TXT</small>
                  </div>
                  <input id="fileInput" type="file" multiple accept=".pdf,.docx,.txt" style="display:none">
                </div>
                <div class="file-list" id="filesList"></div>
              </div>

              <!-- Question recherche littérature -->
              <div style="margin-top:10px">
                <label><strong>Souhaitez-vous une recherche dans la littérature selon votre domaine ?</strong></label>
                <div class="controls">
                  <button class="btn secondary" id="btnLitYes">Oui</button>
                  <button class="btn secondary" id="btnLitNo">Non</button>
                </div>
              </div>

              <div class="controls" style="margin-top:8px">
                <button class="btn primary" id="toWorkspace">Aller à l’analyse</button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Modal résultats Europe PMC -->
      <div id="litModal" class="modal" aria-hidden="true">
        <div class="modal-card">
          <header>
            <h3 style="margin:0">Résultats littérature</h3>
            <button class="icon-btn" id="closeLitModal">Fermer</button>
          </header>
          <div id="litResults"></div>
          <div class="controls" style="margin-top:10px">
            <button class="btn primary" id="runLitAnalysis">Lancer l’analyse du contenu</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Subtab 3: ANALYSE APPROFONDIE -->
    <section id="app-step3" class="app-sub">
      <div class="cards">
        <section class="block open">
          <header>
            <div>
              <div class="overline">ANALYSE APPROFONDIE</div>
              <h2>Espace d’analyse</h2>
            </div>
          </header>
          <div class="inner">
            <div class="workspace">
              <!-- Sidebar: sources -->
              <aside class="sidebar">
                <h4>Sources internes</h4>
                <div id="docList"></div>
                <h4 style="margin-top:12px">Articles sélectionnés</h4>
                <div id="artList"></div>
              </aside>

              <!-- Main panels -->
              <div class="mainpanel">
                <div class="panel">
                  <h3>Vue d’ensemble</h3>
                  <div id="overview"></div>
                </div>
                <div class="panel">
                  <h3>Sections méthodologiques extraites</h3>
                  <pre id="methodSections" class="code"></pre>
                </div>
                <div class="panel">
                  <h3>Résumé d’une page</h3>
                  <pre id="onePager" class="code"></pre>
                </div>
                <div class="panel">
                  <h3>Points clés & risques</h3>
                  <ul id="keyRisks" style="margin:0;padding-left:18px"></ul>
                </div>
                <div class="panel">
                  <h3>Traçabilité (citations)</h3>
                  <div id="trace" class="muted"></div>
                </div>
                <div class="controls">
                  <button class="btn primary" id="exportPdf">Exporter le PDF</button>
                </div>
              </div>
            </div> <!-- /workspace -->
          </div>
        </section>
      </div>
    </section>
  </div>
</section>

<!-- ===== Tab 3: CONTACT ===== -->
<section id="tab-contact" class="tab" aria-labelledby="navContact">
  <section class="section">
    <div class="cards">
      <section class="block open">
        <header>
          <div>
            <div class="overline">PRISE DE CONTACT</div>
            <h2>Discutons de votre projet</h2>
          </div>
        </header>
        <div class="inner">
          <p class="muted">Nos scientifiques experts peuvent vous aider à accélérer la mise au point de vos procédés (vecteurs adénoviraux, purification, analytique, documentation).</p>
          <div class="row row-2">
            <div><label>Nom</label><input id="c_name" placeholder="Jane Doe"></div>
            <div><label>Société</label><input id="c_org" placeholder="Montes BioPharma"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div><label>Email</label><input id="c_email" placeholder="you@company.com" type="email"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div><label>Message</label><textarea id="c_msg" rows="4" placeholder="Parlez-nous de votre projet…"></textarea></div>
          </div>
          <div class="controls">
            <a id="c_mailto" class="btn primary" href="#">Envoyer par e-mail</a>
            <a class="btn secondary" href="https://www.linkedin.com" target="_blank" rel="noopener">LinkedIn</a>
          </div>
        </div>
      </section>
    </div>
  </section>
</section>

<footer style="background:#fff;border-top:1px solid var(--border);margin-top:36px">
  <div class="section" style="padding-top:20px;padding-bottom:28px">
    <div style="display:flex;justify-content:space-between;gap:10px;color:var(--muted)">
      <div>© <span id="year"></span> Montes BioPharma</div>
      <div>Europe PMC / PubMed — Hugging Face (optionnel). Aucune instruction expérimentale.</div>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script>
/* ========= Particles ========= */
const cv=document.getElementById('particlesCanvas'),cx=cv.getContext('2d');let W,H,PTS=[];
function size(){W=cv.width=innerWidth;H=cv.height=innerHeight} size(); addEventListener('resize',size);
function R(a,b){return a+Math.random()*(b-a)}
function spawn(){return{x:R(0,W),y:R(0,H),vx:R(-.05,.05),vy:-R(.02,.07),r:R(1.2,3.0),t:R(0,6.28),tw:R(.8,1.3)}}
PTS=Array.from({length:Math.min(280,Math.round((W*H)/14000))},spawn);
(function loop(){requestAnimationFrame(loop);cx.clearRect(0,0,W,H);
for(const p of PTS){p.t+=.016;const a=.15+.45*Math.abs(Math.sin(p.t))*p.tw;p.x+=p.vx+Math.sin(p.t*.35)*.03;p.y+=p.vy;
if(p.x<-6)p.x=W+6;if(p.x>W+6)p.x=-6;if(p.y<-6){p.y=H+6;p.x=Math.random()*W;}
const mix=Math.abs(Math.sin(p.t*.5));const r=Math.round(20+38*mix), g=Math.round(150+100*(1-mix)), b=Math.round(255-40*(1-mix));
cx.beginPath();cx.arc(p.x,p.y,p.r,0,6.283);cx.fillStyle=`rgba(${r},${g},${b},${a})`;cx.fill();}})();

/* ========= Top menu & gradient transition ========= */
const menuBtn=document.getElementById('menuBtn'); const menuDD=document.getElementById('menuDropdown'); const xfade=document.getElementById('xfade');
function openMenu(){menuDD.classList.add('open');menuBtn.setAttribute('aria-expanded','true');}
function closeMenu(){menuDD.classList.remove('open');menuBtn.setAttribute('aria-expanded','false');}
menuBtn.addEventListener('click',(e)=>{e.stopPropagation();menuDD.classList.toggle('open');menuBtn.setAttribute('aria-expanded',menuDD.classList.contains('open'));});
document.addEventListener('click',(e)=>{ if(!menuDD.contains(e.target) && e.target!==menuBtn) closeMenu();});
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeMenu();});

const tabs={intro:document.getElementById('tab-intro'),app:document.getElementById('tab-app'),contact:document.getElementById('tab-contact')};
function showTab(name){
  xfade.classList.add('show');
  setTimeout(()=>{
    Object.values(tabs).forEach(t=>t.classList.remove('active'));
    (tabs[name]||tabs.intro).classList.add('active');
    closeMenu();
    window.scrollTo({top:0,behavior:'instant'});
    setTimeout(()=>xfade.classList.remove('show'), 260);
  },160);
}
menuDD.querySelectorAll('.menu-item').forEach(it=>it.addEventListener('click',()=>showTab(it.dataset.tab)));
document.getElementById('openMenuCta').onclick=openMenu; document.getElementById('openMenuLearn').onclick=openMenu;

/* ========= Subtabs (Application) with gradient ========= */
const appSubs={ step1:document.getElementById('app-step1'), step2:document.getElementById('app-step2'), step3:document.getElementById('app-step3') };
function showAppSub(key){
  xfade.classList.add('show');
  setTimeout(()=>{
    Object.values(appSubs).forEach(s=>s.classList.remove('active'));
    (appSubs[key]||appSubs.step1).classList.add('active');
    window.scrollTo({top:0,behavior:'instant'});
    setTimeout(()=>xfade.classList.remove('show'),260);
  },160);
}

/* ========= i18n minimal (FR/EN placeholders conservés) ========= */
const I={ fr:{brand:"Montes BioPharma",menu:"Menu",navIntro:"Introduction",navApp:"Application",navContact:"Contact",
kicker:"ASSISTANT LITTÉRATURE",heroTitle:"No learning curve,<br/>no complications",
heroSub:"Recherche d’articles (Europe PMC), upload de documents internes, analyse IA et création de protocoles documentaires (adénovirus).",
introP1:"Recherche d’articles (Europe PMC), upload de documents internes, analyse IA et création de protocoles documentaires (adénovirus).",
ctaOpenMenu:"Ouvrir le menu",ctaOpenLearn:"Que puis-je faire ?"},
en:{brand:"Montes BioPharma",menu:"Menu",navIntro:"Introduction",navApp:"Application",navContact:"Contact",
kicker:"LITERATURE ASSISTANT",heroTitle:"No learning curve,<br/>no complications",
heroSub:"Article search (Europe PMC), internal document upload, AI analysis and documentary protocol creation (adenovirus).",
introP1:"Article search (Europe PMC), internal document upload, AI analysis and documentary protocol creation (adenovirus).",
ctaOpenMenu:"Open menu",ctaOpenLearn:"What can I do?"}};
function lang(){return document.documentElement.dataset.lang||'fr';}
function t(k){const L=I[lang()]||I.fr;return (L&&L[k])||(I.fr[k]||k);}
function setLang(newLang){
  document.documentElement.setAttribute('lang', newLang); document.documentElement.dataset.lang=newLang;
  for(const el of document.querySelectorAll('[data-i]')){const v=t(el.dataset.i); if(/<br\s*\/?>/.test(v)) el.innerHTML=v; else el.textContent=v;}
  document.getElementById('year').textContent=new Date().getFullYear();
}
window.addEventListener('DOMContentLoaded',()=>{
  const btnFR=document.getElementById('btnFR'),btnEN=document.getElementById('btnEN');
  btnFR.onclick=()=>{setLang('fr');btnFR.classList.add('active');btnEN.classList.remove('active');};
  btnEN.onclick=()=>{setLang('en');btnEN.classList.add('active');btnFR.classList.remove('active');};
  setLang('fr'); document.getElementById('year').textContent=new Date().getFullYear();
});

/* ========= State ========= */
const state={
  request:{ biomolecule:null, domain:null, details:[] },
  uploads:[],
  literature:{ results:[], selected:[], citations:[] },
  analysis:{ methodSections:"", onePager:"", overview:"", keyRisks:[] }
};

/* ========= DEMANDE (step1) logique ========= */
const bioSelect=document.getElementById('bioSelect');
const domainWrap=document.getElementById('domainWrap');
const domainSelect=document.getElementById('domainSelect');
const detailWrap=document.getElementById('detailWrap');
const detailTitle=document.getElementById('detailTitle');
const detailChoices=document.getElementById('detailChoices');
const confirmWrap=document.getElementById('confirmWrap');
const confirmText=document.getElementById('confirmText');
const goToDocs=document.getElementById('goToDocs');

bioSelect.addEventListener('change',()=>{
  state.request.biomolecule = bioSelect.value || null;
  domainWrap.classList.remove('hide');
  detailWrap.classList.add('hide'); confirmWrap.classList.add('hide');
});
domainSelect.addEventListener('change',()=>{
  state.request.domain = domainSelect.value || null;
  buildDetailChoices(state.request.domain);
  detailWrap.classList.remove('hide'); confirmWrap.classList.add('hide');
});
function buildDetailChoices(domain){
  const MAP={
    "Downstream":[
      "Clarification",
      "Concentration and Diafiltration",
      "Capture by chromatography",
      "Polishing",
      "Formulation",
      "Final Filtration"
    ],
    "Upstream":["Cell line & seed train","Production bioreactor","Harvest strategy"],
    "Fill & Finish":["Filling strategy","Container/closure","Visual inspection"],
    "Analytique":["Identity & potency","Impurities & residuals","Stability plan"],
    "Assurance Qualité":["Change control","Deviation/CAPA","GxP documentation"],
    "CMC":["Regulatory strategy","Comparability","Control strategy"]
  };
  const arr = MAP[domain]||[];
  detailTitle.textContent = (domain==="Downstream") ? "Spécifiez le sous-domaine Downstream" : "Spécifiez votre besoin";
  detailChoices.innerHTML='';
  arr.forEach(lbl=>{
    const id='det_'+lbl.replace(/\W+/g,'_');
    const w=document.createElement('label'); w.className='source-item';
    w.innerHTML=`<input type="checkbox" id="${id}" value="${lbl}" style="width:auto"><span>${lbl}</span>`;
    detailChoices.appendChild(w);
    w.querySelector('input').addEventListener('change',()=>{
      const checks=[...detailChoices.querySelectorAll('input:checked')].map(i=>i.value);
      state.request.details = checks;
      confirmWrap.classList.toggle('hide', checks.length===0);
      if(checks.length){
        confirmText.textContent = `Parfait. Vous avez choisi : biomolécule = ${state.request.biomolecule}; domaine = ${state.request.domain}; sous-domaines = ${checks.join(', ')}. Je garde ces choix en mémoire et nous allons passer à la seconde partie du processus.`;
      }
    });
  });
}
goToDocs.addEventListener('click',()=>{ showAppSub('step2'); });

/* ========= DOCUMENTS & LITTÉRATURE (step2) ========= */
const btnDocYes=document.getElementById('btnDocYes'), btnDocNo=document.getElementById('btnDocNo');
const uploaderWrap=document.getElementById('uploaderWrap'); const drop=document.getElementById('drop'); const input=document.getElementById('fileInput'); const filesList=document.getElementById('filesList');
btnDocYes.onclick=()=>{uploaderWrap.classList.remove('hide');};
btnDocNo.onclick=()=>{uploaderWrap.classList.add('hide');state.uploads=[];filesList.innerHTML='';};

drop.addEventListener('click',(e)=>{e.preventDefault();input.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true}));});
drop.addEventListener('dragover',(e)=>{e.preventDefault();drop.classList.add('drag');});
drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
drop.addEventListener('drop',(e)=>{e.preventDefault();drop.classList.remove('drag');handleFiles(e.dataTransfer.files);});
input.addEventListener('change',(e)=>handleFiles(e.target.files));

function handleFiles(files){
  state.uploads=[...files];
  filesList.innerHTML='';
  state.uploads.forEach(f=>{
    const it=document.createElement('div'); it.className='file-item';
    it.textContent=`${f.name} — ${(f.size/1024/1024).toFixed(2)} MB`;
    filesList.appendChild(it);
  });
}

/* === Littérature === */
const btnLitYes=document.getElementById('btnLitYes'), btnLitNo=document.getElementById('btnLitNo');
const litModal=document.getElementById('litModal'), closeLitModal=document.getElementById('closeLitModal'), litResults=document.getElementById('litResults');
btnLitYes.onclick=()=>{ openLitModalAndSearch(); };
btnLitNo.onclick=()=>{ /* rien, on passe à l’analyse si souhaité */ };
closeLitModal.onclick=()=>{ litModal.classList.remove('open'); };

function domainQuery(){
  const d=state.request.domain||'Downstream';
  const bm=(state.request.biomolecule||'Adenovirus');
  const m = {
    "Downstream": `${bm} purification chromatography OR TFF OR diafiltration OR polishing OR formulation`,
    "Upstream": `${bm} production bioreactor HEK293`,
    "Fill & Finish": `${bm} fill finish aseptic filtration`,
    "Analytique": `${bm} analytics potency identity impurities qPCR ELISA`,
    "Assurance Qualité": `${bm} quality systems GxP documentation`,
    "CMC": `${bm} CMC regulatory comparability control strategy`
  };
  return m[d]||`${bm} purification`;
}
async function openLitModalAndSearch(){
  litModal.classList.add('open');
  litResults.innerHTML='<div class="muted">Recherche…</div>';
  const q = domainQuery();
  const url = `https://api.allorigins.win/get?url=${encodeURIComponent('https://www.ebi.ac.uk/europepmc/webservices/rest/search?query='+encodeURIComponent(q)+'&pageSize=10&format=json&sort_date:y')}`;
  try{
    const r=await fetch(url); const raw=await r.json(); const j=JSON.parse(raw.contents);
    const res=(j.resultList?.result)||[];
    state.literature.results = res.map(x=>({
      pmid:x.pmid||'', pmcid:x.pmcid||'', title:x.title||'', journal:x.journalTitle||x.source||'', year:x.pubYear||'',
      authors:(x.authorString||'').split(', ').slice(0,6), oa:(x.isOpenAccess==="Y"||x.openAccess=="Y"||x.openAccess)
    }));
    renderLitResults();
  }catch(e){ litResults.innerHTML='<div class="muted">Erreur Europe PMC</div>'; }
}
function renderLitResults(){
  litResults.innerHTML='';
  state.literature.results.forEach((a,idx)=>{
    const link = a.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/` : (a.pmcid?`https://europepmc.org/article/PMC/${a.pmcid}`:'#');
    const el=document.createElement('div'); el.className='pub-card';
    el.innerHTML=`
      <label style="display:flex;gap:10px;align-items:flex-start">
        <input type="checkbox" data-i="${idx}" style="width:auto;margin-top:4px">
        <div>
          <div><strong>${esc(a.title)}</strong> ${a.oa?'<span class="tag">Open Access</span>':''}</div>
          <div class="muted">${esc(a.journal)} · ${esc(a.year||'—')}</div>
          <div class="muted">${esc(a.authors.join(', '))}</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <a class="tag" href="${link}" target="_blank" rel="noopener">Ouvrir</a>
          </div>
        </div>
      </label>`;
    const cb=el.querySelector('input'); cb.addEventListener('change',e=>{
      const i=+e.target.dataset.i;
      state.literature.results[i].selected = e.target.checked;
    });
    litResults.appendChild(el);
  });
}

const runLitAnalysis=document.getElementById('runLitAnalysis');
runLitAnalysis.onclick = async ()=>{
  // Construire liste sélectionnée
  const chosen = state.literature.results.filter(x=>x.selected);
  if(!chosen.length){ alert('Sélectionnez au moins un article.'); return; }

  // Résumés (~10 lignes) via HF si dispo, sinon fallback simple
  const HF_TOKEN = "hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; // remplace si dispo
  const HF_MODEL = "facebook/bart-large-cnn";
  async function summarize(text){
    if(!HF_TOKEN.startsWith('hf_')) return (text||'').slice(0,1200);
    try{
      const r=await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`,{
        method:'POST',headers:{Authorization:`Bearer ${HF_TOKEN}`,'Content-Type':'application/json'},
        body:JSON.stringify({inputs:text})
      });
      const j=await r.json();
      return Array.isArray(j)&&j[0]?.summary_text ? j[0].summary_text : (text||'').slice(0,1200);
    }catch(_){return (text||'').slice(0,1200);}
  }

  const out=[];
  for(const a of chosen){
    let abs='';
    try{
      if(a.pmid){
        abs = await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/MED/${a.pmid}/abstractText?format=plain`).then(r=>r.text());
      }else if(a.pmcid){
        abs = await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/PMC/${a.pmcid}/abstractText?format=plain`).then(r=>r.text());
      }
    }catch(_){}
    const s = await summarize(abs);
    out.push({meta:a, summary:s});
  }

  // Alimente l’espace d’analyse (step3)
  state.literature.selected = out;
  litModal.classList.remove('open');
  buildWorkspace();
  showAppSub('step3');
};

document.getElementById('toWorkspace').onclick = ()=>{ buildWorkspace(); showAppSub('step3'); };

/* ========= Workspace (step3) ========= */
function buildWorkspace(){
  // Sidebar sources internes
  const docList=document.getElementById('docList'); docList.innerHTML='';
  state.uploads.forEach(f=>{
    const it=document.createElement('div'); it.className='source-item';
    it.innerHTML=`<input type="checkbox" checked style="width:auto"><span>${esc(f.name||'Document')}</span>`;
    docList.appendChild(it);
  });

  // Sidebar articles
  const artList=document.getElementById('artList'); artList.innerHTML='';
  (state.literature.selected||[]).forEach((a,i)=>{
    const it=document.createElement('div'); it.className='source-item';
    it.innerHTML=`<input type="checkbox" checked data-i="${i}" style="width:auto"><span>${esc(a.meta.title||'Article')}</span>`;
    artList.appendChild(it);
  });

  // Overview
  const ov=document.getElementById('overview');
  const d=state.request;
  ov.innerHTML = `
    <div class="pub-card">
      <div><strong>Contexte</strong></div>
      <div class="muted">Biomolécule : ${esc(d.biomolecule||'-')} · Domaine : ${esc(d.domain||'-')} · Détails : ${esc((d.details||[]).join(', ')||'-')}</div>
    </div>
  `;

  // Méthodologie + 1-pager depuis uploads + articles (rapide)
  deepAnalyze();
}

/* ========= Extraction locale & IA ========= */
const REDACT=/\b\d+(?:[\.,]\d+)?\s?(?:mL|ml|L|µL|uL|°C|C|rpm|g|xg|min|h|hours?|days?|M|mM|µM|uM|%|nm|mm|cm|kDa)\b/gi;
function sanitize(txt){return (txt||"").replace(REDACT,"[…]");}

async function deepAnalyze(){
  // 1) Récupération texte des documents internes
  const texts=[];
  for(const f of state.uploads){
    const buf=await f.arrayBuffer(); const ext=f.name.toLowerCase().split('.').pop();
    let t=''; if(ext==='pdf'){
      const pdfjsLib=window['pdfjsLib']; pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const pdf=await pdfjsLib.getDocument({data:buf}).promise; for(let i=1;i<=pdf.numPages;i++){ const page=await pdf.getPage(i); const c=await page.getTextContent(); t+=c.items.map(it=>it.str).join(' ')+' '; }
    }else if(ext==='docx'){ const res=await window.mammoth.extractRawText({arrayBuffer:buf}); t=res.value||''; }
    else if(ext==='txt'){ t=new TextDecoder().decode(new Uint8Array(buf)); }
    texts.push(t);
  }
  const full = texts.join('\n\n');

  // 2) Extraction “méthodo” heuristique
  const terms = /(materials?|méthod|methods?|buffer|tampon|chromatograph|affinity|anion|cation|membrane|TFF|diafiltration|polish|formulation|filtration|QC|quality|analytics?)/i;
  const sentences = (full||'').split(/(?<=[\.\!\?])\s+/).filter(s=>terms.test(s)).slice(0,120);
  const extracted = sanitize(sentences.join('\n'));

  // 3) Résumé 1 page (HF si dispo)
  const HF_TOKEN = "hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; const HF_MODEL="facebook/bart-large-cnn";
  async function summarize(t){ if(!HF_TOKEN.startsWith('hf_')) return (t||'').slice(0,1400);
    try{const r=await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`,{method:'POST',headers:{Authorization:`Bearer ${HF_TOKEN}`,'Content-Type':'application/json'},body:JSON.stringify({inputs:(t||'').slice(0,7000)})});const j=await r.json();return Array.isArray(j)&&j[0]?.summary_text?j[0].summary_text:(t||'').slice(0,1400);}catch(_){return (t||'').slice(0,1400);} }

  const onepager = await summarize(full);

  // 4) Points clés & risques (simple heuristique)
  const bullets = [];
  if(/chromatograph|affinity|AEX|CEX/i.test(full)) bullets.push("Chromatographie : vérifier la robustesse des étapes de capture/polishing (sélectivité, élution, charge).");
  if(/TFF|diafiltration/i.test(full)) bullets.push("TFF/Diafiltration : contrôler le cisaillement et les volumes de DF (paramètres volontairement absents).");
  if(/formulation/i.test(full)) bullets.push("Formulation : stabilité (pH, excipients) et compatibilité contenant/fermeture.");
  if(/QC|quality|stability|release/i.test(full)) bullets.push("Qualité/Analytique : plan de stabilité & critères libératoires documentaires.");
  if(!bullets.length) bullets.push("Vérifier la traçabilité documentaire et la cohérence des sections méthodologiques.");
  bullets.splice(6);

  // 5) Traçabilité (articles sélectionnés)
  const trace = (state.literature.selected||[]).map((a,i)=>`[${i+1}] ${a.meta.title} (${a.meta.year}) — ${a.meta.journal}`).join('<br>');

  // 6) Rendu UI
  document.getElementById('methodSections').textContent = extracted || '(aucune section détectée)';
  document.getElementById('onePager').textContent = sanitize(onepager||'');
  const ul=document.getElementById('keyRisks'); ul.innerHTML=''; bullets.forEach(b=>{const li=document.createElement('li'); li.textContent=b; ul.appendChild(li);});
  document.getElementById('trace').innerHTML = trace || '<span class="muted">(aucune)</span>';
}

/* ========= Export PDF (workspace) ========= */
document.getElementById('exportPdf').onclick = async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt',format:'a4'});
  const M=56, W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();
  pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F');
  try{ const r=await fetch('./assets/montes-biopharma-logo.jpg'); const b=await r.blob(); const data=await blobToDataURL(b); pdf.addImage(data,'JPEG',M,M-8,160,40,'','FAST'); }catch(e){}
  setText(pdf,'#3A49FF',18,'bold'); pdf.text('Documentary protocol — Adenovirus', M+180, M+14);
  pdf.setDrawColor(58,73,255); pdf.setLineWidth(2); pdf.line(M, M+50, W-M, M+50);
  let y=M+74;
  y = putHeading(pdf,'Overview',y,13,'#3A49FF',M,W,H);
  const d=state.request; y=putParagraph(pdf,`Biomolecule: ${d.biomolecule||'-'} · Domain: ${d.domain||'-'} · Details: ${(d.details||[]).join(', ')||'-'}`,y,M,W,H,11);
  y = putHeading(pdf,'Extracted methodological sections',y,13,'#3A49FF',M,W,H);
  y = putParagraph(pdf,(document.getElementById('methodSections').textContent||''),y,M,W,H,11);
  y = putHeading(pdf,'One-page summary',y,13,'#3A49FF',M,W,H);
  y = putParagraph(pdf,(document.getElementById('onePager').textContent||''),y,M,W,H,11);
  y = putHeading(pdf,'Key points & risks',y,13,'#3A49FF',M,W,H);
  const bullets=[...document.querySelectorAll('#keyRisks li')].map(li=>li.textContent);
  for(const b of bullets){ y=putParagraph(pdf,'• '+b,y,M,W,H,11); }
  y = putHeading(pdf,'Traceability',y,13,'#3A49FF',M,W,H);
  const refs = (state.literature.selected||[]).map((a,i)=>`[${i+1}] ${a.meta.title} (${a.meta.year}) — ${a.meta.journal}`).join('\n');
  y = putParagraph(pdf,refs||'(none)',y,M,W,H,11);
  pdf.save('documentary-protocol.pdf');
};
function setText(pdf,hex,size,weight){const [r,g,b]=hexToRGB(hex); pdf.setTextColor(r,g,b); pdf.setFont('helvetica', weight==='bold'?'bold':'normal'); pdf.setFontSize(size);}
function putHeading(pdf,text,y,size,color,M,W,H){ if(y + size + 18 > H - M){ pdf.addPage(); y=M; } const [r,g,b]=hexToRGB(color); pdf.setTextColor(r,g,b); pdf.setFont('helvetica','bold'); pdf.setFontSize(size); pdf.text(text,M,y); pdf.setDrawColor(210,210,210); pdf.setLineWidth(.6); pdf.line(M,y+6,W-M,y+6); return y+18;}
function putParagraph(pdf,text,y,M,W,H,size=11){ pdf.setTextColor(0,0,0); pdf.setFont('helvetica','normal'); pdf.setFontSize(size); const chunks=pdf.splitTextToSize(text,W-2*M); for(const ln of chunks){ if(y>H-M){ pdf.addPage(); y=M; } pdf.text(ln,M,y); y+=14; } return y+4;}
function hexToRGB(hex){const h=hex.replace('#','');const n=parseInt(h,16);return [(n>>16)&255,(n>>8)&255,n&255];}
function blobToDataURL(blob){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(blob);});}

/* ========= Utils ========= */
function esc(s){return (s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}
document.getElementById('year').textContent=new Date().getFullYear();
</script>
</body>
</html>
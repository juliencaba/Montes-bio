<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Montes BioPharma — Assistant (ossature sûre)</title>
  <meta name="color-scheme" content="dark"/>

  <style>
    :root{
      --bg:#0a1020;
      --panel:#0f1830;
      --card:#0f1a2d;
      --border:rgba(255,255,255,.08);
      --text:#e8f1ff;
      --muted:#9fb0c8;

      /* Couleurs de marque (logo) */
      --accentG:#7CF45B; /* vert fluo */
      --accentB:#2456FF; /* bleu */

      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --glowG:0 0 22px rgba(124,244,91,.55);
      --glowB:0 0 22px rgba(36,86,255,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(36,86,255,.18), transparent 60%),
        radial-gradient(900px 700px at -10% 120%, rgba(124,244,91,.12), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }

    /* Canvas particules : sous la UI, au-dessus du fond */
    #particlesCanvas{
      position:fixed; inset:0; z-index:0; pointer-events:none;
    }

    header{
      position:sticky; top:0; z-index:3; backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(90deg, rgba(124,244,91,.08), rgba(36,86,255,.12));
      border-bottom:1px solid var(--border);
    }
    .nav{ max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; gap:14px; }
    .logo{ height:38px; width:auto; object-fit:contain; display:block; }
    .brand{ font-weight:700; letter-spacing:.3px }

    .container{ max-width:1100px; margin:28px auto; padding:0 16px; position:relative; z-index:2 }
    .hero{ display:flex; align-items:center; gap:12px; margin:18px 0 10px }
    .hero h1{
      margin:0; font-size: clamp(22px, 4vw, 36px);
      background:linear-gradient(90deg, var(--accentG), var(--accentB));
      -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow: var(--glowG), var(--glowB);
    }

    .card{ background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 30%), var(--card);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow) }
    .panel{ padding:18px }
    .grid{ display:grid; gap:16px }

    /* Barre de progression + étapes rondes lumineuses */
    .progress-wrap{ margin:14px 0 18px }
    .progress{
      height:10px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; position:relative;
    }
    .progress > span{ display:block; height:100%; width:0%;
      background:linear-gradient(90deg, var(--accentG), var(--accentB)); transition:width .45s cubic-bezier(.2,.7,.2,1) }

    .steps{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    .chip{
      --size:36px;
      width:var(--size); height:var(--size); border-radius:50%;
      display:inline-grid; place-items:center; color:var(--muted);
      border:1px solid var(--border); background:#0a1426;
      font-weight:700; font-size:14px; position:relative; isolation:isolate;
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease, color .2s ease;
    }
    .chip::after{ /* petit glow discret */
      content:""; position:absolute; inset:-2px; border-radius:inherit; z-index:-1;
      background: radial-gradient(60% 60% at 50% 40%, rgba(124,244,91,.18), transparent 60%),
                  radial-gradient(60% 60% at 50% 60%, rgba(36,86,255,.18), transparent 60%);
      opacity:.0; transition:opacity .2s ease;
    }
    .chip.active{
      color:#02121f; border-color:transparent;
      background:linear-gradient(135deg, var(--accentG), var(--accentB));
      box-shadow: var(--glowG), var(--glowB);
      transform: translateY(-1px);
    }
    .chip.active::after{ opacity:1 }

    .step{ display:none }
    .step.active{ display:block }

    label{ display:block; font-size:14px; margin-bottom:6px; color:var(--muted) }
    input, select, textarea{
      width:100%; background:#0a1424; color:var(--text); border:1px solid var(--border);
      border-radius:10px; padding:10px 12px; outline:none; transition:border .2s ease;
    }
    input:focus, select:focus, textarea:focus{ border-color:var(--accentG) }
    .row{ display:grid; gap:12px }
    @media(min-width:760px){ .row-2{ grid-template-columns:1fr 1fr } .row-3{ grid-template-columns:1fr 1fr 1fr } }

    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700; padding:12px 16px; border-radius:12px;
      background:linear-gradient(90deg, var(--accentG), var(--accentB)); color:#02121f;
      box-shadow:0 8px 24px rgba(36,86,255,.18), 0 8px 24px rgba(124,244,91,.18);
      transition: transform .06s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .btn:active{ transform: translateY(1px) }
    .btn.secondary{ background:#0b1628; color:var(--text); border:1px solid var(--border) }
    .btn.ghost{ background:transparent; color:var(--text); border:1px dashed var(--border) }

    .pub-card{
      border:1px solid var(--border); border-radius:12px; padding:12px; background:#0c1629;
      display:grid; gap:8px;
    }
    .pub-actions{ display:flex; gap:8px; flex-wrap:wrap }
    .tag{ font-size:11px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted) }
    .score{ font-weight:700; color:var(--accentG) }
    .muted{ color:var(--muted) }

    .footer{ text-align:center; color:var(--muted); font-size:12px; padding:18px 0 40px }
    a{ color:var(--accentG); text-decoration:none }
    a:hover{ text-decoration:underline }
  </style>
</head>

<body>
  <!-- Canvas des particules en suspension -->
  <canvas id="particlesCanvas"></canvas>

  <header>
    <div class="nav">
      <!-- Logo séparé (SVG transparent) -->
      <img class="logo" src="" alt="Montes BioPharma" id="navLogo" />
      <div class="brand">Montes BioPharma</div>
      <div style="margin-left:auto" class="muted">Assistant IA (ossature sûre)</div>
    </div>
  </header>

  <main class="container">
    <div class="hero">
      <img class="logo" src="" alt="Montes BioPharma" id="heroLogo"/>
      <h1>Assistant d’aide à la documentation &amp; bibliographie</h1>
    </div>

    <!-- Progress + étapes -->
    <div class="progress-wrap card panel">
      <div class="progress"><span id="progressBar"></span></div>
      <div class="steps" id="stepsChips"></div>
    </div>

    <!-- Wizard -->
    <section class="card panel">
      <div id="step-1" class="step active" data-title="1">
        <h2>Étape 1 — Contexte & conformité</h2>
        <p class="muted">Usage strictement professionnel. Cette application ne fournit <strong>aucune procédure pratique</strong> ni paramètres expérimentaux. Elle génère une <em>ossature</em> de document à compléter par vos SOP internes validées.</p>
        <div class="grid">
          <div class="row row-2">
            <div>
              <label>Organisation / Société</label>
              <input id="org" placeholder="ex: Thermo Fisher Scientific" />
            </div>
            <div>
              <label>Rôle</label>
              <input id="role" placeholder="ex: GMP Operations Manager" />
            </div>
          </div>
          <div>
            <label>Déclaration</label>
            <label style="display:flex; gap:8px; align-items:flex-start">
              <input type="checkbox" id="complianceChk" style="width:auto; margin-top:4px"/>
              <span>Je confirme que je suis un professionnel au sein d’une organisation habilitée et que j’utiliserai uniquement des <strong>SOP internes approuvées</strong>. Pas d’usage domestique.</span>
            </label>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:14px">
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <div id="step-2" class="step" data-title="2">
        <h2>Étape 2 — Paramètres biologiques (métadonnées)</h2>
        <div class="row row-3">
          <div>
            <label>Type de vecteur</label>
            <select id="vectorType">
              <option value="">— Sélectionner —</option>
              <option>Adénovirus</option>
              <option disabled>Autres (désactivés)</option>
            </select>
          </div>
          <div>
            <label>Sérotype</label>
            <input id="serotype" placeholder="ex: Ad5"/>
          </div>
          <div>
            <label>Lignée cellulaire</label>
            <input id="cellLine" placeholder="ex: HEK293 / PER.C6"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Mots-clés supplémentaires (pour la recherche biblio)</label>
            <input id="keywords" placeholder="ex: chromatography, TFF, affinity, anion exchange"/>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:14px">
          <button class="btn secondary" data-prev>Retour</button>
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <div id="step-3" class="step" data-title="3">
        <h2>Étape 3 — Choix des grandes étapes</h2>
        <div class="row row-2">
          <div class="card panel">
            <label><input type="checkbox" id="upstream" style="width:auto; margin-right:8px">Upstream (métadonnées uniquement)</label>
            <div class="muted">Décrire les objectifs, points de contrôle qualité, références internes (SOP-UP-###). <em>Sans paramètres opératoires.</em></div>
          </div>
          <div class="card panel">
            <label><input type="checkbox" id="downstream" style="width:auto; margin-right:8px">Downstream (métadonnées uniquement)</label>
            <div class="muted">Structure documentaire aval : catégories et documents mères (SOP-DS-###). <em>Sans volumes ni vitesses.</em></div>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:14px">
          <button class="btn secondary" data-prev>Retour</button>
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <div id="step-4" class="step" data-title="4">
        <h2>Étape 4 — Sous-étapes (catégories)</h2>
        <div class="grid">
          <div class="card panel">
            <h3>Upstream — catégories</h3>
            <div class="row row-3">
              <label><input type="checkbox" class="up-cat" value="Conception & contrôles d’entrée (métadonnées)"/> Conception & contrôles d’entrée (métadonnées)</label>
              <label><input type="checkbox" class="up-cat" value="Qualité des matières (métadonnées)"/> Qualité des matières (métadonnées)</label>
              <label><input type="checkbox" class="up-cat" value="Contrôles en cours & libération (métadonnées)"/> Contrôles en cours & libération (métadonnées)</label>
            </div>
          </div>
          <div class="card panel">
            <h3>Downstream — catégories</h3>
            <div class="row row-3">
              <label><input type="checkbox" class="ds-cat" value="Clarification (métadonnées)"/> Clarification (métadonnées)</label>
              <label><input type="checkbox" class="ds-cat" value="Capture (métadonnées)"/> Capture (métadonnées)</label>
              <label><input type="checkbox" class="ds-cat" value="Polishing (métadonnées)"/> Polishing (métadonnées)</label>
              <label><input type="checkbox" class="ds-cat" value="Concentration & échange de tampon (métadonnées)"/> Concentration & échange de tampon (métadonnées)</label>
              <label><input type="checkbox" class="ds-cat" value="Contrôles qualité & attributs critiques (métadonnées)"/> Contrôles qualité & attributs critiques (métadonnées)</label>
              <label><input type="checkbox" class="ds-cat" value="Conditionnement documentaire (métadonnées)"/> Conditionnement documentaire (métadonnées)</label>
            </div>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:14px">
          <button class="btn secondary" data-prev>Retour</button>
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <div id="step-5" class="step" data-title="5">
        <h2>Étape 5 — Recherche PubMed</h2>
        <div class="grid" style="grid-template-columns:1fr 1.2fr; gap:16px">
          <div class="card panel">
            <div class="row">
              <div>
                <label>Activer la recherche d’articles récents</label>
                <label style="display:flex; gap:8px; align-items:center">
                  <input type="checkbox" id="enablePubMed" style="width:auto"> <span>Oui</span>
                </label>
              </div>
              <div class="row row-2">
                <div>
                  <label>Fenêtre (années récentes)</label>
                  <select id="yearsWindow">
                    <option value="1">1 an</option>
                    <option value="2" selected>2 ans</option>
                    <option value="5">5 ans</option>
                    <option value="10">10 ans</option>
                  </select>
                </div>
                <div>
                  <label>Nombre max. d’articles</label>
                  <select id="retMax">
                    <option>10</option><option selected>20</option><option>50</option>
                  </select>
                </div>
              </div>
              <div>
                <button id="runSearch" class="btn">Lancer la recherche</button>
              </div>
              <p class="muted">La recherche combine vos métadonnées et mots-clés pour scorer la pertinence. <strong>Seules des informations bibliographiques</strong> sont affichées (titres, auteurs, journaux, liens). Pas d’extraction de procédures.</p>
            </div>
          </div>
          <div id="pubResults" class="grid"></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:14px">
          <button class="btn secondary" data-prev>Retour</button>
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <div id="step-6" class="step" data-title="6">
        <h2>Étape 6 — Ossature du protocole <span class="muted">(à compléter par vos SOP)</span></h2>
        <div class="card panel">
          <div class="row row-2">
            <div>
              <label>Titre du document</label>
              <input id="docTitle" placeholder="Ossature protocole – Adénovirus (exemple)"/>
            </div>
            <div>
              <label>Identifiants internes (SOP, version, référence)</label>
              <input id="internalRefs" placeholder="ex: SOP-DS-001 v1.2 ; SOP-UP-003 v3.0"/>
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <div>
              <label>Résumé / But (sans paramètres expérimentaux)</label>
              <textarea id="summary" rows="4" placeholder="But, portée, définitions, CQ, responsabilités."></textarea>
            </div>
            <div>
              <label>Contraintes réglementaires & QMS</label>
              <textarea id="qms" rows="4" placeholder="ISO 13485, GMP, ALCOA+, data integrity, change control…"></textarea>
            </div>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:14px">
          <button class="btn secondary" data-prev>Retour</button>
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <div id="step-7" class="step" data-title="7">
        <h2>Étape 7 — Aperçu & export PDF</h2>
        <div id="preview" class="card panel" style="white-space:pre-wrap"></div>
        <div style="display:flex; gap:8px; margin-top:14px; flex-wrap:wrap">
          <button class="btn" id="exportPdf">Exporter en PDF</button>
          <button class="btn ghost" id="startOver">Recommencer</button>
          <button class="btn secondary" data-prev>Retour</button>
        </div>
      </div>
    </section>

    <p class="footer">
      © <span id="year"></span> Montes BioPharma — Front-end client-side. Cette application n’inclut aucun protocole expérimental ni paramètre opératoire.
    </p>
  </main>

  <!-- jsPDF CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

  <script>
    /* ========= CONFIG ========= */
    const LOGO_PATH = "./assets/montes-biopharma-logo.svg"; // <— fichier séparé

    /* ========= STATE ========= */
    const steps = [...document.querySelectorAll('.step')];
    const bar = document.getElementById('progressBar');
    const chips = document.getElementById('stepsChips');
    const state = {
      org:"", role:"",
      vectorType:"", serotype:"", cellLine:"", keywords:"",
      upstream:false, downstream:false,
      upCats:[], dsCats:[],
      enablePubMed:false, yearsWindow:2, retMax:20,
      articles:[], // {uid,title,source,year,authors,pmid,url,score,selected}
      docTitle:"", internalRefs:"", summary:"", qms:""
    };

    /* ========= INIT UI ========= */
    function init(){
      document.getElementById('year').textContent = new Date().getFullYear();
      document.getElementById('navLogo').src = LOGO_PATH;
      document.getElementById('heroLogo').src = LOGO_PATH;

      chips.innerHTML = steps.map((s,i)=>`<span class="chip" data-chip="${i}">${i+1}</span>`).join('');

      document.querySelectorAll('[data-next]').forEach(b=>b.addEventListener('click', ()=>gotoStep(currentStep+1)));
      document.querySelectorAll('[data-prev]').forEach(b=>b.addEventListener('click', ()=>gotoStep(currentStep-1)));

      document.getElementById('org').addEventListener('input', e=>state.org=e.target.value);
      document.getElementById('role').addEventListener('input', e=>state.role=e.target.value);
      document.getElementById('vectorType').addEventListener('change', e=>state.vectorType=e.target.value);
      document.getElementById('serotype').addEventListener('input', e=>state.serotype=e.target.value);
      document.getElementById('cellLine').addEventListener('input', e=>state.cellLine=e.target.value);
      document.getElementById('keywords').addEventListener('input', e=>state.keywords=e.target.value);

      document.getElementById('upstream').addEventListener('change', e=>state.upstream=e.target.checked);
      document.getElementById('downstream').addEventListener('change', e=>state.downstream=e.target.checked);
      document.querySelectorAll('.up-cat').forEach(c=>c.addEventListener('change', syncCats));
      document.querySelectorAll('.ds-cat').forEach(c=>c.addEventListener('change', syncCats));

      document.getElementById('enablePubMed').addEventListener('change', e=>state.enablePubMed=e.target.checked);
      document.getElementById('yearsWindow').addEventListener('change', e=>state.yearsWindow=+e.target.value);
      document.getElementById('retMax').addEventListener('change', e=>state.retMax=+e.target.value);
      document.getElementById('runSearch').addEventListener('click', runPubMedSearch);

      document.getElementById('docTitle').addEventListener('input', e=>state.docTitle=e.target.value);
      document.getElementById('internalRefs').addEventListener('input', e=>state.internalRefs=e.target.value);
      document.getElementById('summary').addEventListener('input', e=>state.summary=e.target.value);
      document.getElementById('qms').addEventListener('input', e=>state.qms=e.target.value);

      document.getElementById('exportPdf').addEventListener('click', exportPDF);
      document.getElementById('startOver').addEventListener('click', ()=>{ localStorage.removeItem('mbp_state'); location.reload(); });

      // restore
      try{
        const saved = JSON.parse(localStorage.getItem('mbp_state')||"null");
        if(saved){ Object.assign(state, saved); hydrate(); }
      }catch(e){}

      renderPreview();
      startParticles(); // <— particules en suspension
    }

    function syncCats(){
      state.upCats = [...document.querySelectorAll('.up-cat:checked')].map(c=>c.value);
      state.dsCats = [...document.querySelectorAll('.ds-cat:checked')].map(c=>c.value);
      persist();
    }

    let currentStep = 0;
    function gotoStep(i){
      if(i>0){
        const ok = document.getElementById('complianceChk').checked;
        if(!ok){ alert("Veuillez valider la déclaration de conformité (usage professionnel)."); return; }
      }
      if(i<0 || i>=steps.length) return;
      steps[currentStep].classList.remove('active');
      currentStep = i;
      steps[currentStep].classList.add('active');
      const percent = Math.round(((currentStep+1)/steps.length)*100);
      bar.style.width = percent+"%";
      [...chips.children].forEach((chip,idx)=>chip.classList.toggle('active', idx===currentStep));
      renderPreview();
      persist();
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function hydrate(){
      const bind = (id, v, prop="value")=>{ const el=document.getElementById(id); if(el){ el[prop]=v||el[prop]; } };
      bind('org', state.org);
      bind('role', state.role);
      bind('vectorType', state.vectorType, 'value');
      bind('serotype', state.serotype);
      bind('cellLine', state.cellLine);
      bind('keywords', state.keywords);

      document.getElementById('upstream').checked = !!state.upstream;
      document.getElementById('downstream').checked = !!state.downstream;

      document.querySelectorAll('.up-cat').forEach(c=>c.checked = state.upCats.includes(c.value));
      document.querySelectorAll('.ds-cat').forEach(c=>c.checked = state.dsCats.includes(c.value));

      document.getElementById('enablePubMed').checked = !!state.enablePubMed;
      bind('yearsWindow', state.yearsWindow, 'value');
      bind('retMax', state.retMax, 'value');

      bind('docTitle', state.docTitle);
      bind('internalRefs', state.internalRefs);
      bind('summary', state.summary);
      bind('qms', state.qms);

      if(state.articles?.length) renderArticles(state.articles);
    }

    function persist(){ localStorage.setItem('mbp_state', JSON.stringify(state)); }

    /* ========= PubMed (biblio uniquement) ========= */
    async function runPubMedSearch(){
      if(!state.enablePubMed){ alert("Activez la recherche."); return; }
      const base = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/';
      const terms = [
        'adenovirus',
        (state.serotype||'').trim(),
        (state.cellLine||'').trim(),
        ...(state.keywords||'').split(',').map(s=>s.trim()).filter(Boolean)
      ].filter(Boolean).join(' ');
      const mindate = new Date(); mindate.setFullYear(mindate.getFullYear()- (+state.yearsWindow||2));
      const yfrom = mindate.getFullYear();

      try{
        const esearchUrl = `${base}esearch.fcgi?db=pubmed&retmode=json&sort=date&retmax=${encodeURIComponent(state.retMax||20)}&term=${encodeURIComponent(terms)}+AND+(${yfrom}%3A3000%5Bdp%5D)`;
        const esResp = await fetch(esearchUrl);
        const es = await esResp.json();
        const ids = es.esearchresult?.idlist || [];
        if(!ids.length){ renderArticles([]); alert("Aucun article trouvé avec ces critères."); return; }

        const esumUrl = `${base}esummary.fcgi?db=pubmed&retmode=json&id=${ids.join(',')}`;
        const sumResp = await fetch(esumUrl);
        const sum = await sumResp.json();
        const recs = Object.values(sum.result||{}).filter(v=>v?.uid);

        const kw = (state.keywords||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
        const scored = recs.map(r=>{
          const title = r.title||'';
          const journal = r.fulljournalname||r.source||'';
          const year = (r.pubdate||'').slice(0,4);
          const authors = (r.authors||[]).map(a=>a.name).slice(0,6);
          const pmid = r.uid;
          const url = `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`;
          let score = 0;
          const t = title.toLowerCase();
          if((state.serotype||'').toLowerCase() && t.includes((state.serotype||'').toLowerCase())) score+=2;
          if((state.cellLine||'').toLowerCase() && t.includes((state.cellLine||'').toLowerCase())) score+=2;
          kw.forEach(k=>{ if(k && (t.includes(k) || journal.toLowerCase().includes(k))) score+=1; });
          const y = parseInt(year||'0',10); const now = new Date().getFullYear();
          if(y && now-y <= 2) score+=2; else if(y && now-y<=5) score+=1;
          return {uid:pmid, title, source:journal, year, authors, pmid, url, score, selected:false};
        }).sort((a,b)=>b.score-a.score);

        state.articles = scored;
        renderArticles(scored);
        persist();
      }catch(err){
        console.error(err);
        alert("Erreur lors de la recherche PubMed (connexion ou limites d’API).");
      }
    }

    function renderArticles(list){
      const box = document.getElementById('pubResults');
      if(!list.length){ box.innerHTML = '<div class="panel card muted">Aucun résultat pour l’instant.</div>'; return; }
      box.innerHTML = '';
      list.forEach(rec=>{
        const el = document.createElement('div');
        el.className = 'pub-card';
        el.innerHTML = `
          <div><strong>${sanitize(rec.title)}</strong></div>
          <div class="muted">${sanitize(rec.source)} · ${sanitize(rec.year||'—')}</div>
          <div class="muted">Auteurs: ${sanitize((rec.authors||[]).join(', '))}</div>
          <div class="pub-actions">
            <span class="tag">PMID: ${rec.pmid}</span>
            <span class="tag">Score: <span class="score">${rec.score}</span></span>
            <a class="tag" href="${rec.url}" target="_blank" rel="noopener noreferrer">Voir sur PubMed</a>
            <button class="btn secondary" data-toggle="${rec.uid}">${rec.selected?'Désélectionner':'Sélectionner'}</button>
          </div>
        `;
        el.querySelector(`[data-toggle="${rec.uid}"]`).addEventListener('click', ()=>{
          rec.selected = !rec.selected;
          renderArticles(state.articles); persist(); renderPreview();
        });
        box.appendChild(el);
      });
    }

    /* ========= Preview (ossature) ========= */
    function renderPreview(){
      const meta = [
        state.org ? `Organisation : ${state.org}` : null,
        state.role ? `Rôle : ${state.role}` : null,
      ].filter(Boolean).join('\n');

      const selections = [
        state.vectorType ? `Vecteur : ${state.vectorType}` : null,
        state.serotype ? `Sérotype : ${state.serotype}` : null,
        state.cellLine ? `Lignée cellulaire : ${state.cellLine}` : null,
        state.upstream ? `Sections Upstream (métadonnées)` : null,
        ...state.upCats.map(c=>'  • '+c),
        state.downstream ? `Sections Downstream (métadonnées)` : null,
        ...state.dsCats.map(c=>'  • '+c),
      ].filter(Boolean).join('\n');

      const refs = (state.articles||[]).filter(a=>a.selected).map(a=>`- ${a.title} (${a.year}). ${a.source}. PMID:${a.pmid} — ${a.url}`);

      const outline = `# ${state.docTitle || 'Ossature protocole — Adénovirus (exemple)'}\n
${meta}\n
## 1. But, portée et définitions
${state.summary || 'Décrire la finalité du document, la portée, les définitions clés et les responsabilités. Ne pas inclure de paramètres expérimentaux.'}

## 2. Référentiel qualité et conformité
${state.qms || 'Lister les référentiels applicables (ex. ISO 13485, GMP), data integrity (ALCOA+), gestion documentaire, change control, training, risk management.'}

## 3. Métadonnées du produit et du procédé
${selections || 'Renseigner les métadonnées du procédé (sans paramètres opératoires). Inclure références internes de SOP.'}
  - Références internes : ${state.internalRefs || 'à compléter'}

## 4. Vue d’ensemble des sections (sans procédures)
- Upstream (si applicable) : objectifs, CQ d’entrée, références SOP-*** (sans détails).
- Downstream (si applicable) : catégories documentaires (clarification, capture, polishing, TFF, CQ), références SOP-***.

## 5. Références bibliographiques (sélectionnées)
${refs.length ? refs.join('\n') : 'Aucune référence sélectionnée pour le moment.'}

## 6. Annexes (gabarits & check-lists)
- Check-list de préparation documentaire (gabarit).
- Matrice de traçabilité & data integrity (gabarit).
- Registre des versions et change control.
`;
      document.getElementById('preview').textContent = outline;
    }

    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const title = state.docTitle || 'Ossature protocole — Adénovirus';
      const content = document.getElementById('preview').textContent;
      const margin = 48; let y = margin;

      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text(title, margin, y); y += 18;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      const lines = doc.splitTextToSize(content, doc.internal.pageSize.getWidth() - margin*2);
      lines.forEach(line=>{
        if(y > doc.internal.pageSize.getHeight() - margin){ doc.addPage(); y = margin; }
        doc.text(line, margin, y); y += 14;
      });
      doc.save((title.replace(/\s+/g,'-').toLowerCase())+'.pdf');
    }

    function sanitize(s){ return (s||'').replace(/[<>&]/g, c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])); }

    /* ========= PARTICULES EN SUSPENSION (drift + twinkle) ========= */
    let P = []; // particules
    let ctx, W, H, rafId;

    function startParticles(){
      const canvas = document.getElementById('particlesCanvas');
      ctx = canvas.getContext('2d');
      const setSize = ()=>{ W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; };
      setSize(); window.addEventListener('resize', setSize);

      const count = Math.min(140, Math.round((W*H)/18000)); // densité douce
      P = Array.from({length:count}, (_,i)=>spawnParticle(i));

      cancelAnimationFrame(rafId);
      loopParticles();
    }

    function spawnParticle(i){
      // deux familles : vert fluo (petit glow) et bleu (glow doux)
      const green = Math.random() < 0.55;
      const r = green ? rand(0.8, 1.8) : rand(1.0, 2.2);
      const speed = rand(0.06, 0.18);
      const drift = green ? rand(-0.08, 0.08) : rand(-0.06, 0.06);
      return {
        x: Math.random()*W,
        y: Math.random()*H,
        vx: drift,
        vy: -speed, // lente remontée
        r,
        phase: Math.random()*Math.PI*2,
        twinkle: rand(0.4, 0.9),
        color: green ? 'green' : 'blue'
      };
    }

    function loopParticles(t=0){
      rafId = requestAnimationFrame(loopParticles);
      ctx.clearRect(0,0,W,H);

      for(let i=0;i<P.length;i++){
        const p = P[i];
        // update position
        p.x += p.vx;
        p.y += p.vy;
        // wrap
        if(p.x < -5) p.x = W+5;
        if(p.x > W+5) p.x = -5;
        if(p.y < -5) { p.y = H+5; p.x = Math.random()*W; } // remonte puis réapparaît en bas

        // twinkle
        p.phase += 0.01 + (p.color==='green' ? 0.005 : 0.008);
        const a = 0.25 + 0.35 * Math.abs(Math.sin(p.phase)) * p.twinkle;

        // draw with glow
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        if(p.color==='green'){
          ctx.fillStyle = `rgba(124,244,91,${a})`;
          ctx.shadowColor = 'rgba(124,244,91,0.7)';
          ctx.shadowBlur = 6;
        }else{
          ctx.fillStyle = `rgba(36,86,255,${a})`;
          ctx.shadowColor = 'rgba(36,86,255,0.7)';
          ctx.shadowBlur = 8;
        }
        ctx.fill();
        ctx.shadowBlur = 0; // reset
      }
    }

    function rand(a,b){ return a + Math.random()*(b-a); }

    /* ========= START ========= */
    init();
  </script>
</body>
</html>

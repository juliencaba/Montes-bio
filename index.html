<!doctype html>
<html lang="fr" data-lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Montes BioPharma — Assistant Littérature</title>
<meta name="color-scheme" content="light"/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<!-- pdf.js / mammoth.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" crossorigin="anonymous"></script>

<style>
:root{
  --bg:#F6F7FB; --panel:#FFFFFF; --ink:#0F1226; --muted:#6C7392;
  --primary:#3A49FF; --accent:#00FF6A; --border:#E6E9F4;
  --radius:18px; --shadow:0 10px 30px rgba(15,18,38,.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:Outfit,system-ui,-apple-system,"Segoe UI",Ubuntu,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
a{color:var(--primary);text-decoration:none}
a:hover{text-decoration:underline}
img{display:block;max-width:100%}
.hide{display:none}

/* ===== Particles ===== */
#particlesCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;mix-blend-mode:multiply;opacity:.75}

/* ===== Header ===== */
header{
  position:sticky;top:0;z-index:40;backdrop-filter:saturate(180%) blur(10px);
  background:rgba(255,255,255,.7); border-bottom:1px solid var(--border);
}
.nav{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;gap:14px}
.logo{height:40px;width:auto}
.brand{font-weight:800;letter-spacing:.02em;color:var(--ink)}
.lang{margin-left:auto;display:flex;gap:8px;align-items:center}

/* Hamburger + dropdown menu */
.icon-btn{
  appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);
  padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:10px;
}
#menuBtn .bars{position:relative;width:18px;height:12px}
#menuBtn .bars::before,#menuBtn .bars::after,#menuBtn .bar{
  content:"";position:absolute;left:0;right:0;height:2px;background:#3A49FF;border-radius:2px
}
#menuBtn .bar{top:5px}
#menuBtn .bars::before{top:0}
#menuBtn .bars::after{bottom:0}

/* Dropdown */
#menuDropdown{
  position:absolute;right:20px;top:56px;z-index:60;min-width:220px;
  background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 14px 36px rgba(15,18,38,.12);
  display:none;overflow:hidden;
}
#menuDropdown.open{display:block}
.menu-item{
  display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;
  border-bottom:1px solid var(--border);background:#fff
}
.menu-item:last-child{border-bottom:none}
.menu-item:hover{background:#F6F8FF}
.menu-item .dot{width:8px;height:8px;border-radius:50%;background:#C8CEFF}

/* ===== Hero & tiles (for Intro tab) ===== */
.hero{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:56px 20px 18px}
.kicker{color:var(--accent);font-weight:800;letter-spacing:.28em;font-size:13px;text-transform:uppercase}
h1.hero-title{margin:10px 0 10px;font-size:clamp(36px,6vw,64px);line-height:1.04;color:var(--primary);text-transform:uppercase;font-weight:800}
.hero-sub{color:var(--muted);font-size:18px;max-width:820px}
.cta{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px}
.btn{
  appearance:none;cursor:pointer;border-radius:999px;padding:14px 22px;font-weight:700;border:2px solid transparent;
  transition:transform .06s ease, box-shadow .2s ease, background .2s ease,color .2s ease;
}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
.btn.primary:hover{box-shadow:0 14px 36px rgba(58,73,255,.25)}
.btn.ghost{background:#fff;color:var(--primary);border-color:var(--primary)}
.btn.flat{background:#fff;color:#111;border-color:#E0E5FF}

.services{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:14px 20px 8px}
.tiles{display:grid;gap:16px}
@media(min-width:880px){.tiles{grid-template-columns:repeat(4,1fr)}}
.tile{
  background:linear-gradient(180deg,#F8F9FF,#EEF1FF);border:1px solid #E0E5FF;border-radius:18px;padding:18px;box-shadow:0 12px 24px rgba(58,73,255,.08);
  transition:transform .18s ease, box-shadow .18s ease;
}
.tile:hover{transform:translateY(-3px);box-shadow:0 18px 36px rgba(58,73,255,.16)}
.tile .badge{display:inline-block;font-size:12px;padding:4px 10px;border-radius:999px;background:#fff;border:1px solid #D7DEFF;color:#3A49FF;font-weight:800;letter-spacing:.04em}
.tile h3{margin:10px 0 6px;color:#0F1226}
.tile p{margin:0;color:var(--muted);font-size:14px}

/* ===== Sections / Cards (for App tab) ===== */
.section{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:22px 20px 10px}
.cards{display:grid;gap:18px}
@media(min-width:880px){.cards{grid-template-columns:1fr 1fr}}
.block{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;
}
.block header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:18px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#fff,#FBFCFF)}
.block header .overline{color:var(--accent);font-weight:800;letter-spacing:.18em;font-size:11px}
.block header h2{margin:2px 0 0;font-size:22px;color:var(--primary);text-transform:uppercase;letter-spacing:.02em}
.block .inner{padding:18px 20px}
.muted{color:var(--muted)}
hr.sep{border:none;border-top:1px solid var(--border);margin:14px 0}

/* Inputs & Buttons */
.grid{display:grid;gap:12px}
.row{display:grid;gap:10px}
@media(min-width:760px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
label,strong,em,small{font-weight:600}
input,select,textarea{
  width:100%;background:#fff;color:var(--ink);border:1.5px solid var(--border);border-radius:14px;padding:12px 14px;outline:none;
  transition:border .2s ease, box-shadow .2s ease, transform .06s ease;
}
input:focus,select:focus,textarea:focus{border-color:#C9D0FF;box-shadow:0 0 0 4px rgba(58,73,255,.12)}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn.secondary{background:#fff;color:var(--primary);border:2px solid var(--primary)}
.btn.secondary:hover{background:#F0F2FF}

/* Pubs */
.pub-card{
  border:1px solid var(--border);border-radius:16px;padding:14px;background:#fff;display:grid;gap:6px;box-shadow:0 6px 16px rgba(15,18,38,.04);
  transition:transform .12s ease, box-shadow .12s ease;
}
.pub-card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(15,18,38,.08)}
.tag{font-size:11px;padding:4px 10px;border:1px solid #E0E5FF;border-radius:999px;background:#fff;color:#3A49FF;font-weight:700;letter-spacing:.02em}

/* Upload */
.drop{display:grid;place-items:center;text-align:center;gap:8px;padding:26px;border:2px dashed #CBD3FF;border-radius:16px;background:#FBFCFF;color:var(--muted)}
.drop.drag{border-color:var(--primary);background:#F4F6FF}
.file-list{display:grid;gap:10px;margin-top:10px}
.file-item{padding:10px;border:1px solid var(--border);border-radius:14px;background:#fff}

/* Preview */
pre#preview{white-space:pre-wrap;background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;color:#111;box-shadow:0 6px 16px rgba(15,18,38,.04)}

/* Footer */
footer{position:relative;z-index:1;margin-top:36px;background:#fff;border-top:1px solid var(--border)}
.footer-wrap{max-width:1200px;margin:0 auto;padding:28px 20px 36px}
.footer-grid{display:grid;gap:22px}
@media(min-width:900px){.footer-grid{grid-template-columns:1.2fr 1fr 1fr 1fr}}
.footer-title{color:var(--accent);font-weight:800;letter-spacing:.22em;font-size:12px;margin-bottom:12px;text-transform:uppercase}
.footer-col a{display:block;margin:6px 0;color:#3c44c9}
.footer-bottom{display:flex;align-items:center;justify-content:space-between;gap:10px;color:var(--muted);font-size:14px;margin-top:18px}

/* Tabs (3 pages) */
.tab{display:none}
.tab.active{display:block}
</style>
</head>

<body>
<canvas id="particlesCanvas"></canvas>

<!-- ===== Header ===== -->
<header>
  <div class="nav">
    <img src="./assets/montes-biopharma-logo.svg" alt="Montes BioPharma" class="logo">
    <div class="brand" data-i="brand">Montes BioPharma</div>

    <div class="lang">
      <button id="menuBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false" aria-controls="menuDropdown" title="Menu">
        <span class="bars" aria-hidden="true"><span class="bar"></span></span>
        <span class="sr-only" style="position:absolute;left:-9999px" data-i="menu">Menu</span>
      </button>
      <div id="menuDropdown" role="menu" aria-labelledby="menuBtn">
        <div class="menu-item" data-tab="intro" role="menuitem"><span class="dot"></span><span data-i="navIntro">Introduction</span></div>
        <div class="menu-item" data-tab="app" role="menuitem"><span class="dot"></span><span data-i="navApp">Application</span></div>
        <div class="menu-item" data-tab="contact" role="menuitem"><span class="dot"></span><span data-i="navContact">Contact</span></div>
      </div>

      <button id="btnFR" class="icon-btn active">FR</button>
      <button id="btnEN" class="icon-btn">EN</button>
    </div>
  </div>
</header>

<!-- ===== Tab 1: INTRO ===== -->
<section id="tab-intro" class="tab active" aria-labelledby="navIntro">
  <section class="hero">
    <div class="kicker" data-i="kicker">ASSISTANT LITTÉRATURE</div>
    <h1 class="hero-title" data-i="heroTitle">No learning curve,<br/>no complications</h1>
    <p class="hero-sub" data-i="heroSub">
      <span data-i="introP1">Recherche d’articles (Europe PMC), upload de documents internes, analyse de contenu par IA, et création de protocoles documentaires pour la production d’adénovirus.</span>
      <br/><span data-i="introP2">Interface clinique, lumineuse, export PDF, aucune donnée envoyée côté serveur pour l’extraction locale.</span>
    </p>
    <div class="cta">
      <button class="btn primary" id="openMenuCta" data-i="ctaOpenMenu">Ouvrir le menu</button>
      <button class="btn ghost" id="openMenuLearn" data-i="ctaOpenLearn">Que puis-je faire ?</button>
    </div>
  </section>

  <section class="services">
    <div class="tiles">
      <div class="tile">
        <span class="badge" data-i="t1Badge">Upload</span>
        <h3 data-i="t1Title">Documents internes</h3>
        <p data-i="t1Text">PDF, DOCX, TXT — extraction locale dans votre navigateur (aucun envoi).</p>
      </div>
      <div class="tile">
        <span class="badge" data-i="t2Badge">Europe PMC</span>
        <h3 data-i="t2Title">Recherche d’articles</h3>
        <p data-i="t2Text">Fenêtre temporelle, mots-clés, open access. Résultats enrichis et liens PubMed.</p>
      </div>
      <div class="tile">
        <span class="badge" data-i="t3Badge">AI</span>
        <h3 data-i="t3Title">Synthèse des contenus</h3>
        <p data-i="t3Text">Résumé automatique (Hugging Face) d’abstracts et texte intégral. Sections méthodologiques extraites.</p>
      </div>
      <div class="tile">
        <span class="badge" data-i="t4Badge">PDF</span>
        <h3 data-i="t4Title">Export documentaire</h3>
        <p data-i="t4Text">Protocole documentaire structuré, lisible et partageable (sans paramètres expérimentaux).</p>
      </div>
    </div>
  </section>
</section>

<!-- ===== Tab 2: APP (structure inchangée blk0 → blk5) ===== -->
<section id="tab-app" class="tab" aria-labelledby="navApp">
  <main>
    <div class="section">
      <div class="cards">
        <!-- Bloc 1 : Conformité + Upload -->
        <section id="blk0" class="block open">
          <header>
            <div>
              <div class="overline" data-i="s1Title">CONTEXTE & CONFORMITÉ</div>
              <h2 data-i="s1Sub">Usage pro uniquement</h2>
            </div>
          </header>
          <div class="inner">
            <label class="kv" style="display:flex;gap:10px;align-items:center">
              <input type="checkbox" id="compliance" style="width:auto">
              <span data-i="s1Check">Je confirme être un professionnel habilité et m’appuyer sur des SOP internes validées.</span>
            </label>
            <hr class="sep">
            <h3 class="overline" data-i="s6Title">DOCUMENTS INTERNES (ANALYSE LOCALE)</h3>
            <p class="muted" data-i="s6Text">Déposez des fichiers PDF, DOCX ou TXT. Texte extrait localement. La synthèse peut utiliser Hugging Face.</p>
            <div id="drop" class="drop">
              <div>
                <strong data-i="s6DropTitle">Déposez vos fichiers ici</strong>
                <div class="muted" data-i="s6DropHint">ou cliquez pour sélectionner</div>
                <small data-i="s6DropTypes">Acceptés : PDF, DOCX, TXT</small>
              </div>
              <input id="fileInput" type="file" multiple accept=".pdf,.docx,.txt" style="display:none">
            </div>
            <div class="file-list" id="filesList"></div>
            <div class="controls">
              <button class="btn primary" id="runLocal" data-i="btnAnalyze">Analyser</button>
              <button class="btn secondary" data-open="#blk1" data-i="btnContinue">Continuer</button>
            </div>
          </div>
        </section>

        <!-- Bloc 2 : Paramètres -->
        <section id="blk1" class="block">
          <header>
            <div>
              <div class="overline" data-i="s2Title">PARAMÈTRES & TECHNIQUES</div>
              <h2 data-i="s2Sub">Contexte scientifique</h2>
            </div>
          </header>
          <div class="inner">
            <div class="row row-3">
              <div><label data-i="labVector">Vecteur</label><input id="vector" placeholder="Adenovirus"></div>
              <div><label data-i="labSerotype">Sérotype</label><input id="serotype" placeholder="Ad5"></div>
              <div><label data-i="labCellLine">Lignée cellulaire</label><input id="cellLine" placeholder="HEK293 / PER.C6"></div>
            </div>
            <div class="row" style="margin-top:8px">
              <div><label data-i="labKeywords">Mots-clés complémentaires</label><input id="keywords" placeholder="chromatography, anion exchange, membrane, affinity"></div>
            </div>
            <div class="grid" style="margin-top:10px">
              <strong class="overline" data-i="techTitle">TECHNIQUES DOWNSTREAM</strong>
              <label><input type="checkbox" class="tech" value="Clarification"> <span data-i="tClarif">Clarification</span></label>
              <label><input type="checkbox" class="tech" value="Capture"> <span data-i="tCapture">Capture (affinité / AEX)</span></label>
              <label><input type="checkbox" class="tech" value="Polishing"> <span data-i="tPolishing">Polishing</span></label>
              <label><input type="checkbox" class="tech" value="TFF"> <span data-i="tTFF">TFF (Concentration / Diafiltration)</span></label>
              <label><input type="checkbox" class="tech" value="QC"> <span data-i="tQC">Contrôles qualité (attributs)</span></label>
              <label><input type="checkbox" class="tech" value="Formulation"> <span data-i="tForm">Formulation / Documentation</span></label>
            </div>
            <div class="controls">
              <button class="btn secondary" data-open="#blk2" data-i="btnContinue">Continuer</button>
            </div>
          </div>
        </section>

        <!-- Bloc 3 : Recherche -->
        <section id="blk2" class="block">
          <header>
            <div>
              <div class="overline" data-i="searchTitle">RECHERCHE LITTÉRATURE</div>
              <h2>Europe PMC</h2>
            </div>
            <small class="muted">OA + abstracts</small>
          </header>
          <div class="inner">
            <div class="row row-2">
              <div>
                <label data-i="labYears">Fenêtre (années)</label>
                <select id="yearsWindow"><option value="1">1</option><option value="2" selected>2</option><option value="5">5</option><option value="10">10</option></select>
              </div>
              <div>
                <label data-i="labMax">Nombre max. d’articles</label>
                <select id="retMax"><option value="5">5</option><option value="10" selected>10</option><option value="20">20</option><option value="50">50</option></select>
              </div>
            </div>
            <label class="kv" style="margin-top:8px;display:flex;gap:10px;align-items:center">
              <input type="checkbox" id="onlyOA" checked style="width:auto">
              <span data-i="labOA">Uniquement open access (texte intégral)</span>
            </label>
            <div class="controls">
              <button class="btn primary" id="runSearch" data-i="btnSearch">Lancer la recherche</button>
              <button class="btn secondary" data-open="#blk3" data-i="btnContinue">Continuer</button>
            </div>
          </div>
        </section>

        <!-- Bloc 4 : Résultats -->
        <section id="blk3" class="block">
          <header>
            <div>
              <div class="overline" data-i="s3Title">RÉSULTATS LITTÉRATURE</div>
              <h2>Europe PMC</h2>
            </div>
            <small id="searchInfo" class="muted"></small>
          </header>
          <div class="inner">
            <div id="results" class="grid"></div>
            <div class="controls">
              <button class="btn secondary" data-open="#blk4" data-i="btnContinue">Continuer</button>
            </div>
          </div>
        </section>

        <!-- Bloc 5 : Analyse IA -->
        <section id="blk4" class="block">
          <header>
            <div>
              <div class="overline" data-i="s4Title">ANALYSE IA</div>
              <h2 data-i="s4Sub">Articles sélectionnés</h2>
            </div>
            <small id="selInfo" class="muted"></small>
          </header>
          <div class="inner">
            <p class="muted" data-i="s4Text">Sélectionne au moins 1 article puis lance l’analyse. Résumé automatique (Hugging Face).</p>
            <div id="selectedList" class="grid"></div>
            <div class="controls">
              <button class="btn primary" id="analyzeBtn" data-i="btnAnalyze">Analyser</button>
              <button class="btn secondary" data-open="#blk5" data-i="btnContinue">Continuer</button>
            </div>
          </div>
        </section>

        <!-- Bloc 6 : Aperçu & PDF -->
        <section id="blk5" class="block open">
          <header>
            <div>
              <div class="overline" data-i="s5Title">APERÇU & EXPORT PDF</div>
              <h2 data-i="s5Sub">Protocole documentaire</h2>
            </div>
          </header>
          <div class="inner">
            <div class="kv"><div class="muted" data-i="safety">Note : sortie documentaire basée littérature. Aucun paramètre expérimental.</div></div>
            <pre id="preview"></pre>
            <div class="controls">
              <button class="btn primary" id="exportPdf" data-i="btnPdf">Exporter le PDF</button>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>
</section>

<!-- ===== Tab 3: CONTACT ===== -->
<section id="tab-contact" class="tab" aria-labelledby="navContact">
  <section class="section">
    <div class="cards">
      <section class="block open">
        <header>
          <div>
            <div class="overline" data-i="cTitle">PRISE DE CONTACT</div>
            <h2 data-i="cSub">Discutons de votre projet</h2>
          </div>
        </header>
        <div class="inner">
          <p class="muted" data-i="cLead">
            Nos scientifiques experts peuvent vous aider à accélérer la mise au point de vos procédés (vecteurs adénoviraux, purification, analytique, documentation).
          </p>
          <div class="row row-2">
            <div><label data-i="cName">Nom</label><input id="c_name" placeholder="Jane Doe"></div>
            <div><label data-i="cOrg">Société</label><input id="c_org" placeholder="Montes BioPharma"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div><label>Email</label><input id="c_email" placeholder="you@company.com" type="email"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div><label data-i="cMsg">Message</label><textarea id="c_msg" rows="4" placeholder="Tell us about your project..."></textarea></div>
          </div>
          <div class="controls">
            <a id="c_mailto" class="btn primary" href="#" data-i="cSend">Envoyer par e-mail</a>
            <a class="btn secondary" href="https://www.linkedin.com" target="_blank" rel="noopener" data-i="cLinkedIn">LinkedIn</a>
          </div>
        </div>
      </section>
    </div>
  </section>
</section>

<!-- ===== FOOTER ===== -->
<footer>
  <div class="footer-wrap">
    <div class="footer-grid">
      <div class="footer-col">
        <div class="footer-title" data-i="fMenu">MENU</div>
        <span class="muted" data-i="fHint">Utilisez le bouton en haut à droite pour ouvrir le menu.</span>
      </div>
      <div class="footer-col">
        <div class="footer-title" data-i="fLegal">LEGAL</div>
        <a href="#" data-i="fMentions">Mentions légales</a>
        <a href="#" data-i="fPrivacy">Confidentialité</a>
        <a href="#" data-i="fCookies">Cookies</a>
      </div>
      <div class="footer-col">
        <div class="footer-title" data-i="fSocial">SOCIAL</div>
        <a href="#">LinkedIn</a><a href="#">Instagram</a><a href="#">Facebook</a>
      </div>
      <div class="footer-col">
        <div class="footer-title" data-i="fContact">CONTACT</div>
        <div>Montes BioPharma</div><div class="muted" data-i="fCity">Bruxelles — Belgique</div><div class="muted">contact@montes.bio</div>
      </div>
    </div>
    <div class="footer-bottom">
      <div>© <span id="year"></span> <span data-i="brand">Montes BioPharma</span></div>
      <div class="muted" data-i="fFoot">Europe PMC / PubMed — Hugging Face (optionnel). Aucune instruction expérimentale.</div>
    </div>
  </div>
</footer>

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

<script>
/* =================== Particles (plus visibles) =================== */
const cv=document.getElementById('particlesCanvas'),cx=cv.getContext('2d');let W,H,PTS=[];
function size(){W=cv.width=innerWidth;H=cv.height=innerHeight} size(); addEventListener('resize',size);
function R(a,b){return a+Math.random()*(b-a)}
function spawn(){return{x:R(0,W),y:R(0,H),vx:R(-.05,.05),vy:-R(.02,.07),r:R(1.2,3.0),t:R(0,6.28),tw:R(.8,1.3)}}
PTS=Array.from({length:Math.min(280,Math.round((W*H)/14000))},spawn);
(function loop(){requestAnimationFrame(loop);cx.clearRect(0,0,W,H);
for(const p of PTS){p.t+=.016;const a=.15+.45*Math.abs(Math.sin(p.t))*p.tw;p.x+=p.vx+Math.sin(p.t*.35)*.03;p.y+=p.vy;
if(p.x<-6)p.x=W+6;if(p.x>W+6)p.x=-6;if(p.y<-6){p.y=H+6;p.x=Math.random()*W;}
const mix=Math.abs(Math.sin(p.t*.5));const r=Math.round(20+38*mix), g=Math.round(150+100*(1-mix)), b=Math.round(255-40*(1-mix));
cx.beginPath();cx.arc(p.x,p.y,p.r,0,6.283);cx.fillStyle=`rgba(${r},${g},${b},${a})`;cx.fill();}})();

/* =================== Dropdown menu (onglets) =================== */
const menuBtn = document.getElementById('menuBtn');
const menuDD  = document.getElementById('menuDropdown');
function openMenu(){menuDD.classList.add('open');menuBtn.setAttribute('aria-expanded','true');}
function closeMenu(){menuDD.classList.remove('open');menuBtn.setAttribute('aria-expanded','false');}
menuBtn.addEventListener('click',(e)=>{e.stopPropagation();menuDD.classList.toggle('open');menuBtn.setAttribute('aria-expanded', menuDD.classList.contains('open'));});
document.addEventListener('click',(e)=>{ if(!menuDD.contains(e.target) && e.target!==menuBtn) closeMenu();});
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeMenu();});

/* Tabs show/hide (only via menu) */
const tabs = {
  intro: document.getElementById('tab-intro'),
  app: document.getElementById('tab-app'),
  contact: document.getElementById('tab-contact')
};
function showTab(name){
  Object.keys(tabs).forEach(k=>tabs[k].classList.remove('active'));
  (tabs[name]||tabs.intro).classList.add('active');
  // Optionnel: hash en URL (utile pour partager), mais on n'ajoute pas d'autres triggers UI
  history.replaceState(null,'',`#${name}`);
  closeMenu();
  window.scrollTo({top:0,behavior:'smooth'});
}
menuDD.querySelectorAll('.menu-item').forEach(it=>{
  it.addEventListener('click',()=>{showTab(it.dataset.tab);});
});
// CTA Intro → ouvre juste le menu (ne change pas d’onglet)
document.getElementById('openMenuCta').onclick = openMenu;
document.getElementById('openMenuLearn').onclick = openMenu;
// Au chargement, si un hash est présent (#intro/#app/#contact), on l’applique (utile pour lien partagé)
window.addEventListener('DOMContentLoaded',()=>{
  const h=(location.hash||'').replace('#','');
  if(['intro','app','contact'].includes(h)) showTab(h);
});

/* =================== i18n =================== */
const I={
  fr:{
    brand:"Montes BioPharma",menu:"Menu",navIntro:"Introduction",navApp:"Application",navContact:"Contact",
    kicker:"ASSISTANT LITTÉRATURE",
    heroTitle:"No learning curve,<br/>no complications",
    heroSub:"Analyse Europe&nbsp;PMC, extraction locale PDF/DOCX, synthèse IA et export PDF — dans une interface clinique et lumineuse.",
    introP1:"Recherche d’articles (Europe PMC), upload de documents internes, analyse de contenu par IA, et création de protocoles documentaires pour la production d’adénovirus.",
    introP2:"Interface clinique, lumineuse, export PDF, aucune donnée envoyée côté serveur pour l’extraction locale.",
    ctaOpenMenu:"Ouvrir le menu", ctaOpenLearn:"Que puis-je faire ?",

    t1Badge:"Upload", t1Title:"Documents internes", t1Text:"PDF, DOCX, TXT — extraction locale dans votre navigateur (aucun envoi).",
    t2Badge:"Europe PMC", t2Title:"Recherche d’articles", t2Text:"Fenêtre temporelle, mots-clés, open access. Résultats enrichis et liens PubMed.",
    t3Badge:"AI", t3Title:"Synthèse des contenus", t3Text:"Résumé automatique (Hugging Face) d’abstracts et texte intégral. Sections méthodologiques extraites.",
    t4Badge:"PDF", t4Title:"Export documentaire", t4Text:"Protocole documentaire structuré, lisible et partageable (sans paramètres expérimentaux).",

    /* App blocs */
    s1Title:"CONTEXTE & CONFORMITÉ", s1Sub:"Usage pro uniquement",
    s1Check:"Je confirme être un professionnel habilité et m’appuyer sur des SOP internes validées.",
    s2Title:"PARAMÈTRES & TECHNIQUES", s2Sub:"Contexte scientifique",
    techTitle:"TECHNIQUES DOWNSTREAM",
    tClarif:"Clarification", tCapture:"Capture (affinité / AEX)", tPolishing:"Polishing", tTFF:"TFF (Concentration / Diafiltration)", tQC:"Contrôles qualité (attributs)", tForm:"Formulation / Documentation",
    searchTitle:"RECHERCHE LITTÉRATURE",
    labVector:"Vecteur", labSerotype:"Sérotype", labCellLine:"Lignée cellulaire", labKeywords:"Mots-clés complémentaires",
    labYears:"Fenêtre (années)", labMax:"Nombre max. d’articles", labOA:"Uniquement open access (texte intégral)", btnSearch:"Lancer la recherche",
    s3Title:"RÉSULTATS LITTÉRATURE",
    s4Title:"ANALYSE IA", s4Sub:"Articles sélectionnés", s4Text:"Sélectionne au moins 1 article puis lance l’analyse. Résumé automatique (Hugging Face).",
    btnAnalyze:"Analyser", btnContinue:"Continuer",
    s5Title:"APERÇU & EXPORT PDF", s5Sub:"Protocole documentaire", btnPdf:"Exporter le PDF",
    safety:"Note : sortie documentaire basée littérature. Aucun paramètre expérimental.",

    /* Contact */
    cTitle:"PRISE DE CONTACT", cSub:"Discutons de votre projet", cLead:"Nos scientifiques experts peuvent vous aider à accélérer la mise au point de vos procédés (vecteurs adénoviraux, purification, analytique, documentation).",
    cName:"Nom", cOrg:"Société", cMsg:"Message", cSend:"Envoyer par e-mail", cLinkedIn:"LinkedIn",

    /* Footer */
    fMenu:"MENU", fHint:"Utilisez le bouton en haut à droite pour ouvrir le menu.",
    fLegal:"LEGAL", fSocial:"SOCIAL", fContact:"CONTACT", fMentions:"Mentions légales", fPrivacy:"Confidentialité", fCookies:"Cookies", fCity:"Bruxelles — Belgique",
    fFoot:"Europe PMC / PubMed — Hugging Face (optionnel). Aucune instruction expérimentale.",

    /* Dynamiques */
    d_searching:"Recherche…", d_open:"Voir", d_noSel:"Aucune sélection.", d_ai:"Analyse IA…", d_none:"(aucun)",
    d_alert_compliance:"Merci de confirmer la conformité.", d_alert_need1:"Sélectionne au moins 1 article.", d_alert_needTech:"Sélectionne au moins une technique.", d_nofile:"Aucun fichier."
  },
  en:{
    brand:"Montes BioPharma",menu:"Menu",navIntro:"Introduction",navApp:"Application",navContact:"Contact",
    kicker:"LITERATURE ASSISTANT",
    heroTitle:"No learning curve,<br/>no complications",
    heroSub:"Europe PMC analysis, local PDF/DOCX extraction, AI synthesis and PDF export — in a clean, clinical interface.",
    introP1:"Article search (Europe PMC), internal document upload, AI content analysis, and creation of documentary protocols for adenovirus production.",
    introP2:"Clean, clinical UI. PDF export. No server upload for local extraction.",
    ctaOpenMenu:"Open menu", ctaOpenLearn:"What can I do?",

    t1Badge:"Upload", t1Title:"Internal documents", t1Text:"PDF, DOCX, TXT — extracted locally in your browser (no upload).",
    t2Badge:"Europe PMC", t2Title:"Article search", t2Text:"Time window, keywords, open access. Enriched results and PubMed links.",
    t3Badge:"AI", t3Title:"Content synthesis", t3Text:"Automatic summaries (Hugging Face) from abstracts and full text. Method sections extracted.",
    t4Badge:"PDF", t4Title:"Document export", t4Text:"Structured, readable, shareable documentary protocol (no experimental parameters).",

    /* App blocs */
    s1Title:"CONTEXT & COMPLIANCE", s1Sub:"Professional use only",
    s1Check:"I confirm I am a qualified professional and rely on validated internal SOPs.",
    s2Title:"PARAMETERS & TECHNIQUES", s2Sub:"Scientific context",
    techTitle:"DOWNSTREAM TECHNIQUES",
    tClarif:"Clarification", tCapture:"Capture (affinity / AEX)", tPolishing:"Polishing", tTFF:"TFF (Concentration / Diafiltration)", tQC:"Quality controls (attributes)", tForm:"Formulation / Documentation",
    searchTitle:"LITERATURE SEARCH",
    labVector:"Vector", labSerotype:"Serotype", labCellLine:"Cell line", labKeywords:"Additional keywords",
    labYears:"Recency (years)", labMax:"Max articles", labOA:"Open access only (full text)", btnSearch:"Run search",
    s3Title:"LITERATURE RESULTS",
    s4Title:"AI ANALYSIS", s4Sub:"Selected articles", s4Text:"Select at least 1 article and run the analysis. Automatic summary (Hugging Face).",
    btnAnalyze:"Analyze", btnContinue:"Continue",
    s5Title:"PREVIEW & PDF EXPORT", s5Sub:"Documentary protocol", btnPdf:"Export PDF",
    safety:"Note: literature-based documentary output. No experimental parameters.",

    /* Contact */
    cTitle:"GET IN TOUCH", cSub:"Let's discuss your project", cLead:"Our expert scientists can help accelerate your process development (adenoviral vectors, purification, analytics, documentation).",
    cName:"Name", cOrg:"Company", cMsg:"Message", cSend:"Send email", cLinkedIn:"LinkedIn",

    /* Footer */
    fMenu:"MENU", fHint:"Use the top-right button to open the menu.",
    fLegal:"LEGAL", fSocial:"SOCIAL", fContact:"CONTACT", fMentions:"Imprint", fPrivacy:"Privacy", fCookies:"Cookies", fCity:"Brussels — Belgium",
    fFoot:"Europe PMC / PubMed — Hugging Face (optional). No experimental instructions.",

    /* Dynamics */
    d_searching:"Searching…", d_open:"Open", d_noSel:"No selection.", d_ai:"AI analysis…", d_none:"(none)",
    d_alert_compliance:"Please confirm compliance.", d_alert_need1:"Select at least 1 article.", d_alert_needTech:"Select at least one technique.", d_nofile:"No file."
  }
};
function lang(){return document.documentElement.dataset.lang||'fr';}
function t(k){const L=I[lang()]||I.fr;return (L&&L[k])||(I.fr[k]||k);}
function setLang(newLang){
  document.documentElement.setAttribute('lang', newLang); document.documentElement.dataset.lang=newLang;
  for(const el of document.querySelectorAll('[data-i]')){const v=t(el.dataset.i); if(/<br\s*\/?>|&nbsp;/.test(v)) el.innerHTML=v; else el.textContent=v;}
  document.getElementById('year').textContent=new Date().getFullYear();
}
window.addEventListener('DOMContentLoaded', () => {
  const btnFR=document.getElementById('btnFR'), btnEN=document.getElementById('btnEN');
  btnFR.onclick=()=>{setLang('fr');btnFR.classList.add('active');btnEN.classList.remove('active');};
  btnEN.onclick=()=>{setLang('en');btnEN.classList.add('active');btnFR.classList.remove('active');};
  setLang('fr'); document.getElementById('year').textContent=new Date().getFullYear();
});

/* =================== Accordéon & navigation inter-blocs =================== */
for(const blk of document.querySelectorAll('.block')){
  const head=blk.querySelector('header');
  head.addEventListener('click', (e)=>{
    if(e.target.closest('button[data-open]')) return;
    blk.classList.toggle('open');
  });
}
for(const btn of document.querySelectorAll('button[data-open]')){
  btn.addEventListener('click', ()=>{
    const sel = btn.getAttribute('data-open');
    const target = document.querySelector(sel);
    if(target){ target.classList.add('open'); target.scrollIntoView({behavior:'smooth',block:'center'}); }
  });
}

/* =================== App State & utils =================== */
const state={ vector:"",serotype:"",cellLine:"",techniques:[],yearsWindow:2,retMax:10,onlyOA:true,articles:[],abstracts:{},fulltexts:{},aiText:"",citations:[], uploads:[] };
const REDACT=/\b\d+(?:[\.,]\d+)?\s?(?:mL|ml|L|µL|uL|°C|C|rpm|g|xg|min|h|hours?|days?|M|mM|µM|uM|%|nm|mm|cm|kDa)\b/gi;
function sanitize(txt){return (txt||"").replace(REDACT,"[…]");}
function esc(s){return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}

/* =================== Europe PMC Search (proxy anti-CORS) =================== */
document.getElementById('runSearch').onclick=runSearchEPMC;
async function runSearchEPMC(){
  if(!document.getElementById('compliance').checked){ alert(t('d_alert_compliance')); return; }
  state.vector=document.getElementById('vector').value.trim()||'adenovirus';
  state.serotype=document.getElementById('serotype').value.trim();
  state.cellLine=document.getElementById('cellLine').value.trim();
  const extra=(document.getElementById('keywords').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  state.yearsWindow=+document.getElementById('yearsWindow').value||2;
  state.retMax=+document.getElementById('retMax').value||10;
  state.onlyOA=document.getElementById('onlyOA').checked;

  const minYear=(new Date().getFullYear()-state.yearsWindow);
  const terms=[state.vector,state.serotype,state.cellLine,...extra].filter(Boolean).join(' ');
  let q = `${terms} AND PUB_YEAR:[${minYear} TO 3000] AND HAS_ABSTRACT:Y`; if(state.onlyOA) q+=` AND OPEN_ACCESS:Y`;

  const base = `https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(q)}&pageSize=${state.retMax}&format=json&sort_date:y`;
  const url  = `https://api.allorigins.win/get?url=${encodeURIComponent(base)}`;

  const info=document.getElementById('searchInfo'); info.textContent=t('d_searching');
  try{
    const r=await fetch(url); const raw=await r.json(); const j=JSON.parse(raw.contents);
    const res=(j.resultList?.result)||[];
    state.articles = res.map(x=>{
      const id = x.pmid ? x.pmid : x.pmcid; const src = x.pmid ? 'MED' : 'PMC';
      return { id, src, pmid:x.pmid||'', doi:x.doi||'', title:x.title||'', source:x.journalTitle||x.source||'', year:x.pubYear||'', authors:(x.authorString||'').split(', ').slice(0,6), oa:(x.isOpenAccess==="Y"||x.openAccess=="Y"||x.openAccess), selected:false, hasAbstractInline:!!x.abstractText, abstractInline:x.abstractText||'' };
    });
    renderResults();
    info.textContent = `${state.articles.length} ${lang()==='fr'?'résultat(s)':'result(s)'}`;
    document.querySelector('#blk3').classList.add('open');
    document.querySelector('#blk3').scrollIntoView({behavior:'smooth',block:'center'});
  }catch(e){
    console.error(e);
    document.getElementById('results').innerHTML='<div class="pub-card">Europe PMC error.</div>';
    info.textContent='';
  }
}
function renderResults(){
  const box=document.getElementById('results'); box.innerHTML='';
  state.articles.forEach((a,idx)=>{
    const el=document.createElement('div'); el.className='pub-card';
    const link = a.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/` : `https://europepmc.org/article/${a.src}/${a.id}`;
    el.innerHTML=`
      <label style="display:flex;gap:10px;align-items:flex-start">
        <input type="checkbox" data-id="${a.id}" style="width:auto;margin-top:4px">
        <div>
          <div><strong>${esc(a.title)}</strong> ${a.oa?'<span class="tag">Open Access</span>':''}</div>
          <div class="muted">${esc(a.source)} · ${esc(a.year||'—')}</div>
          <div class="muted">${esc(a.authors.join(', '))}</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <span class="tag">${a.src}:${a.id}${a.pmid?` · PMID:${a.pmid}`:''}${a.doi?` · DOI:${a.doi}`:''}</span>
            <a class="tag" href="${link}" target="_blank" rel="noopener noreferrer">${t('d_open')}</a>
          </div>
          <div id="abs-${idx}" class="muted" style="margin-top:6px;font-size:13px"></div>
          ${a.oa?`<button class="btn secondary" data-full="${idx}" style="margin-top:8px">${lang()==='fr'?'Charger le texte intégral':'Load full text'}</button>`:''}
        </div>
      </label>`;
    el.querySelector('input').addEventListener('change',e=>{a.selected=e.target.checked; updateSelectionInfo();});
    box.appendChild(el);

    const absEl=el.querySelector(`#abs-${idx}`);
    if(a.abstractInline){absEl.textContent = a.abstractInline;}
    else if(a.pmid){
      fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/MED/${a.pmid}/abstractText?format=plain`).then(r=>r.text()).then(t=>absEl.textContent=t).catch(()=>{});
    }

    const btn=el.querySelector(`[data-full="${idx}"]`);
    if(btn){
      btn.onclick=async()=>{
        btn.disabled=true;
        const url=`https://www.ebi.ac.uk/europepmc/webservices/rest/${a.src}/${a.id}/fullTextXML`;
        try{
          const r=await fetch(url); const xml=await r.text();
          state.fulltexts[a.id]=xml;
          btn.textContent=lang()==='fr'?'Texte intégral chargé':'Full text loaded';
        }catch(e){btn.disabled=false;btn.textContent='Retry';}
      };
    }
  });
  updateSelectionInfo();
}
function updateSelectionInfo(){
  const n=state.articles.filter(a=>a.selected).length;
  const txt = `${n} ${lang()==='fr'?'sélectionné(s) — min: 1':'selected — min: 1'}`;
  const selInfo=document.getElementById('selInfo'); if(selInfo) selInfo.textContent=txt;
  const L=document.getElementById('selectedList'); if(!L) return;
  const chosen=state.articles.filter(a=>a.selected);
  L.innerHTML = chosen.length
    ? chosen.map(a=>`<div class="pub-card"><strong>${esc(a.title)}</strong><div class="muted">${esc(a.source)} · ${esc(a.year||'—')} — ${a.src}:${a.id}${a.doi?` — DOI:${a.doi}`:''}</div></div>`).join('')
    : `<div class="pub-card muted">${t('d_noSel')}</div>`;
}

/* =================== IA (Hugging Face) — Résumé articles =================== */
document.getElementById('analyzeBtn').onclick=analyzeSelected;
async function analyzeSelected(){
  const chosen=state.articles.filter(a=>a.selected);
  if(chosen.length<1){alert(t('d_alert_need1'));return;}
  const techs=[...document.querySelectorAll('.tech:checked')].map(x=>x.value);
  if(!techs.length){alert(t('d_alert_needTech'));return;}

  const HF_TOKEN = "hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; // Replace if you use HF
  const HF_MODEL = "facebook/bart-large-cnn";

  document.getElementById('selInfo').textContent=t('d_ai');

  const docs = [];
  for(const a of chosen.slice(0,8)){
    let text="";
    if(state.fulltexts[a.id]) text = extractTextFromFullTextXML(state.fulltexts[a.id]);
    else{
      const abs = a.abstractInline || await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/${a.src}/${a.id}/abstractText?format=plain`).then(r=>r.text()).catch(()=> '');
      text = abs;
    }
    text = (text||"").replace(/\s+/g,' ').slice(0, 4000);
    docs.push({ meta:a, text });
  }

  const summaries=[];
  for(const d of docs){
    try{
      const response = await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`,{
        headers:{Authorization:`Bearer ${HF_TOKEN}`,"Content-Type":"application/json"},
        method:"POST", body: JSON.stringify({ inputs: d.text })
      });
      const result = await response.json();
      const summary = (Array.isArray(result) && result[0]?.summary_text) ? result[0].summary_text : "(summary unavailable)";
      summaries.push({ meta:d.meta, summary });
    }catch(e){ console.error("HF error", e); }
  }

  const langNow=lang();
  let body = (langNow==='fr'?`## Synthèse interprétée (documentaire)\n`:`## Interpreted synthesis (documentary)\n`);
  body += (langNow==='fr'
    ? `Demande: vecteur=${document.getElementById('vector').value||'Adenovirus'}; sérotype=${document.getElementById('serotype').value||''}; lignée=${document.getElementById('cellLine').value||''}; techniques=${techs.join(', ')}.\n\n`
    : `Request: vector=${document.getElementById('vector').value||'Adenovirus'}; serotype=${document.getElementById('serotype').value||''}; cell line=${document.getElementById('cellLine').value||''}; techniques=${techs.join(', ')}.\n\n`);

  body += (langNow==='fr'?`### Articles analysés\n`:`### Analyzed articles\n`);
  summaries.forEach((s,i)=>{
    body += `**[${i+1}] ${s.meta.title}** (${s.meta.year}, ${s.meta.source}) — ${sanitize(s.summary)}\n\n`;
  });

  body += (langNow==='fr'
    ? `### Proposition documentaire (non-opérationnelle)\nSynthèse des pratiques : amont cellulaire, récolte & clarification, capture (affinité/AEX), TFF, polishing, contrôles qualité. Paramètres opératoires volontairement absents.\n\n`
    : `### Documentary proposal (non-operational)\nPractices synthesized: upstream cell production, harvest & clarification, capture (affinity/AEX), TFF, polishing, quality controls. Operational parameters intentionally omitted.\n\n`);

  state.aiText = body;
  state.citations = summaries.map((s,i)=>({
    n:i+1,title:s.meta.title,year:s.meta.year,source:s.meta.source,
    pmid:s.meta.pmid,doi:s.meta.doi,
    url: s.meta.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${s.meta.pmid}/` : `https://europepmc.org/article/${s.meta.src}/${s.meta.id}`
  }));

  renderPreview();
  const b=document.querySelector('#blk5'); b.classList.add('open'); b.scrollIntoView({behavior:'smooth',block:'center'});
}

/* =================== Fulltext XML → text =================== */
function extractTextFromFullTextXML(xmlString){
  const parser=new DOMParser();
  let text=''; try{
    const xml=parser.parseFromString(xmlString,'text/xml');
    const wanted=['materials','methods','materials and methods','results','discussion','introduction','conclusion'];
    const secs=[...xml.querySelectorAll('sec')];
    for(const s of secs){
      const title=(s.querySelector('title')?.textContent||'').toLowerCase();
      if(wanted.some(w=>title.includes(w))){
        const ps=[...s.querySelectorAll('p')].map(p=>p.textContent.trim()).join('\n');
        text += (title?(`\n\n### ${title}\n`):'\n\n') + ps;
      }
    }
    if(!text){ text = [...xml.querySelectorAll('p')].map(p=>p.textContent.trim()).join('\n'); }
  }catch(e){}
  return text;
}

/* =================== Upload local (PDF/DOCX/TXT) =================== */
const drop = document.getElementById('drop');
const input = document.getElementById('fileInput');
const list = document.getElementById('filesList');
drop.addEventListener('click', (e) => {
  e.preventDefault();
  input.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
});
drop.addEventListener('dragover',(e)=>{e.preventDefault();drop.classList.add('drag');});
drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
drop.addEventListener('drop',(e)=>{e.preventDefault();drop.classList.remove('drag');handleFiles(e.dataTransfer.files);});
input.addEventListener('change',(e)=>handleFiles(e.target.files));
function handleFiles(files){
  state.uploads=[...files];
  list.innerHTML='';
  state.uploads.forEach(f=>{
    const item=document.createElement('div'); item.className='file-item';
    item.textContent = `${f.name} — ${(f.size/1024/1024).toFixed(2)} MB`;
    list.appendChild(item);
  });
}
document.getElementById('runLocal').onclick = runLocalAnalysis;

async function runLocalAnalysis(){
  if(!state.uploads.length){ alert(t('d_nofile')); return; }
  const HF_TOKEN = "hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; // <-- optionnel
  const HF_MODEL = "facebook/bart-large-cnn";
  let combinedText="";
  for(const f of state.uploads){
    const ext = f.name.toLowerCase().split('.').pop();
    const buf = await f.arrayBuffer();
    let text="";
    if(ext==='pdf'){
      const pdfjsLib=window['pdfjsLib'];
      pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const pdf=await pdfjsLib.getDocument({data:buf}).promise;
      for(let i=1;i<=pdf.numPages;i++){ const page=await pdf.getPage(i); const content=await page.getTextContent(); text += content.items.map(it=>it.str).join(' ') + ' '; }
    }else if(ext==='docx'){
      const res=await window.mammoth.extractRawText({arrayBuffer:buf}); text=res.value;
    }else if(ext==='txt'){
      text = new TextDecoder().decode(new Uint8Array(buf));
    }
    combinedText += '\n\n' + (text||'');
  }

  async function hf(prompt){
    const resp=await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`,{
      method:'POST', headers:{Authorization:`Bearer ${HF_TOKEN}`,'Content-Type':'application/json'},
      body:JSON.stringify({inputs: prompt})
    });
    const j=await resp.json();
    return Array.isArray(j)&&j[0]?.summary_text? j[0].summary_text : (lang()==='fr'?'(résumé non disponible)':'(summary unavailable)');
  }

  const isEN = (lang()==='en');
  const extractPrompt = isEN
    ? `Identify and extract sentences describing materials, reagents, buffers, cell lines, purification steps (chromatography, capture, TFF, polishing), and QC analytics.\nText:\n${combinedText.slice(0,6000)}`
    : `Identifie et extrais les phrases décrivant matériaux, réactifs, tampons, lignées, étapes de purification (chromatographie, capture, TFF, polishing) et contrôles qualité.\nTexte :\n${combinedText.slice(0,6000)}`;

  const summaryPrompt = isEN
    ? `Summarize the document in one concise page (≈300 words) focused on process development and purification methodology.\nText:\n${combinedText.slice(0,7000)}`
    : `Résume le document en une page concise (≈300 mots) axée sur le développement procédé et la méthodologie de purification.\nTexte :\n${combinedText.slice(0,7000)}`;

  const methodText  = HF_TOKEN.startsWith('hf_') ? await hf(extractPrompt)  : (isEN?'(AI not configured)':'(IA non configurée)');
  const summaryText = HF_TOKEN.startsWith('hf_') ? await hf(summaryPrompt) : (isEN?'(AI not configured)':'(IA non configurée)');

  const header1 = isEN ? '## Extracted Methodological Sections' : '## Sections méthodologiques extraites';
  const header2 = isEN ? '## One-page Summary' : '## Résumé d’une page';

  state.aiText = `${header1}\n${sanitize(methodText)}\n\n${header2}\n${sanitize(summaryText)}\n\n` + (state.aiText||'');
  renderPreview();
  const b=document.querySelector('#blk5'); b.classList.add('open'); b.scrollIntoView({behavior:'smooth',block:'center'});
}

/* =================== Preview & PDF =================== */
function renderPreview(){
  const langNow=lang();
  const meta=[
    document.getElementById('vector').value?`${langNow==='fr'?'Vecteur':'Vector'} : ${document.getElementById('vector').value}`:null,
    document.getElementById('serotype').value?`${langNow==='fr'?'Sérotype':'Serotype'} : ${document.getElementById('serotype').value}`:null,
    document.getElementById('cellLine').value?`${langNow==='fr'?'Lignée cellulaire':'Cell line'} : ${document.getElementById('cellLine').value}`:null
  ].filter(Boolean).join('\n');

  const foot = (state.citations||[]).map(c=>`[${c.n}] ${c.title} (${c.year}), ${c.source}${c.doi?` — DOI:${c.doi}`:''}${c.pmid?` — PMID:${c.pmid}`:''} — ${c.url}`).join('\n');
  const doc = `${langNow==='fr'
  ? `# Protocole documentaire — Purification Adénovirus\n\n${meta}\n\n## Résumé & méthode\nRevue Europe PMC (abstracts + OA). Synthèse IA (si configurée). Aucune instruction expérimentale.\n`
  : `# Documentary protocol — Adenovirus purification\n\n${meta}\n\n## Summary & method\nEurope PMC review (abstracts + OA). AI synthesis (if configured). No experimental instructions.\n`}

${state.aiText||''}

${langNow==='fr'?'## Références (notes de bas de page)':'## References (footnotes)'}
${foot||'(none)'}
`;
  document.getElementById('preview').textContent=doc;
}
document.getElementById('exportPdf').onclick=exportPDF;

async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt',format:'a4'});
  const M=56, W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();

  pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F');

  try{
    const res=await fetch('./assets/montes-biopharma-logo.svg'); const blob=await res.blob();
    const data=await blobToDataURL(blob);
    pdf.addImage(data,'PNG',M,M-8,160,40,'','FAST');
  }catch(e){}

  setText(pdf,'#3A49FF',18,'bold');
  const langNow=lang();
  pdf.text(langNow==='fr'?'Protocole documentaire — Purification Adénovirus':'Documentary protocol — Adenovirus purification', M+180, M+14);
  setText(pdf,'#333333',11,'normal');

  pdf.setDrawColor(58,73,255); pdf.setLineWidth(2); pdf.line(M, M+50, W-M, M+50);

  let y=M+74;
  const content=document.getElementById('preview').textContent||'';
  const lines=content.split('\n');
  for(const raw of lines){
    const line=raw.trim();
    if(!line){ y+=6; continue; }
    if(line.startsWith('# ')){ y=putHeading(pdf,line.replace(/^#\s+/,'').trim(),y,16,'#3A49FF',M,W,H); }
    else if(line.startsWith('## ')){ y=putHeading(pdf,line.replace(/^##\s+/,'').trim(),y,13,'#3A49FF',M,W,H); }
    else if(line.startsWith('### ')){ y=putHeading(pdf,line.replace(/^###\s+/,'').trim(),y,12,'#3A49FF',M,W,H); }
    else { y=putParagraph(pdf,line,y,M,W,H,11); }
  }
  pdf.save(langNow==='fr'?'protocole-documentaire-adenovirus.pdf':'documentary-protocol-adenovirus.pdf');
}
function setText(pdf,hex,size,weight){const [r,g,b]=hexToRGB(hex); pdf.setTextColor(r,g,b); pdf.setFont('helvetica', weight==='bold'?'bold':'normal'); pdf.setFontSize(size);}
function putHeading(pdf,text,y,size,color,M,W,H){
  if(y + size + 18 > H - M){ pdf.addPage(); pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F'); y=M; }
  setText(pdf,color,size,'bold'); pdf.text(text,M,y); y += size<14?12:16;
  pdf.setDrawColor(210,210,210); pdf.setLineWidth(.6); pdf.line(M,y,W-M,y);
  return y+12;
}
function putParagraph(pdf,text,y,M,W,H,size=11){
  setText(pdf,'#000000',size,'normal');
  const safe=(text||'').replace(REDACT,"[…]");
  const chunks=pdf.splitTextToSize(safe,W-2*M);
  for(const ln of chunks){
    if(y > H - M){ pdf.addPage(); pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F'); y=M; }
    pdf.text(ln,M,y); y += 14;
  }
  return y+4;
}
function hexToRGB(hex){const h=hex.replace('#','');const n=parseInt(h,16);return [(n>>16)&255,(n>>8)&255,n&255];}
function blobToDataURL(blob){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(blob);});}
</script>
</body>
</html>
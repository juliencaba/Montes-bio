<!doctype html>
<html lang="fr" data-lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Montes BioPharma — Assistant Littérature</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<meta name="color-scheme" content="light"/>

<!-- Libs pour extraction & PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

<style>
:root{
  --bg:#F6F7FB;
  --panel:#FFFFFF;
  --ink:#3A49FF;       /* bleu principal (texte + menu + titres) */
  --primary:#3A49FF;   /* même bleu uniforme */
  --muted:#6C7392;
  --accent:#00FF6A;    /* vert fluo */
  --border:#E6E9F4;
  --radius:18px;
  --shadow:0 10px 30px rgba(15,18,38,.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:Outfit,system-ui,-apple-system,"Segoe UI",Ubuntu,Arial,sans-serif;
}
a{color:var(--primary);text-decoration:none}
a:hover{text-decoration:underline}
img{display:block;max-width:100%}

/* Header */
header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid var(--border)}
.nav{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;gap:14px}
.logo{height:40px;width:auto}
.brand{font-weight:800;letter-spacing:.02em}
.lang{margin-left:auto;display:flex;gap:8px;align-items:center}
.lang .btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600}
.lang .btn.active{border-color:var(--primary);}

/* Hamburger + drawer */
#navToggle{display:none}
.hamburger{appearance:none;display:inline-flex;align-items:center;gap:10px;border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:12px;cursor:pointer}
.hamburger .bars{position:relative;width:18px;height:12px}
.hamburger .bars::before,.hamburger .bars::after,.hamburger .bar{content:"";position:absolute;left:0;right:0;height:2px;background:var(--ink);border-radius:2px}
.hamburger .bars::before{top:0}
.hamburger .bar{top:5px}
.hamburger .bars::after{bottom:0}

.drawer-overlay{position:fixed;inset:0;background:rgba(5,8,20,.38);backdrop-filter:blur(1px);z-index:80;opacity:0;pointer-events:none;transition:opacity .25s ease}
.drawer{
  position:fixed;top:0;right:0;height:100%;width:min(86vw,360px);
  transform:translateX(100%);transition:transform .28s ease;
  background:var(--ink);color:#fff;z-index:90;display:flex;flex-direction:column;
}
#navToggle:checked ~ .drawer-overlay{opacity:1;pointer-events:auto}
#navToggle:checked ~ .drawer{transform:translateX(0)}
.drawer header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.18)}
.drawer .title{font-weight:800;letter-spacing:.04em}
.drawer .close{appearance:none;border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.drawer .body{padding:14px 18px;display:grid;gap:12px}
.drawer .link{
  display:flex;align-items:center;gap:10px;padding:14px 12px;border-radius:12px;
  border:1px solid #fff;background:#fff;
  text-transform:uppercase;font-weight:800;letter-spacing:.06em;
  color:var(--accent); /* texte vert fluo */
}
.drawer .link:hover{filter:brightness(.95)}

/* Views */
.view{display:none}
.view.active{display:block}

/* Intro */
.hero{max-width:1200px;margin:0 auto;padding:44px 20px 8px}
.kicker{color:var(--accent);font-weight:800;letter-spacing:.28em;font-size:13px;text-transform:uppercase}
h1.hero-title{margin:10px 0 10px;font-size:clamp(36px,6vw,64px);line-height:1.04;color:var(--primary);text-transform:uppercase;font-weight:800}
.hero-sub{color:var(--muted);font-size:18px;max-width:820px}
.cta{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px}
.btn{appearance:none;cursor:pointer;border-radius:999px;padding:14px 22px;font-weight:700;border:2px solid transparent}
.btn.primary{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
.btn.ghost{background:#fff;color:var(--primary);border-color:var(--primary)}

.section{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:22px 20px 10px}
.tiles{display:grid;gap:16px}
@media(min-width:880px){.tiles{grid-template-columns:repeat(4,1fr)}}
.tile{
  background:linear-gradient(180deg,#F8F9FF,#EEF1FF);
  border:1px solid #E0E5FF;border-radius:18px;padding:18px;
  box-shadow:0 12px 24px rgba(58,73,255,.08);
}
.tile .badge{display:inline-block;font-size:12px;padding:4px 10px;border-radius:999px;background:#fff;border:1px solid #D7DEFF;color:var(--primary);font-weight:800;letter-spacing:.04em}
.tile h3{margin:10px 0 6px;color:#0F1226}
.tile p{margin:0;color:var(--muted);font-size:14px}

/* Blocks */
.block{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.block header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#fff,#FBFCFF)}
.block header .overline{color:var(--accent);font-weight:800;letter-spacing:.18em;font-size:11px}
.block header h2{margin:2px 0 0;font-size:22px;color:var(--primary);text-transform:uppercase;letter-spacing:.02em}
.block .inner{padding:18px 20px}
.muted{color:var(--muted)}
hr.sep{border:none;border-top:1px solid var(--border);margin:14px 0}

/* Layout app */
.hide{display:none!important}
.grid{display:grid;gap:12px}
@media(min-width:900px){
  .grid-2{grid-template-columns:1.1fr 1fr}
}

#app .app-step{display:none}
#app .app-step.active{display:block}

/* Upload zone */
.drop{
  display:grid;place-items:center;text-align:center;gap:8px;
  padding:22px;border:2px dashed var(--border);border-radius:12px;background:#fff;
}
.drop.drag{border-color:var(--primary)}
.file-list{display:grid;gap:8px;margin-top:10px}
.file-item{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px;font-size:14px}

/* Workspace */
.workspace{display:grid;gap:16px}
@media(min-width:1100px){.workspace{grid-template-columns:320px 1fr}}
.sidebar{border:1px solid var(--border);border-radius:16px;background:#fff;padding:12px;height:100%}
.sidebar h4{margin:6px 0 10px;color:var(--primary)}
.source-item{border:1px solid var(--border);border-radius:12px;padding:8px 10px;display:flex;align-items:flex-start;gap:8px;font-size:14px;margin-bottom:6px}
.source-item input{width:auto;margin-top:3px}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:13px;cursor:pointer}
.chip.active{border-color:var(--primary);box-shadow:0 2px 10px rgba(58,73,255,.16)}

.mainpanel{display:grid;gap:12px}
.panel{border:1px solid var(--border);border-radius:16px;background:#fff;padding:16px}
.panel h3{margin:0 0 8px;color:var(--primary)}
.result-card{border:1px solid var(--border);border-radius:16px;background:#fff;padding:12px;box-shadow:0 6px 16px rgba(15,18,38,.04);margin-top:8px}
.result-meta{color:var(--muted);font-size:13px}
.bar{height:6px;border-radius:6px;background:#EEF1FF;overflow:hidden;margin-top:6px}
.bar span{display:block;height:100%;background:var(--primary)}

.snip{font-size:13px;line-height:1.4;background:#FBFCFF;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:8px}
.snip .meta{color:var(--muted);font-size:11px;margin-bottom:4px}
.snip mark{background:#FFF59D;border-radius:4px;padding:0 2px}

/* Protocole */
pre#protocolOutput{
  white-space:pre-wrap;
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  color:#000; /* texte protocole en noir */
  font-size:13px;
}

/* Footer */
footer{background:#fff;border-top:1px solid var(--border);margin-top:36px}
footer .inner{max-width:1200px;margin:0 auto;padding:20px;color:var(--muted);display:flex;justify-content:space-between;gap:10px;font-size:13px;flex-wrap:wrap}
</style>
</head>
<body>

<!-- Drawer + overlay -->
<input type="checkbox" id="navToggle" aria-hidden="true"/>
<label class="drawer-overlay" for="navToggle" aria-hidden="true"></label>

<aside class="drawer" role="dialog" aria-modal="true" aria-label="Menu">
  <header>
    <div class="title" data-i="menu">Menu</div>
    <label class="close" for="navToggle" data-i="close">Fermer</label>
  </header>
  <div class="body">
    <a class="link menu-link" href="#intro" data-i="navIntro">Introduction</a>
    <a class="link menu-link" href="#app" data-i="navApp">Application</a>
    <a class="link menu-link" href="#contact" data-i="navContact">Contact</a>
    <div style="opacity:.8;margin-top:6px">© <span id="year2"></span> Montes BioPharma</div>
  </div>
</aside>

<header>
  <div class="nav">
    <picture>
      <source srcset="./assets/montes-biopharma-logo.svg" type="image/svg+xml">
      <img src="./assets/montes-biopharma-logo.jpg" alt="Montes BioPharma" class="logo" width="160" height="40">
    </picture>
    <div class="brand" data-i="brand">Montes BioPharma</div>

    <div class="lang">
      <label class="hamburger" for="navToggle">
        <span class="bars" aria-hidden="true"><span class="bar"></span></span>
        <span data-i="menu">Menu</span>
      </label>
      <button id="btnFR" class="btn active">FR</button>
      <button id="btnEN" class="btn">EN</button>
    </div>
  </div>
</header>

<main>
  <!-- INTRO -->
  <section id="intro" class="view active">
    <section class="hero">
      <div class="kicker" data-i="kicker">ASSISTANT LITTÉRATURE</div>
      <h1 class="hero-title" data-i="heroTitle">No learning curve,<br/>no complications</h1>
      <p class="hero-sub" data-i="heroSub">
        Analyse de documents internes (SOP, protocoles, rapports, articles) et génération de protocoles documentaires adénovirus, à partir de vos propres contenus.
      </p>
      <div class="cta">
        <label class="btn primary" for="navToggle" data-i="ctaOpenMenu">Ouvrir le menu</label>
        <a class="btn ghost" href="#app" data-i="ctaOpenLearn">Aller vers l’application</a>
      </div>
    </section>

    <section class="section">
      <div class="tiles">
        <div class="tile">
          <span class="badge" data-i="t1Badge">Upload</span>
          <h3 data-i="t1Title">Documents internes</h3>
          <p data-i="t1Text">PDF, DOCX, TXT — extraction locale. Aucune donnée envoyée côté serveur applicatif.</p>
        </div>
        <div class="tile">
          <span class="badge">R&D</span>
          <h3 data-i="t2Title">Analyse ciblée</h3>
          <p data-i="t2Text">Détection automatique des sections pertinentes selon les sous-domaines choisis.</p>
        </div>
        <div class="tile">
          <span class="badge">AI-like</span>
          <h3 data-i="t3Title">Synthèse structurée</h3>
          <p data-i="t3Text">Résumé par sous-domaine, sans paramètres expérimentaux, pour un usage documentaire.</p>
        </div>
        <div class="tile">
          <span class="badge">PDF</span>
          <h3 data-i="t4Title">Protocole exportable</h3>
          <p data-i="t4Text">Génération d’un protocole documentaire structuré et export PDF.</p>
        </div>
      </div>
    </section>
  </section>

  <!-- APPLICATION -->
  <section id="app" class="view">
    <section class="section">
      <div class="block">
        <header>
          <div>
            <div class="overline" data-i="overlineApp">ANALYSE DE LA DEMANDE</div>
            <h2 data-i="appTitle">Votre besoin</h2>
          </div>
          <button class="btn ghost" id="resetApp" data-ai="reset">Réinitialiser</button>
        </header>
        <div class="inner">
          <!-- STEP 1 : Questionnaire -->
          <div id="step1" class="app-step active">
            <p class="muted" data-ai="appLead">Choisissez votre biomolécule, votre domaine pharmaceutique et les sous-domaines d’intérêt.</p>
            <div class="grid">
              <div>
                <label data-ai="q1">Quelle biomolécule voulez-vous produire ?</label>
                <select id="bioSelect">
                  <option value="" selected disabled data-ai="selectPlaceholder">— Sélectionner —</option>
                  <option value="Adenovirus">Adénovirus</option>
                </select>
              </div>
              <div id="domainWrap" class="hide">
                <label data-ai="q2">Quel est le domaine du pharmaceutique que vous souhaitez explorer ?</label>
                <select id="domainSelect"></select>
              </div>
              <div id="subdomainWrap" class="hide">
                <label id="subdomainTitle" data-ai="detailTitleGeneric">Spécifiez votre besoin</label>
                <div id="subdomainChoices" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))"></div>
              </div>
              <div id="confirmWrap" class="hide">
                <div class="panel" style="border:1px dashed var(--border)">
                  <p id="confirmText" class="muted"></p>
                </div>
                <div class="cta" style="margin-top:8px">
                  <button class="btn primary" id="goStep2" data-ai="goNext">Passer à la suite</button>
                </div>
              </div>
            </div>
          </div>

          <!-- STEP 2 : Sources (Docs internes + PubMed) -->
          <div id="step2" class="app-step">
            <div class="grid grid-2">
              <div>
                <p class="muted" data-ai="qDocs">Avez-vous des documents internes sur lesquels je peux me baser pour concevoir la méthode ?</p>
                <div class="cta">
                  <button class="btn secondary" id="btnDocYes" data-ai="yes">Oui</button>
                  <button class="btn secondary" id="btnDocNo" data-ai="no">Non</button>
                </div>
                <div id="uploaderWrap" class="hide" style="margin-top:12px">
                  <div id="drop" class="drop">
                    <div>
                      <strong data-ai="dropTitle">Déposez vos fichiers ici</strong>
                      <div class="muted" data-ai="dropHint">ou cliquez pour sélectionner</div>
                      <small data-ai="dropTypes">Acceptés : PDF, DOCX, TXT</small>
                    </div>
                    <input id="fileInput" type="file" multiple accept=".pdf,.docx,.txt" style="display:none">
                  </div>
                  <div class="file-list" id="filesList"></div>
                </div>
              </div>

              <div>
                <p class="muted" data-ai="onlineIntro">Inclure une recherche **PubMed / Europe PMC** ciblée selon vos choix (adenovirus + sous-domaines). Les abstracts seront analysés localement et fusionnés avec vos documents.</p>
                <label style="display:flex;gap:10px;align-items:center;margin:8px 0">
                  <input type="checkbox" id="usePubMed" style="width:auto">
                  <span data-ai="usePubMed">Inclure PubMed / Europe PMC</span>
                </label>
                <div id="pmcQueryPreview" class="muted" style="font-size:12px"></div>
                <div class="cta" style="margin-top:10px">
                  <button class="btn primary" id="runAnalysis" data-ai="runAnalysis">Lancer l’analyse</button>
                  <button class="btn ghost" id="backStep1" data-ai="back">Retour</button>
                </div>
              </div>
            </div>
          </div>

          <!-- STEP 3 : Workspace -->
          <div id="step3" class="app-step">
            <div class="workspace">
              <aside class="sidebar">
                <h4 data-ai="internalSources">Documents internes</h4>
                <div id="docList"></div>
                <hr class="sep">
                <h4 data-ai="activeSubdomains">Sous-domaines actifs</h4>
                <div id="sdChips" class="chips"></div>
              </aside>

              <div class="mainpanel">
                <div class="panel">
                  <h3 data-ai="overview">Vue d’ensemble</h3>
                  <div id="overview"></div>
                </div>

                <div id="sdResults"></div>

                <div class="panel">
                  <h3 data-ai="toProtocolTitle">Protocole documentaire</h3>
                  <p class="muted" data-ai="protoHint">Sur base des sections identifiées (internes + PubMed), l’outil produit un protocole de type documentaire (R&D, non-opérationnel).</p>
                  <div class="cta" style="margin-top:8px">
                    <button class="btn primary" id="goStep4" data-ai="toProtocol">Créer le protocole</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- STEP 4 : Protocole -->
          <div id="step4" class="app-step">
            <div class="panel">
              <h3 data-ai="protoTitle">Protocole documentaire</h3>
              <p class="muted" data-ai="protoNote">Document de synthèse basé sur vos documents internes, la littérature PubMed/Europe PMC et les sous-domaines sélectionnés. Aucun paramètre expérimental n’est garanti exploitable tel quel en laboratoire.</p>
              <div class="cta" style="margin:10px 0">
                <button class="btn primary" id="regenerateProtocol" data-ai="generateProto">Régénérer</button>
                <button class="btn ghost" id="exportProtoPdf" data-ai="exportProtoPdf">Exporter en PDF</button>
              </div>
              <pre id="protocolOutput"></pre>
            </div>
          </div>

        </div>
      </div>
    </section>
  </section>

  <!-- CONTACT -->
  <section id="contact" class="view">
    <section class="section">
      <div class="block">
        <header>
          <div>
            <div class="overline" data-i="overlineContact">PRISE DE CONTACT</div>
            <h2 data-i="contactTitle">Discutons de votre projet</h2>
          </div>
        </header>
        <div class="inner">
          <p class="muted" data-i="contactIntro">
            Nos scientifiques experts peuvent vous aider à structurer vos procédés adénovirus (downstream, upstream, analytique, qualité) à partir de vos documents internes et de la littérature.
          </p>
          <hr class="sep">
          <p class="muted">info@montes-biopharma.com</p>
        </div>
      </div>
    </section>
  </section>
</main>

<footer>
  <div class="inner">
    <div>© <span id="year"></span> Montes BioPharma</div>
    <div data-i="footerNote">Preuve de concept R&D — analyse documentaire. Aucun conseil expérimental ni valeur opératoire.</div>
  </div>
</footer>

<script>
/* ===== Routing simple (Intro / App / Contact) ===== */
const views = { intro:document.getElementById('intro'), app:document.getElementById('app'), contact:document.getElementById('contact') };
const navToggle = document.getElementById('navToggle');
function showView(id){ Object.values(views).forEach(v=>v.classList.remove('active')); (views[id]||views.intro).classList.add('active'); if(navToggle.checked) navToggle.checked=false; }
function route(){ const id=(location.hash||'#intro').replace('#',''); showView(id||'intro'); }
window.addEventListener('hashchange', route);
document.querySelectorAll('.menu-link').forEach(a=>a.addEventListener('click',()=>{ if(navToggle.checked) navToggle.checked=false; }));

/* ===== i18n global ===== */
const I = {
  fr:{brand:"Montes BioPharma",menu:"Menu",close:"Fermer",navIntro:"Introduction",navApp:"Application",navContact:"Contact",
      kicker:"ASSISTANT LITTÉRATURE",heroTitle:"No learning curve,<br/>no complications",
      heroSub:"Analyse de documents internes (SOP, protocoles, rapports, articles) et génération de protocoles documentaires adénovirus, à partir de vos propres contenus.",
      ctaOpenMenu:"Ouvrir le menu",ctaOpenLearn:"Aller vers l’application",
      t1Badge:"Upload",t1Title:"Documents internes",t1Text:"PDF, DOCX, TXT — extraction locale. Aucune donnée envoyée côté serveur applicatif.",
      t2Title:"Analyse ciblée",t2Text:"Détection automatique des sections pertinentes selon les sous-domaines choisis.",
      t3Title:"Synthèse structurée",t3Text:"Résumé par sous-domaine, sans paramètres expérimentaux, pour un usage documentaire.",
      t4Title:"Protocole exportable",t4Text:"Génération d’un protocole documentaire structuré et export PDF.",
      overlineApp:"ANALYSE DE LA DEMANDE",appTitle:"Votre besoin",
      overlineContact:"PRISE DE CONTACT",contactTitle:"Discutons de votre projet",
      contactIntro:"Nos scientifiques experts peuvent vous aider à structurer vos procédés adénovirus (downstream, upstream, analytique, qualité) à partir de vos documents internes et de la littérature.",
      footerNote:"Preuve de concept R&D — analyse documentaire. Aucun conseil expérimental ni valeur opératoire."},
  en:{brand:"Montes BioPharma",menu:"Menu",close:"Close",navIntro:"Introduction",navApp:"Application",navContact:"Contact",
      kicker:"LITERATURE ASSISTANT",heroTitle:"No learning curve,<br/>no complications",
      heroSub:"Analysis of internal documents (SOPs, protocols, reports, articles) and generation of documentary adenovirus protocols, based on your own content.",
      ctaOpenMenu:"Open menu",ctaOpenLearn:"Go to the app",
      t1Badge:"Upload",t1Title:"Internal documents",t1Text:"PDF, DOCX, TXT — local extraction. No data sent to the app server.",
      t2Title:"Targeted analysis",t2Text:"Automatic detection of relevant sections according to selected subdomains.",
      t3Title:"Structured synthesis",t3Text:"Per-subdomain summaries without experimental parameters, for documentary use.",
      t4Title:"Exportable protocol",t4Text:"Generation of a structured documentary protocol and PDF export.",
      overlineApp:"REQUEST ANALYSIS",appTitle:"Your need",
      overlineContact:"GET IN TOUCH",contactTitle:"Let's discuss your project",
      contactIntro:"Our expert scientists can help structure your adenovirus processes (downstream, upstream, analytics, quality) based on your internal documents and literature.",
      footerNote:"R&D proof of concept — documentary analysis. No experimental advice or operating values."}
};
const APP_I = {
  fr:{reset:"Réinitialiser",appLead:"Choisissez votre biomolécule, votre domaine pharmaceutique et les sous-domaines d’intérêt.",
      q1:"Quelle biomolécule voulez-vous produire ?",selectPlaceholder:"— Sélectionner —",
      q2:"Quel est le domaine du pharmaceutique que vous souhaitez explorer ?",detailTitleGeneric:"Spécifiez votre besoin",
      dom_upstream:"Upstream",dom_downstream:"Downstream",dom_fill:"Fill & Finish",dom_analytics:"Analytique",dom_qa:"Assurance Qualité",dom_cmc:"CMC",
      sdtitle_downstream:"Spécifiez les sous-domaines Downstream",sdtitle_upstream:"Spécifiez les sous-domaines Upstream",
      sdtitle_fill:"Spécifiez les sous-domaines Fill & Finish",sdtitle_analytics:"Spécifiez les sous-domaines Analytique",
      sdtitle_qa:"Spécifiez les sous-domaines Assurance Qualité",sdtitle_cmc:"Spécifiez les sous-domaines CMC",
      goNext:"Passer à la suite",
      qDocs:"Avez-vous des documents internes sur lesquels je peux me baser pour concevoir la méthode ?",yes:"Oui",no:"Non",
      dropTitle:"Déposez vos fichiers ici",dropHint:"ou cliquez pour sélectionner",dropTypes:"Acceptés : PDF, DOCX, TXT",
      onlineIntro:"Inclure une recherche **PubMed / Europe PMC** ciblée selon vos choix (adenovirus + sous-domaines). Les abstracts seront analysés localement et fusionnés avec vos documents.",
      usePubMed:"Inclure PubMed / Europe PMC",
      runAnalysis:"Lancer l’analyse",back:"Retour",
      internalSources:"Documents internes",activeSubdomains:"Sous-domaines actifs",overview:"Vue d’ensemble",
      toProtocolTitle:"Protocole documentaire",protoHint:"Sur base des sections identifiées (internes + PubMed), l’outil produit un protocole de type documentaire (R&D, non-opérationnel).",
      toProtocol:"Créer le protocole",protoTitle:"Protocole documentaire",
      protoNote:"Document de synthèse basé sur vos documents internes, la littérature PubMed/Europe PMC et les sous-domaines sélectionnés. Aucun paramètre expérimental n’est garanti exploitable tel quel en laboratoire.",
      generateProto:"Régénérer",exportProtoPdf:"Exporter en PDF",
      searching:"Analyse en cours…",needDocs:"Veuillez charger au moins un document.",
      needSubdomains:"Veuillez sélectionner au moins un sous-domaine dans l’étape 1.",
      ctx:"Contexte",biomolecule:"Biomolécule",domain:"Domaine",docsInternal:"Documents internes",noActiveSD:"Aucun sous-domaine actif.",
      score:"score",summaryTitle:"Résumé ciblé (~1 page)",
      literature:"Littérature (PubMed / Europe PMC)",
      internal:"Documents internes",
      pdfTitle:"Protocole documentaire — Analyse ciblée",pdfOverview:"Vue d’ensemble",pdfSections:"Sections par sous-domaine"},
  en:{reset:"Reset",appLead:"Choose your biomolecule, your pharmaceutical domain and relevant subdomains.",
      q1:"Which biomolecule do you want to produce?",selectPlaceholder:"— Select —",
      q2:"Which pharmaceutical domain do you want to explore?",detailTitleGeneric:"Specify your need",
      dom_upstream:"Upstream",dom_downstream:"Downstream",dom_fill:"Fill & Finish",dom_analytics:"Analytical",dom_qa:"Quality Assurance",dom_cmc:"CMC",
      sdtitle_downstream:"Specify Downstream subdomains",sdtitle_upstream:"Specify Upstream subdomains",
      sdtitle_fill:"Specify Fill & Finish subdomains",sdtitle_analytics:"Specify Analytical subdomains",
      sdtitle_qa:"Specify QA subdomains",sdtitle_cmc:"Specify CMC subdomains",
      goNext:"Continue",
      qDocs:"Do you have internal documents I can use to design the method?",yes:"Yes",no:"No",
      dropTitle:"Drop your files here",dropHint:"or click to select",dropTypes:"Accepted: PDF, DOCX, TXT",
      onlineIntro:"Include a **PubMed / Europe PMC** search targeted to your choices (adenovirus + subdomains). Abstracts will be analyzed locally and merged with your documents.",
      usePubMed:"Include PubMed / Europe PMC",
      runAnalysis:"Run analysis",back:"Back",
      internalSources:"Internal documents",activeSubdomains:"Active subdomains",overview:"Overview",
      toProtocolTitle:"Documentary protocol",protoHint:"Using the identified sections (internal + PubMed), the tool produces a documentary-style protocol (R&D, non-operational).",
      toProtocol:"Create protocol",protoTitle:"Documentary protocol",
      protoNote:"Summary document based on your internal documents, PubMed/Europe PMC literature and selected subdomains. No experimental parameter is guaranteed usable as such in the lab.",
      generateProto:"Regenerate",exportProtoPdf:"Export PDF",
      searching:"Analyzing…",needDocs:"Please upload at least one document.",
      needSubdomains:"Please select at least one subdomain in step 1.",
      ctx:"Context",biomolecule:"Biomolecule",domain:"Domain",docsInternal:"Internal documents",noActiveSD:"No active subdomains.",
      score:"score",summaryTitle:"Targeted summary (~1 page)",
      literature:"Literature (PubMed / Europe PMC)",
      internal:"Internal documents",
      pdfTitle:"Documentary protocol — Targeted analysis",pdfOverview:"Overview",pdfSections:"Sections by subdomain"}
};

function currentLang(){ return document.documentElement.dataset.lang || 'fr'; }
function t(k){ const L=I[currentLang()]||I.fr; return L[k] || I.fr[k] || k; }
function ta(k){ const L=APP_I[currentLang()]||APP_I.fr; return L[k] || APP_I.fr[k] || k; }
function applyTranslations(){
  document.querySelectorAll('[data-i]').forEach(el=>{const v=t(el.dataset.i); if(/<br\s*\/?>/.test(v)) el.innerHTML=v; else el.textContent=v;});
  document.querySelectorAll('[data-ai]').forEach(el=>{const v=ta(el.dataset.ai); if(/<br\s*\/?>/.test(v)) el.innerHTML=v; else el.textContent=v;});
}
function setLang(lang){ document.documentElement.setAttribute('lang',lang); document.documentElement.dataset.lang=lang; applyTranslations(); }
const btnFR=document.getElementById('btnFR'), btnEN=document.getElementById('btnEN');
btnFR.addEventListener('click',()=>{btnFR.classList.add('active');btnEN.classList.remove('active');setLang('fr');});
btnEN.addEventListener('click',()=>{btnEN.classList.add('active');btnFR.classList.remove('active');setLang('en');});

/* Year */
document.getElementById('year').textContent=new Date().getFullYear();
document.getElementById('year2').textContent=new Date().getFullYear();

/* ===== Questionnaire & sous-domaines ===== */
const bioSelect = document.getElementById('bioSelect');
const domainWrap = document.getElementById('domainWrap');
const domainSelect = document.getElementById('domainSelect');
const subdomainWrap = document.getElementById('subdomainWrap');
const subdomainTitle = document.getElementById('subdomainTitle');
const subdomainChoices = document.getElementById('subdomainChoices');
const confirmWrap = document.getElementById('confirmWrap');
const confirmText = document.getElementById('confirmText');
const goStep2 = document.getElementById('goStep2');

const SUBDOMAINS = {
  downstream:[
    {id:"clarification", fr:"Clarification", en:"Clarification"},
    {id:"tff_df", fr:"Concentration et Diafiltration (TFF)", en:"Concentration and Diafiltration (TFF)"},
    {id:"capture_chrom", fr:"Capture par chromatographie", en:"Capture by chromatography"},
    {id:"polishing", fr:"Polishing", en:"Polishing"},
    {id:"formulation", fr:"Formulation", en:"Formulation"},
    {id:"final_filtration", fr:"Filtration finale", en:"Final Filtration"}
  ],
  upstream:[
    {id:"cell_bank_seed", fr:"Banque cellulaire & Seed train", en:"Cell bank & seed train"},
    {id:"production_bioreactor", fr:"Bioréacteur de production", en:"Production bioreactor"},
    {id:"infection_strategy", fr:"Stratégie d’infection/MOI", en:"Infection/MOI strategy"},
    {id:"harvest_lysis", fr:"Récolte / Lyse", en:"Harvest / Lysis"},
    {id:"ipc", fr:"Contrôles en cours de procédé (IPC)", en:"In-process controls (IPC)"},
    {id:"handoff_ds", fr:"Handoff vers Downstream", en:"Handoff to Downstream"}
  ],
  fill:[
    {id:"hold_bulk", fr:"Hold bulk & cycles freeze/thaw", en:"Hold bulk & freeze/thaw cycles"},
    {id:"aseptic_fill", fr:"Remplissage aseptique", en:"Aseptic filling"},
    {id:"ccc", fr:"Système contenant/fermeture", en:"Container/closure system"},
    {id:"fit", fr:"Tests d’intégrité filtres", en:"Filter integrity tests"},
    {id:"vi_aql", fr:"Inspection visuelle / AQL", en:"Visual inspection / AQL"},
    {id:"cold_chain", fr:"Chaîne du froid & étiquetage", en:"Cold chain & labelling"}
  ],
  analytics:[
    {id:"identity", fr:"Identité", en:"Identity"},
    {id:"potency", fr:"Puissance", en:"Potency"},
    {id:"impurities", fr:"Impuretés", en:"Impurities"},
    {id:"size_agg", fr:"Taille / agrégation", en:"Size / aggregation"},
    {id:"qPCR", fr:"Dosage (qPCR/ddPCR)", en:"Assay (qPCR/ddPCR)"},
    {id:"stability_indic", fr:"Méthodes indicatrices de stabilité", en:"Stability-indicating methods"}
  ],
  qa:[
    {id:"change_control", fr:"Change control", en:"Change control"},
    {id:"deviation_capa", fr:"Déviations & CAPA", en:"Deviations & CAPA"},
    {id:"training_qual", fr:"Qualification & formation", en:"Qualification & training"},
    {id:"gxp_docs", fr:"Gestion documentaire GxP", en:"GxP document control"},
    {id:"suppliers", fr:"Qualification fournisseurs & matières", en:"Supplier & material qualification"},
    {id:"bmr", fr:"Revue des dossiers de lot", en:"Batch record review"}
  ],
  cmc:[
    {id:"reg_strategy", fr:"Stratégie réglementaire", en:"Regulatory strategy"},
    {id:"control_strategy", fr:"Control strategy", en:"Control strategy"},
    {id:"specs_release", fr:"Spécifications & libération", en:"Specifications & release"},
    {id:"comparability", fr:"Comparabilité", en:"Comparability"},
    {id:"ppq", fr:"Validation / PPQ", en:"Validation / PPQ"},
    {id:"proc_char", fr:"Caractérisation procédé", en:"Process characterization"}
  ]
};

const state = {
  request:{ biomolecule:null, domain:null, subdomains:[] },
  uploads:[],     // {file, name, text}
  analysis:{},    // par sous-domaine: {docs:[], lit:[], summary:''}
  protocol:"",
  literatureRaw:[] // résultats EPMC bruts
};

function renderDomainOptions(){
  domainSelect.innerHTML='';
  const placeholder = document.createElement('option');
  placeholder.disabled=true; placeholder.selected=true; placeholder.textContent = ta('selectPlaceholder'); placeholder.value="";
  domainSelect.appendChild(placeholder);
  const opts = [
    {key:'upstream', label:ta('dom_upstream')},
    {key:'downstream', label:ta('dom_downstream')},
    {key:'fill', label:ta('dom_fill')},
    {key:'analytics', label:ta('dom_analytics')},
    {key:'qa', label:ta('dom_qa')},
    {key:'cmc', label:ta('dom_cmc')}
  ];
  opts.forEach(o=>{const opt=document.createElement('option'); opt.value=o.key; opt.textContent=o.label; domainSelect.appendChild(opt);});
}
function labelDomain(key){
  const map={upstream:'dom_upstream',downstream:'dom_downstream',fill:'dom_fill',analytics:'dom_analytics',qa:'dom_qa',cmc:'dom_cmc'};
  const tkey=map[key]; return tkey?ta(tkey):key;
}
bioSelect.addEventListener('change',()=>{ state.request.biomolecule=bioSelect.value||null; domainWrap.classList.remove('hide'); });

domainSelect.addEventListener('change',()=>{
  const dom=domainSelect.value||null; state.request.domain=dom; buildSubdomains(dom); updateEpmcQueryPreview();
});
function buildSubdomains(domainKey){
  const list=SUBDOMAINS[domainKey]||[]; subdomainChoices.innerHTML=''; state.request.subdomains=[]; subdomainWrap.classList.remove('hide'); confirmWrap.classList.add('hide');
  subdomainTitle.textContent = ta('sdtitle_'+domainKey) || ta('detailTitleGeneric');
  list.forEach(item=>{
    const lbl = currentLang()==='fr'?item.fr:item.en;
    const row=document.createElement('label'); row.className='source-item';
    row.innerHTML=`<input type="checkbox" data-id="${item.id}" style="width:auto"><span>${lbl}</span>`;
    const cb=row.querySelector('input');
    cb.addEventListener('change',()=>{
      const ids=[...subdomainChoices.querySelectorAll('input:checked')].map(x=>x.dataset.id); state.request.subdomains=ids; updateEpmcQueryPreview();
      if(ids.length){
        const names = ids.map(id=>{for(const arr of Object.values(SUBDOMAINS)){const f=arr.find(z=>z.id===id);if(f)return currentLang()==='fr'?f.fr:f.en;}return id;});
        const fr=`Parfait. Vous avez choisi : biomolécule = ${state.request.biomolecule}; domaine = ${labelDomain(state.request.domain)}; sous-domaines = ${names.join(', ')}. Ces choix seront utilisés pour cibler les documents.`;
        const en=`Great. You selected: biomolecule = ${state.request.biomolecule}; domain = ${labelDomain(state.request.domain)}; subdomains = ${names.join(', ')}. These choices will be used to target the documents.`;
        confirmText.textContent=currentLang()==='fr'?fr:en; confirmWrap.classList.remove('hide');
      }else{ confirmWrap.classList.add('hide'); }
    });
    subdomainChoices.appendChild(row);
  });
}

/* ===== Steps ===== */
const step1=document.getElementById('step1'), step2=document.getElementById('step2'), step3=document.getElementById('step3'), step4=document.getElementById('step4');
function setStep(n){ [step1,step2,step3,step4].forEach(s=>s.classList.remove('active')); (n===1?step1:n===2?step2:n===3?step3:step4).classList.add('active'); window.scrollTo({top:0,behavior:'auto'}); }
const goStep2Btn=document.getElementById('goStep2'); goStep2Btn.addEventListener('click',()=>{ if(!state.request.biomolecule||!state.request.domain||!state.request.subdomains.length){alert(ta('needSubdomains'));return;} setStep(2); });

/* ===== Upload ===== */
const btnDocYes=document.getElementById('btnDocYes'), btnDocNo=document.getElementById('btnDocNo'), uploaderWrap=document.getElementById('uploaderWrap');
const drop=document.getElementById('drop'), fileInput=document.getElementById('fileInput'), filesList=document.getElementById('filesList');
btnDocYes.addEventListener('click',()=>uploaderWrap.classList.remove('hide'));
btnDocNo.addEventListener('click',()=>{uploaderWrap.classList.add('hide');state.uploads=[];filesList.innerHTML='';});
drop.addEventListener('click',()=>fileInput.click());
drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('drag');});
drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('drag');handleFiles(e.dataTransfer.files);});
fileInput.addEventListener('change',e=>handleFiles(e.target.files));
function handleFiles(files){
  state.uploads=[]; filesList.innerHTML='';
  [...files].forEach(f=>{ state.uploads.push({file:f,name:f.name,text:null});
    const item=document.createElement('div'); item.className='file-item'; item.textContent=`${f.name} — ${(f.size/1024/1024).toFixed(2)} MB`; filesList.appendChild(item);
  });
}

/* ===== Extraction texte locale ===== */
const REDACT=/\b\d+(?:[\.,]\d+)?\s?(mL|ml|L|µL|uL|°C|C|rpm|g|xg|min|h|hours?|days?|M|mM|µM|uM|%|nm|mm|cm|kDa|CFU|pfu|TCID50)\b/gi;
function sanitizeText(txt){return (txt||"").replace(REDACT,"[…]");}
async function extractTextFromFile(entry){
  if(entry.text){return entry.text;}
  const f=entry.file; const buf=await f.arrayBuffer(); const ext=f.name.toLowerCase().split('.').pop(); let out='';
  if(ext==='pdf'){
    const pdfjsLib=window['pdfjsLib']; pdfjsLib.GlobalWorkerOptions=pdfjsLib.GlobalWorkerOptions||{};
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    for(let i=1;i<=pdf.numPages;i++){const page=await pdf.getPage(i);const content=await page.getTextContent();out+=' [[PAGE:'+i+']] '+content.items.map(it=>it.str).join(' ')+'\n';}
  }else if(ext==='docx'){
    const res=await window.mammoth.extractRawText({arrayBuffer:buf}); out=res.value||'';
  }else{
    out=new TextDecoder().decode(new Uint8Array(buf));
  }
  entry.text=out.replace(/\s+/g,' ').trim(); return entry.text;
}

/* ===== Profils & scoring avancé ===== */
const ADV_TERMS=[/adenovirus|adeno[-\s]?virus|Ad5|Ad26|viral\s(vector|particle|dose|load|titer)|virion/i];
function cfg(must2,should=[],neg=[]){return {must:[must2],should,neg};}
const PATTERNS={
  formulation: cfg(/formulat|drug\s?product|final\s(formulat|buffer)|storage\s(buffer|cond)/i,
    [[/trehalose|sucrose|histidine|citrate|polysorbate|tween|NaCl|MgCl2|osmolar|tonicit|stability|freeze[-\s]?thaw|shelf[-\s]?life|vials?/i,1.2]],
    [/DNase\s?buffer|lysis\s?buffer|extraction\s?buffer|PCR\s?buffer|running\s?buffer|elution\s?buffer/i]
  ),
  clarification: cfg(/clarifi|depth\s?filter|centrifug|harvest/i, [[/turbidit|floccul/i,1.1]], []),
  tff_df: cfg(/diafiltrat|ultra?filtrat|tff|membrane/i, [[/buffer\s?exchange/i,1.1]], []),
  capture_chrom: cfg(/chromatograph|column|resin|ligand/i, [[/anion\s?exchange|AEX|heparin/i,1.1]], []),
  polishing: cfg(/polish|ion\s?exchange|multimodal|SEC|size\s?exclusion/i, [[/aggregate|HCP|DNA/i,1.0]], []),
  final_filtration: cfg(/final\s?filtrat|steril(e|ity)\s?filter|0[.,]2\s?µ?m/i, [[/bioburden|sterility/i,1.0]], []),
  // Upstream & autres (résumé)
  production_bioreactor: cfg(/bioreactor|reactor|perfusion|culture\s?vessel/i, [], []),
  infection_strategy: cfg(/infection|infect|MOI|multiplicity of infection/i, [], [])
};

/* Mesure distance (en mots) entre termes virus et termes domaine */
function tokenDistance(text, groupA, groupB){
  const words=text.split(/\s+/); const idxsA=[], idxsB=[];
  words.forEach((w,i)=>{const W=w.toLowerCase(); if(groupA.some(rx=>rx.test(W))) idxsA.push(i); if(groupB.some(rx=>rx.test(W))) idxsB.push(i);});
  let best=Infinity; idxsA.forEach(a=>idxsB.forEach(b=>{const d=Math.abs(a-b); if(d<best) best=d;}));
  return isFinite(best)?best:9999;
}

function windowsFromText(text, win=900, overlap=250){
  const clean=(text||'').replace(/\s+/g,' ');
  const out=[]; let i=0; const step=Math.max(64,win-overlap);
  while(i<clean.length){ const slice=clean.slice(i,i+win); out.push({start:i,end:i+win,text:sanitizeText(slice)}); i+=step; }
  return out;
}

function highlight(html, patterns){
  if(!patterns.length) return html;
  const rx=new RegExp('('+patterns.join('|')+')','gi'); return html.replace(rx, m=>`<mark>${m}</mark>`);
}

function scoreWindow(win, profile){
  const txt=win.text;
  // must for domain
  if(!profile.must.some(rx=>rx.test(txt))) return 0;
  // must for product context: at least one ADV term near domain terms
  const dist = tokenDistance(txt, ADV_TERMS, profile.must);
  if(dist>40) return 0.1; // trop loin → faible
  let s = dist<=12 ? 1.6 : dist<=24 ? 1.2 : 0.8;
  // should bonuses
  for(const [rx,w] of (profile.should||[])){ if(rx.test(txt)) s+=w; }
  // negatives
  for(const ex of (profile.neg||[])){ if(ex.test(txt)) s-=1.2; }
  return Math.max(0, +s.toFixed(2));
}

/* ===== PubMed / Europe PMC ===== */
const usePubMed = document.getElementById('usePubMed');
const pmcQueryPreview = document.getElementById('pmcQueryPreview');

function epmcQueryFromSelection(){
  const terms=['adenovirus'];
  const dom=state.request.domain, sds=state.request.subdomains||[];
  const map={
    formulation:['formulation','"drug product"','stability','"freeze-thaw"','excipient','buffer'],
    clarification:['clarification','"depth filter"','centrifugation'],
    tff_df:['TFF','diafiltration','ultrafiltration','membrane','"buffer exchange"'],
    capture_chrom:['chromatography','column','resin','ligand','AEX','"anion exchange"'],
    polishing:['polishing','"ion exchange"','SEC','"size exclusion"','aggregate'],
    final_filtration:['"final filtration"','sterility','"0.2 µm"','bioburden'],
    production_bioreactor:['bioreactor','perfusion','culture'],
    infection_strategy:['infection','MOI']
  };
  const bag=new Set();
  sds.forEach(id=>(map[id]||[]).forEach(x=>bag.add(x)));
  const add=[...bag];
  const query = ['adenovirus', ...(add.length?['AND', '('+add.join(' OR ')+')']:[])].join(' ');
  return query;
}
function updateEpmcQueryPreview(){
  if(!usePubMed.checked){ pmcQueryPreview.textContent=''; return; }
  const q=epmcQueryFromSelection();
  const lang=currentLang();
  pmcQueryPreview.innerHTML = (lang==='fr'?'Requête Europe PMC: ':'Europe PMC query: ') + `<code>${q}</code>`;
}

usePubMed.addEventListener('change', updateEpmcQueryPreview);

/* Récup Europe PMC (supports CORS) */
async function fetchEpmc(query, pageSize=12){
  const url=`https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(query)}&pageSize=${pageSize}&format=json&sort_date:y`;
  const r=await fetch(url); const j=await r.json();
  const res=(j.resultList&&j.resultList.result)||[];
  return res.map(x=>({
    title:x.title||'',
    source:x.journalTitle||x.source||'',
    year:x.pubYear||'',
    pmid:x.pmid||'',
    pmcid:x.pmcid||'',
    doi:x.doi||'',
    abstract:x.abstractText||'',
    isOA:(x.isOpenAccess==="Y"||x.openAccess==="Y"||x.openAccess===true),
    link: x.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${x.pmid}/` : (x.pmcid ? `https://europepmc.org/article/PMC/${x.pmcid}` : (x.doi ? `https://doi.org/${x.doi}` : ''))
  }));
}

/* ===== Analyse orchestrée (docs internes + PubMed) ===== */
const runAnalysisBtn=document.getElementById('runAnalysis'), backStep1=document.getElementById('backStep1');
runAnalysisBtn.addEventListener('click', async ()=>{
  if(!state.request.subdomains.length){ alert(ta('needSubdomains')); return; }
  if(!state.uploads.length && !usePubMed.checked){ alert(ta('needDocs')); return; }
  runAnalysisBtn.disabled=true; runAnalysisBtn.textContent=ta('searching');

  // 1) Extraction texte interne
  for(const doc of state.uploads){ await extractTextFromFile(doc); }

  // 2) Optionnel : Europe PMC
  state.literatureRaw=[];
  if(usePubMed.checked){
    const q=epmcQueryFromSelection(); updateEpmcQueryPreview();
    try{ state.literatureRaw = await fetchEpmc(q, 12); }catch(e){ console.warn('EPMC failed',e); state.literatureRaw=[]; }
  }

  // 3) Analyse combinée
  await targetedAnalyze(); // alimente state.analysis (docs + literature)
  buildWorkspace();

  runAnalysisBtn.disabled=false; runAnalysisBtn.textContent=ta('runAnalysis');
  setStep(3);
});
backStep1.addEventListener('click',()=>setStep(1));

/* Analyse ciblée alimentée par PATTERNS + distance + négatifs */
function windowsFromAbstract(abs){ return windowsFromText(abs||'', 700, 200); }

async function targetedAnalyze(){
  state.analysis={};
  const ids=state.request.subdomains||[];
  const docs=state.uploads;

  for(const sdId of ids){
    const profile=PATTERNS[sdId]; const pack={labelFR:'',labelEN:'',docs:[],lit:[],summary:''};
    // labels
    for(const arr of Object.values(SUBDOMAINS)){ const f=arr.find(z=>z.id===sdId); if(f){pack.labelFR=f.fr; pack.labelEN=f.en; break;} }

    // A) Docs internes
    for(const d of docs){
      if(!d.text) continue;
      const wins=windowsFromText(d.text, 900, 250);
      const scored=wins.map(w=>({text:w.text,score:profile?scoreWindow(w,profile):0}))
                       .filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,6);
      if(scored.length){
        const docScore=scored.slice(0,3).reduce((a,c)=>a+c.score,0)/Math.min(3,scored.length);
        pack.docs.push({
          name:d.name, score:+docScore.toFixed(2),
          snippets: scored.map(s=>({
            score:+s.score.toFixed(2),
            html: highlight(s.text, buildHighlightSet(profile))
          }))
        });
      }
    }

    // B) Littérature (Europe PMC abstracts)
    if(state.literatureRaw.length && profile){
      const relevant=[];
      for(const art of state.literatureRaw){
        const wins=windowsFromAbstract(art.abstract||'');
        const best=wins.map(w=>({text:w.text,score:scoreWindow(w,profile)}))
                       .filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,3);
        if(best.length){
          relevant.push({
            title:art.title, meta:`${art.source||''} · ${art.year||''}`, link:art.link||'#',
            score:+(best.reduce((a,c)=>a+c.score,0)/best.length).toFixed(2),
            snippets: best.map(s=>({
              score:+s.score.toFixed(2),
              html: highlight(s.text, buildHighlightSet(profile))
            }))
          });
        }
      }
      // top par article
      relevant.sort((a,b)=>b.score-a.score);
      pack.lit = relevant.slice(0,6);
    }

    // C) Résumé ciblé simple (fusion internes + lit)
    const allText = [
      ...pack.docs.flatMap(d=>d.snippets.slice(0,2).map(s=>s.html.replace(/<[^>]+>/g,' '))),
      ...pack.lit.flatMap(d=>d.snippets.slice(0,2).map(s=>s.html.replace(/<[^>]+>/g,' ')))
    ].join(' ');
    const sentences = sanitizeText(allText).split(/[\.\!\?]\s+/).filter(x=>x.length>40).slice(0,10);
    pack.summary = sentences.join('. ') + (sentences.length?'.':'');
    state.analysis[sdId]=pack;
  }
}

function buildHighlightSet(profile){
  const arr = [];
  (profile.must||[]).forEach(rx=>arr.push(rx.source));
  (profile.should||[]).forEach(([rx])=>arr.push(rx.source));
  ADV_TERMS.forEach(rx=>arr.push(rx.source));
  return arr.filter(Boolean);
}

/* ===== Workspace rendering ===== */
const docList=document.getElementById('docList'), sdChips=document.getElementById('sdChips'), overview=document.getElementById('overview'), sdResults=document.getElementById('sdResults'), goStep4=document.getElementById('goStep4');

function buildWorkspace(){
  // documents
  docList.innerHTML='';
  state.uploads.forEach(d=>{ const row=document.createElement('div'); row.className='source-item'; row.innerHTML=`<input type="checkbox" checked style="width:auto"><span>${d.name}</span>`; docList.appendChild(row); });

  // chips
  sdChips.innerHTML='';
  const ids=state.request.subdomains||[];
  ids.forEach(id=>{
    const chip=document.createElement('button'); chip.className='chip active'; chip.dataset.id=id;
    const label=(()=>{for(const arr of Object.values(SUBDOMAINS)){const f=arr.find(z=>z.id===id); if(f) return currentLang()==='fr'?f.fr:f.en;} return id;})();
    chip.textContent=label;
    chip.addEventListener('click',()=>{chip.classList.toggle('active'); renderSdResults();});
    sdChips.appendChild(chip);
  });

  overview.innerHTML = `
    <div class="result-card">
      <div><strong>${ta('ctx')}</strong></div>
      <div class="result-meta">${ta('biomolecule')}: ${state.request.biomolecule||'-'} · ${ta('domain')}: ${labelDomain(state.request.domain||'')}</div>
      <div class="result-meta">${ta('docsInternal')}: ${state.uploads.length}</div>
    </div>
  `;
  renderSdResults();
}

function renderSdResults(){
  sdResults.innerHTML='';
  const active=[...sdChips.querySelectorAll('.chip.active')].map(c=>c.dataset.id);
  if(!active.length){ sdResults.innerHTML=`<p class="muted">${ta('noActiveSD')}</p>`; return; }
  active.forEach(id=>{
    const pack=state.analysis[id]; if(!pack) return;
    const title=currentLang()==='fr'?(pack.labelFR||id):(pack.labelEN||id);
    const sec=document.createElement('section'); sec.className='panel'; sec.innerHTML=`<h3>${title}</h3>`;

    // Bloc documents internes
    const cardInt=document.createElement('div'); cardInt.className='result-card';
    cardInt.innerHTML = `<div><strong>${ta('internal')}</strong></div>` + ((pack.docs||[]).length? '' : `<div class="muted">—</div>`);
    (pack.docs||[]).forEach(d=>{
      const box=document.createElement('div'); box.className='snip';
      box.innerHTML = `<div class="meta">${d.name} — ${ta('score')} ${d.score}</div>` + d.snippets.map(s=>`<div class="snip" style="margin-top:8px"><div class="meta">${ta('score')} ${s.score}</div><div>${s.html}</div></div>`).join('');
      cardInt.appendChild(box);
    });
    sec.appendChild(cardInt);

    // Bloc littérature PubMed
    const cardLit=document.createElement('div'); cardLit.className='result-card';
    cardLit.innerHTML = `<div><strong>${ta('literature')}</strong></div>` + ((pack.lit||[]).length? '' : `<div class="muted">—</div>`);
    (pack.lit||[]).forEach(d=>{
      const box=document.createElement('div'); box.className='snip';
      const meta = `<a href="${d.link||'#'}" target="_blank" rel="noopener">${d.title||'—'}</a> <span class="meta">— ${d.meta||''} — ${ta('score')} ${d.score}</span>`;
      box.innerHTML = `<div class="meta">${meta}</div>` + d.snippets.map(s=>`<div class="snip" style="margin-top:8px"><div class="meta">${ta('score')} ${s.score}</div><div>${s.html}</div></div>`).join('');
      cardLit.appendChild(box);
    });
    sec.appendChild(cardLit);

    // Résumé
    const sum=document.createElement('div'); sum.className='result-card';
    sum.innerHTML=`<div><strong>${ta('summaryTitle')}</strong></div><div class="snip"><div>${pack.summary||'(empty)'}</div></div>`;
    sec.appendChild(sum);

    sdResults.appendChild(sec);
  });
}

/* ===== Protocole ===== */
const protocolOutput=document.getElementById('protocolOutput'); const regenerateProtocol=document.getElementById('regenerateProtocol'); const exportProtoPdf=document.getElementById('exportProtoPdf');
function buildProtocolText(){
  const Lfr=currentLang()==='fr'; const lines=[];
  lines.push('# '+ta('protoTitle')); lines.push('');
  lines.push(`${ta('biomolecule')}: ${state.request.biomolecule||'-'}`); lines.push(`${ta('domain')}: ${labelDomain(state.request.domain||'')}`); lines.push('');
  lines.push(Lfr?'> Document **non-opérationnel** à visée documentaire, basé sur vos documents internes et la littérature PubMed/Europe PMC sélectionnée.':'> **Non-operational** documentary document, based on your internal documents and selected PubMed/Europe PMC literature.');
  lines.push(''); lines.push('## '+ta('pdfOverview'));
  lines.push(Lfr?'Ce protocole documentaire synthétise les informations structurantes extraites de vos documents internes et de la littérature pour les sous-domaines sélectionnés.':'This documentary protocol synthesizes structural information extracted from your internal documents and literature for the selected subdomains.');
  lines.push(''); lines.push('## '+ta('pdfSections'));
  for(const id of (state.request.subdomains||[])){
    const pack=state.analysis[id]; if(!pack) continue;
    const title=currentLang()==='fr'?(pack.labelFR||id):(pack.labelEN||id);
    lines.push(''); lines.push('### '+title); lines.push('');
    if(pack.summary){ lines.push(Lfr?'**Synthèse ciblée :**':'**Targeted synthesis:**'); lines.push(pack.summary); lines.push(''); }
    const keyInt=(pack.docs||[]).flatMap(d=>d.snippets.slice(0,1).map(s=>s.html.replace(/<[^>]+>/g,' '))).slice(0,3);
    const keyLit=(pack.lit||[]).flatMap(d=>d.snippets.slice(0,1).map(s=>s.html.replace(/<[^>]+>/g,' '))).slice(0,3);
    if(keyInt.length){ lines.push(Lfr?'**Points-clés issus des documents internes :**':'**Key points from internal documents:**'); keyInt.forEach(k=>lines.push('- '+sanitizeText(k))); lines.push(''); }
    if(keyLit.length){ lines.push(Lfr?'**Points-clés issus de la littérature :**':'**Key points from literature:**'); keyLit.forEach(k=>lines.push('- '+sanitizeText(k))); lines.push(''); }
  }
  return lines.join('\n');
}
function refreshProtocol(){ state.protocol=buildProtocolText(); protocolOutput.textContent=state.protocol; }
regenerateProtocol.addEventListener('click', refreshProtocol);
document.getElementById('goStep4').addEventListener('click',()=>{ refreshProtocol(); setStep(4); });

/* ===== Export PDF ===== */
exportProtoPdf.addEventListener('click',()=>{
  const { jsPDF } = window.jspdf; const pdf=new jsPDF({unit:'pt',format:'a4'});
  const M=56, W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();
  pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F');
  (async ()=>{
    try{const res=await fetch('./assets/montes-biopharma-logo.jpg'); const blob=await res.blob(); const data=await new Promise((res2,rej)=>{const fr=new FileReader();fr.onload=()=>res2(fr.result);fr.onerror=rej;fr.readAsDataURL(blob);}); pdf.addImage(data,'JPEG',M,M-8,160,40,'','FAST');}catch(e){}
    pdf.setTextColor(13,42,90); pdf.setFont('helvetica','bold'); pdf.setFontSize(18);
    pdf.text(ta('pdfTitle'), M+180, M+14); pdf.setDrawColor(13,42,90); pdf.setLineWidth(2); pdf.line(M,M+50,W-M,M+50);
    let y=M+74; const content=(state.protocol||buildProtocolText()).split('\n');
    const putHeading=(text,size)=>{ if(y+size+18>H-M){pdf.addPage();y=M;} pdf.setTextColor(13,42,90); pdf.setFont('helvetica','bold'); pdf.setFontSize(size); pdf.text(text,M,y); pdf.setDrawColor(210,210,210); pdf.setLineWidth(.6); pdf.line(M,y+6,W-M,y+6); y+=18; };
    const putParagraph=(text,size=11)=>{ pdf.setTextColor(0,0,0); pdf.setFont('helvetica','normal'); pdf.setFontSize(size); const chunks=pdf.splitTextToSize(text,W-2*M); for(const ln of chunks){ if(y>H-M){pdf.addPage();y=M;} pdf.text(ln,M,y); y+=14;} y+=4; };
    for(const raw of content){ const line=raw.trim(); if(!line){y+=6;continue;}
      if(line.startsWith('# ')){putHeading(line.replace(/^#\s+/,'').trim(),16);}
      else if(line.startsWith('## ')){putHeading(line.replace(/^##\s+/,'').trim(),13);}
      else if(line.startsWith('### ')){putHeading(line.replace(/^###\s+/,'').trim(),12);}
      else{putParagraph(line,11);}
    }
    pdf.save('protocole-documentaire.pdf');
  })();
});

/* ===== Reset & Init ===== */
document.getElementById('resetApp').addEventListener('click',()=>{
  state.request={biomolecule:null,domain:null,subdomains:[]}; state.uploads=[]; state.analysis={}; state.protocol=''; state.literatureRaw=[];
  bioSelect.value=""; domainWrap.classList.add('hide'); subdomainWrap.classList.add('hide'); confirmWrap.classList.add('hide');
  filesList.innerHTML=''; document.getElementById('docList').innerHTML=''; document.getElementById('sdChips').innerHTML=''; overview.innerHTML=''; document.getElementById('sdResults').innerHTML=''; document.getElementById('protocolOutput').textContent='';
  setStep(1); pmcQueryPreview.textContent='';
});
window.addEventListener('DOMContentLoaded',()=>{ setLang('fr'); renderDomainOptions(); route(); });
</script>
</body>
</html>
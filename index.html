<!doctype html>
<html lang="fr" data-lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Montes BioPharma — Assistant Littérature</title>
<meta name="color-scheme" content="light"/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<!-- pdf.js & mammoth (extraction locale) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" crossorigin="anonymous"></script>
<style>
:root{
  --bg:#F6F7FB; --panel:#FFFFFF; --ink:#0F1226; --muted:#6C7392;
  --primary:#3A49FF; --accent:#00FF6A; --border:#E6E9F4; --blueDeep:#0D2A5A;
  --radius:18px; --shadow:0 10px 30px rgba(15,18,38,.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Outfit,system-ui,-apple-system,"Segoe UI",Ubuntu,Arial,sans-serif}
a{color:var(--primary);text-decoration:none}a:hover{text-decoration:underline}
img{display:block;max-width:100%}
.hide{display:none}

/* Tabs */
.tab{display:none}
.tab.active{display:block}

/* Particules */
#particlesCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;mix-blend-mode:multiply;opacity:.85}

/* Header */
header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(180%) blur(10px);background:rgba(255,255,255,.7);border-bottom:1px solid var(--border)}
.nav{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;gap:14px}
.logo{height:40px;width:auto}
.brand{font-weight:800;letter-spacing:.02em;color:var(--ink)}
.lang{margin-left:auto;display:flex;gap:8px;align-items:center;position:relative}
.icon-btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:10px}
#menuBtn .bars{position:relative;width:18px;height:12px}
#menuBtn .bars::before,#menuBtn .bars::after,#menuBtn .bar{content:"";position:absolute;left:0;right:0;height:2px;background:#3A49FF;border-radius:2px}
#menuBtn .bar{top:5px}#menuBtn .bars::before{top:0}#menuBtn .bars::after{bottom:0}

/* Drawer latéral droit */
#drawerMask{position:fixed;inset:0;background:rgba(5,8,20,.38);backdrop-filter:blur(2px);z-index:80;opacity:0;pointer-events:none;transition:opacity .25s ease}
#drawerMask.open{opacity:1;pointer-events:auto}
#sideMenu{
  position:fixed;top:0;right:0;height:100%;width:min(86vw,360px);
  transform:translateX(100%);transition:transform .28s ease;
  background:linear-gradient(180deg,#264a9b,#0D2A5A);
  color:#fff;z-index:90;display:flex;flex-direction:column
}
#sideMenu.open{transform:translateX(0)}
.side-head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.15)}
.side-title{font-weight:800;letter-spacing:.04em}
.side-close{appearance:none;background:transparent;border:1px solid rgba(255,255,255,.25);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.side-body{padding:14px 18px;display:grid;gap:12px}
.side-link{
  display:flex;align-items:center;gap:10px;padding:14px 12px;border-radius:12px;
  border:1px solid rgba(255,255,255,.18);cursor:pointer;background:rgba(255,255,255,.04);
  text-transform:uppercase;font-weight:800;letter-spacing:.06em;
  color:var(--accent); /* vert fluo */
}
.side-link:hover{background:rgba(255,255,255,.09)}
.side-note{color:rgba(255,255,255,.75);font-size:12px;margin-top:8px}

/* Transition de page */
#xfade{position:fixed;inset:0;pointer-events:none;z-index:50;opacity:0;background:radial-gradient(1200px 800px at 50% 50%, rgba(58,73,255,.18), rgba(0,0,0,0));transition:opacity .45s ease}
#xfade.show{opacity:1}

/* Intro (hero + tiles) */
.hero{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:56px 20px 18px}
.kicker{color:var(--accent);font-weight:800;letter-spacing:.28em;font-size:13px;text-transform:uppercase}
h1.hero-title{margin:10px 0 10px;font-size:clamp(36px,6vw,64px);line-height:1.04;color:var(--primary);text-transform:uppercase;font-weight:800}
.hero-sub{color:var(--muted);font-size:18px;max-width:820px}
.cta{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px}
.btn{appearance:none;cursor:pointer;border-radius:999px;padding:14px 22px;font-weight:700;border:2px solid transparent;transition:transform .06s ease, box-shadow .2s ease, background .2s ease,color .2s ease}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
.btn.primary:hover{box-shadow:0 14px 36px rgba(58,73,255,.25)}
.btn.ghost{background:#fff;color:var(--primary);border-color:var(--primary)}
.btn.secondary{background:#fff;color:var(--primary);border:2px solid var(--primary)}
.btn.flat{background:#fff;color:#111;border-color:#E0E5FF}

/* Tuiles */
.services{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:14px 20px 8px}
.tiles{display:grid;gap:16px}
@media(min-width:880px){.tiles{grid-template-columns:repeat(4,1fr)}}
.tile{background:linear-gradient(180deg,#F8F9FF,#EEF1FF);border:1px solid #E0E5FF;border-radius:18px;padding:18px;box-shadow:0 12px 24px rgba(58,73,255,.08);transition:transform .18s ease, box-shadow .18s ease}
.tile:hover{transform:translateY(-3px);box-shadow:0 18px 36px rgba(58,73,255,.16)}
.tile .badge{display:inline-block;font-size:12px;padding:4px 10px;border-radius:999px;background:#fff;border:1px solid #D7DEFF;color:#3A49FF;font-weight:800;letter-spacing:.04em}
.tile h3{margin:10px 0 6px;color:#0F1226}
.tile p{margin:0;color:var(--muted);font-size:14px}

/* Sections / Cards */
.section{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:22px 20px 10px}
.cards{display:grid;gap:18px}
@media(min-width:880px){.cards{grid-template-columns:1fr 1fr}}
.block{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.block header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:18px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#fff,#FBFCFF)}
.block header .overline{color:var(--accent);font-weight:800;letter-spacing:.18em;font-size:11px}
.block header h2{margin:2px 0 0;font-size:22px;color:var(--primary);text-transform:uppercase;letter-spacing:.02em}
.block .inner{padding:18px 20px}
.muted{color:var(--muted)}
hr.sep{border:none;border-top:1px solid var(--border);margin:14px 0}
.grid{display:grid;gap:12px}
.row{display:grid;gap:10px}
@media(min-width:760px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
input,select,textarea{width:100%;background:#fff;color:var(--ink);border:1.5px solid var(--border);border-radius:14px;padding:12px 14px;outline:none;transition:border .2s ease, box-shadow .2s ease}
input:focus,select:focus,textarea:focus{border-color:#C9D0FF;box-shadow:0 0 0 4px rgba(58,73,255,.12)}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

/* Chips / bars */
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
.chip.active{border-color:#3A49FF;box-shadow:0 2px 10px rgba(58,73,255,.16)}
.bar{height:6px;border-radius:6px;background:#EEF1FF;overflow:hidden}
.bar > span{display:block;height:100%;background:#3A49FF}

/* Résultats */
.result-card{border:1px solid var(--border);border-radius:16px;background:#fff;padding:12px;box-shadow:0 6px 16px rgba(15,18,38,.04);display:grid;gap:10px}
.result-meta{color:var(--muted);font-size:13px}
.snip{font-size:14px;line-height:1.4;background:#FBFCFF;border:1px solid var(--border);border-radius:12px;padding:10px}
.snip .meta{color:var(--muted);font-size:12px;margin-bottom:4px}
.snip mark{padding:0 2px;border-radius:4px;background:#FFF59D}
pre.code{white-space:pre-wrap;background:#FBFCFF;border:1px solid var(--border);border-radius:12px;padding:12px}

/* cartes & tags */
.pub-card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;display:grid;gap:6px}
.tag{font-size:11px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--ink)}

/* Uploader */
.drop{display:grid;place-items:center;text-align:center;gap:8px;padding:22px;border:2px dashed var(--border);border-radius:12px;background:#fff}
.drop.drag{border-color:var(--primary)}
.file-list{display:grid;gap:10px;margin-top:10px}

/* Sous-onglets Application */
.app-sub{display:none}
.app-sub.active{display:block}

/* Workspace */
.workspace{display:grid;gap:16px}
@media(min-width:1100px){.workspace{grid-template-columns:320px 1fr}}
.sidebar{border:1px solid var(--border);border-radius:16px;background:#fff;padding:12px;height:100%}
.sidebar h4{margin:6px 0 10px;color:#3A49FF}
.source-item{display:flex;gap:8px;align-items:flex-start;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px}
.source-item input{width:auto}
.mainpanel{display:grid;gap:12px}
.panel{border:1px solid var(--border);border-radius:16px;background:#fff;padding:16px}
.panel h3{margin:0 0 8px;color:#3A49FF}

/* Modale littérature */
.modal{position:fixed;inset:0;background:rgba(5,8,20,.38);display:none;align-items:center;justify-content:center;z-index:70}
.modal.open{display:flex}
.modal-card{width:min(980px,92vw);max-height:86vh;overflow:auto;background:#fff;border-radius:18px;box-shadow:0 18px 44px rgba(15,18,38,.22);padding:18px}
.modal-card header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
</style>
</head>
<body>
<canvas id="particlesCanvas"></canvas>
<div id="xfade"></div>

<!-- Drawer -->
<div id="drawerMask" aria-hidden="true"></div>
<aside id="sideMenu" aria-hidden="true" aria-label="Main menu">
  <div class="side-head">
    <div class="side-title" data-i="menu">Menu</div>
    <button class="side-close" id="sideCloseBtn" aria-label="Close">✕</button>
  </div>
  <div class="side-body">
    <button class="side-link" data-tab="intro"><span data-i="navIntro">Introduction</span></button>
    <button class="side-link" data-tab="app"><span data-i="navApp">Application</span></button>
    <button class="side-link" data-tab="contact"><span data-i="navContact">Contact</span></button>
    <div class="side-note">© <span id="year2"></span> Montes BioPharma</div>
  </div>
</aside>

<header>
  <div class="nav">
    <picture>
      <source srcset="./assets/montes-biopharma-logo.svg" type="image/svg+xml">
      <img src="./assets/montes-biopharma-logo.jpg" alt="Montes BioPharma" class="logo" width="160" height="40">
    </picture>
    <div class="brand" data-i="brand">Montes BioPharma</div>

    <div class="lang">
      <button id="menuBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false" aria-controls="sideMenu" title="Menu">
        <span class="bars" aria-hidden="true"><span class="bar"></span></span>
        <span class="sr-only" style="position:absolute;left:-9999px" data-i="menu">Menu</span>
      </button>
      <button id="btnFR" class="icon-btn active">FR</button>
      <button id="btnEN" class="icon-btn">EN</button>
    </div>
  </div>
</header>

<!-- TAB INTRO -->
<section id="tab-intro" class="tab active" aria-labelledby="navIntro">
  <section class="hero">
    <div class="kicker" data-i="kicker">ASSISTANT LITTÉRATURE</div>
    <h1 class="hero-title" data-i="heroTitle">No learning curve,<br/>no complications</h1>
    <p class="hero-sub" data-i="heroSub">
      <span data-i="introP1">Recherche d’articles (Europe PMC), upload de documents internes, analyse IA et création de protocoles documentaires (adénovirus).</span>
    </p>
    <div class="cta">
      <button class="btn primary" id="openMenuCta" data-i="ctaOpenMenu">Ouvrir le menu</button>
      <button class="btn ghost" id="openMenuLearn" data-i="ctaOpenLearn">Que puis-je faire ?</button>
    </div>
  </section>

  <section class="services">
    <div class="tiles">
      <div class="tile">
        <span class="badge" data-i="t1Badge">Upload</span>
        <h3 data-i="t1Title">Documents internes</h3>
        <p data-i="t1Text">PDF, DOCX, TXT — extraction locale, aucune donnée envoyée.</p>
      </div>
      <div class="tile">
        <span class="badge">Europe PMC</span>
        <h3 data-i="t2Title">Recherche d’articles</h3>
        <p data-i="t2Text">Fenêtre temporelle, mots-clés, open access. Liens PubMed.</p>
      </div>
      <div class="tile">
        <span class="badge">AI</span>
        <h3 data-i="t3Title">Synthèse des contenus</h3>
        <p data-i="t3Text">Résumé automatique (Hugging Face) des abstracts / texte intégral.</p>
      </div>
      <div class="tile">
        <span class="badge">PDF</span>
        <h3 data-i="t4Title">Export documentaire</h3>
        <p data-i="t4Text">Protocole documentaire structuré (sans paramètres expérimentaux).</p>
      </div>
    </div>
  </section>
</section>

<!-- TAB APPLICATION -->
<section id="tab-app" class="tab" aria-labelledby="navApp">
  <div class="section">
    <!-- STEP 1 -->
    <section id="app-step1" class="app-sub active">
      <div class="cards">
        <section class="block open">
          <header>
            <div>
              <div class="overline" data-i="overlineStep1">ANALYSE DE LA DEMANDE</div>
              <h2 data-i="step1Title">Votre besoin</h2>
            </div>
          </header>
          <div class="inner">
            <div class="grid">
              <div>
                <label data-i="q1">Quelle biomolécule voulez-vous produire ?</label>
                <select id="bioSelect">
                  <option value="" selected disabled data-i="selectPlaceholder">— Sélectionner —</option>
                  <option value="Adenovirus">Adénovirus</option>
                </select>
              </div>
              <div id="domainWrap" class="hide">
                <label data-i="q2">Quel est le domaine du pharmaceutique que vous souhaitez explorer ?</label>
                <select id="domainSelect"></select>
              </div>
              <div id="detailWrap" class="hide">
                <label><strong id="detailTitle" data-i="detailTitleGeneric">Spécifiez votre besoin</strong></label>
                <div id="detailChoices" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))"></div>
              </div>
              <div id="confirmWrap" class="hide">
                <div class="panel" style="border:1px dashed var(--border)">
                  <p id="confirmText" class="muted"></p>
                </div>
                <div class="controls">
                  <button class="btn primary" id="goToDocs" data-i="goNext">Passer à la suite</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="app-step2" class="app-sub">
      <div class="cards">
        <section class="block open">
          <header>
            <div>
              <div class="overline" data-i="overlineStep2">DOCUMENTS & LITTÉRATURE</div>
              <h2 data-i="step2Title">Sources</h2>
            </div>
          </header>
          <div class="inner">
            <div class="grid">
              <div>
                <label data-i="qDocs">Avez-vous des documents internes sur lesquels je peux me baser pour concevoir la méthode ?</label>
                <div class="controls">
                  <button class="btn secondary" id="btnDocYes" data-i="yes">Oui</button>
                  <button class="btn secondary" id="btnDocNo" data-i="no">Non</button>
                </div>
              </div>
              <div id="uploaderWrap" class="hide">
                <div id="drop" class="drop" style="margin-top:6px">
                  <div>
                    <strong data-i="dropTitle">Déposez vos fichiers ici</strong>
                    <div class="muted" data-i="dropHint">ou cliquez pour sélectionner</div>
                    <small data-i="dropTypes">Acceptés : PDF, DOCX, TXT</small>
                  </div>
                  <input id="fileInput" type="file" multiple accept=".pdf,.docx,.txt" style="display:none">
                </div>
                <div class="file-list" id="filesList"></div>
              </div>

              <div style="margin-top:10px">
                <label data-i="qLit">Souhaitez-vous une recherche dans la littérature selon votre domaine ?</label>
                <div class="controls">
                  <button class="btn secondary" id="btnLitYes" data-i="yes">Oui</button>
                  <button class="btn secondary" id="btnLitNo" data-i="no">Non</button>
                </div>
              </div>

              <div class="controls" style="margin-top:8px">
                <button class="btn primary" id="toWorkspace" data-i="goAnalysis">Aller à l’analyse</button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Modale littérature -->
      <div id="litModal" class="modal" aria-hidden="true">
        <div class="modal-card">
          <header>
            <h3 style="margin:0" data-i="litResultsTitle">Résultats littérature</h3>
            <button class="icon-btn" id="closeLitModal" data-i="close">Fermer</button>
          </header>
          <div id="litResults"></div>
          <div class="controls" style="margin-top:10px">
            <button class="btn primary" id="runLitAnalysis" data-i="runContentAnalysis">Lancer l’analyse du contenu</button>
          </div>
        </div>
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="app-step3" class="app-sub">
      <div class="cards">
        <section class="block open">
          <header>
            <div>
              <div class="overline" data-i="overlineStep3">ANALYSE APPROFONDIE</div>
              <h2 data-i="step3Title">Espace d’analyse ciblée</h2>
            </div>
          </header>
          <div class="inner">
            <div class="workspace">
              <aside class="sidebar">
                <h4 data-i="internalSources">Sources internes</h4>
                <div id="docList"></div>
                <h4 style="margin-top:12px" data-i="selectedArticles">Articles sélectionnés</h4>
                <div id="artList"></div>
                <hr class="sep">
                <h4 data-i="activeSubdomains">Sous-domaines actifs</h4>
                <div id="sdChips" class="chips"></div>
              </aside>

              <div class="mainpanel">
                <div class="panel">
                  <h3 data-i="overview">Vue d’ensemble</h3>
                  <div id="overview"></div>
                </div>

                <div id="sdResults"></div>

                <div class="controls" style="margin-top:6px">
                  <button class="btn primary" id="exportPdf" data-i="exportPdfBtn">Exporter le PDF</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </section>
  </div>
</section>

<!-- TAB CONTACT -->
<section id="tab-contact" class="tab" aria-labelledby="navContact">
  <section class="section">
    <div class="cards">
      <section class="block open">
        <header>
          <div>
            <div class="overline" data-i="overlineContact">PRISE DE CONTACT</div>
            <h2 data-i="contactTitle">Discutons de votre projet</h2>
          </div>
        </header>
        <div class="inner">
          <p class="muted" data-i="contactIntro">Nos scientifiques experts peuvent vous aider à accélérer la mise au point de vos procédés (vecteurs adénoviraux, purification, analytique, documentation).</p>
          <div class="row row-2">
            <div><label data-i="labelName">Nom</label><input id="c_name" placeholder="Jane Doe"></div>
            <div><label data-i="labelOrg">Société</label><input id="c_org" placeholder="Montes BioPharma"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div><label data-i="labelEmail">Email</label><input id="c_email" placeholder="you@company.com" type="email"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div><label data-i="labelMsg">Message</label><textarea id="c_msg" rows="4" placeholder="Parlez-nous de votre projet…"></textarea></div>
          </div>
          <div class="controls">
            <a id="c_mailto" class="btn primary" href="#" data-i="sendEmail">Envoyer par e-mail</a>
            <a class="btn secondary" href="https://www.linkedin.com" target="_blank" rel="noopener">LinkedIn</a>
          </div>
        </div>
      </section>
    </div>
  </section>
</section>

<footer style="background:#fff;border-top:1px solid var(--border);margin-top:36px">
  <div class="section" style="padding-top:20px;padding-bottom:28px">
    <div style="display:flex;justify-content:space-between;gap:10px;color:var(--muted)">
      <div>© <span id="year"></span> Montes BioPharma</div>
      <div data-i="footerNote">Europe PMC / PubMed — Hugging Face (optionnel). Aucune instruction expérimentale.</div>
    </div>
  </div>
</footer>

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

<script>
/* Particules renforcées (visibles) */
const cv=document.getElementById('particlesCanvas'),cx=cv.getContext('2d');let W,H,PTS=[];
function size(){W=cv.width=innerWidth;H=cv.height=innerHeight} size(); addEventListener('resize',size);
function R(a,b){return a+Math.random()*(b-a)}
function spawn(){return{x:R(0,W),y:R(0,H),vx:R(-.05,.05),vy:-R(.02,.07),r:R(1.3,3.1),t:R(0,6.28),tw:R(.8,1.3)}}
PTS=Array.from({length:Math.min(320,Math.round((W*H)/12000))},spawn);
(function loop(){requestAnimationFrame(loop);cx.clearRect(0,0,W,H);
for(const p of PTS){p.t+=.016;const a=.2+.5*Math.abs(Math.sin(p.t))*p.tw;p.x+=p.vx+Math.sin(p.t*.35)*.03;p.y+=p.vy;
if(p.x<-6)p.x=W+6;if(p.x>W+6)p.x=-6;if(p.y<-6){p.y=H+6;p.x=Math.random()*W;}
const mix=Math.abs(Math.sin(p.t*.5));const r=Math.round(20+38*mix), g=Math.round(170+70*(1-mix)), b=Math.round(255-30*(1-mix));
cx.beginPath();cx.arc(p.x,p.y,p.r,0,6.283);cx.fillStyle=`rgba(${r},${g},${b},${a})`;cx.fill();}})();

/* Drawer & tabs */
const menuBtn=document.getElementById('menuBtn');
const drawer=document.getElementById('sideMenu');
const mask=document.getElementById('drawerMask');
const sideClose=document.getElementById('sideCloseBtn');
function openDrawer(){ drawer.classList.add('open'); mask.classList.add('open'); menuBtn.setAttribute('aria-expanded','true'); drawer.setAttribute('aria-hidden','false'); }
function closeDrawer(){ drawer.classList.remove('open'); mask.classList.remove('open'); menuBtn.setAttribute('aria-expanded','false'); drawer.setAttribute('aria-hidden','true'); }
menuBtn.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation(); drawer.classList.contains('open')?closeDrawer():openDrawer();});
sideClose.addEventListener('click', closeDrawer);
mask.addEventListener('click', closeDrawer);
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeDrawer(); });
document.getElementById('openMenuCta').onclick=(e)=>{e.stopPropagation();openDrawer();};
document.getElementById('openMenuLearn').onclick=(e)=>{e.stopPropagation();openDrawer();};

const xfade=document.getElementById('xfade');
const tabs={intro:document.getElementById('tab-intro'),app:document.getElementById('tab-app'),contact:document.getElementById('tab-contact')};
function showTab(name){
  xfade.classList.add('show');
  setTimeout(()=>{
    Object.values(tabs).forEach(t=>t.classList.remove('active'));
    (tabs[name]||tabs.intro).classList.add('active');
    closeDrawer();
    window.scrollTo({top:0,behavior:'auto'});
    setTimeout(()=>xfade.classList.remove('show'),260);
  },160);
}
document.querySelectorAll('#sideMenu .side-link').forEach(btn=>{
  btn.addEventListener('click',()=>showTab(btn.dataset.tab));
});

/* Sous-onglets Application */
const appSubs={ step1:document.getElementById('app-step1'), step2:document.getElementById('app-step2'), step3:document.getElementById('app-step3') };
function showAppSub(key){
  xfade.classList.add('show');
  setTimeout(()=>{
    Object.values(appSubs).forEach(s=>s.classList.remove('active'));
    (appSubs[key]||appSubs.step1).classList.add('active');
    window.scrollTo({top:0,behavior:'auto'});
    setTimeout(()=>xfade.classList.remove('show'),260);
  },160);
}

/* i18n */
const I={
  fr:{brand:"Montes BioPharma",menu:"Menu",navIntro:"Introduction",navApp:"Application",navContact:"Contact",
      kicker:"ASSISTANT LITTÉRATURE",heroTitle:"No learning curve,<br/>no complications",heroSub:"Recherche d’articles (Europe PMC), upload de documents internes, analyse IA et création de protocoles documentaires (adénovirus).",
      introP1:"Recherche d’articles (Europe PMC), upload de documents internes, analyse IA et création de protocoles documentaires (adénovirus).",
      ctaOpenMenu:"Ouvrir le menu",ctaOpenLearn:"Que puis-je faire ?",t1Badge:"Upload",t1Title:"Documents internes",t1Text:"PDF, DOCX, TXT — extraction locale, aucune donnée envoyée.",
      t2Title:"Recherche d’articles",t2Text:"Fenêtre temporelle, mots-clés, open access. Liens PubMed.",t3Title:"Synthèse des contenus",t3Text:"Résumé automatique (Hugging Face) des abstracts / texte intégral.",
      t4Title:"Export documentaire",t4Text:"Protocole documentaire structuré (sans paramètres expérimentaux).",
      overlineStep1:"ANALYSE DE LA DEMANDE",step1Title:"Votre besoin",q1:"Quelle biomolécule voulez-vous produire ?",selectPlaceholder:"— Sélectionner —",
      q2:"Quel est le domaine du pharmaceutique que vous souhaitez explorer ?",detailTitleGeneric:"Spécifiez votre besoin",goNext:"Passer à la suite",
      overlineStep2:"DOCUMENTS & LITTÉRATURE",step2Title:"Sources",qDocs:"Avez-vous des documents internes sur lesquels je peux me baser pour concevoir la méthode ?",
      yes:"Oui",no:"Non",dropTitle:"Déposez vos fichiers ici",dropHint:"ou cliquez pour sélectionner",dropTypes:"Acceptés : PDF, DOCX, TXT",
      qLit:"Souhaitez-vous une recherche dans la littérature selon votre domaine ?",goAnalysis:"Aller à l’analyse",
      litResultsTitle:"Résultats littérature",close:"Fermer",runContentAnalysis:"Lancer l’analyse du contenu",
      overlineStep3:"ANALYSE APPROFONDIE",step3Title:"Espace d’analyse ciblée",internalSources:"Sources internes",selectedArticles:"Articles sélectionnés",
      activeSubdomains:"Sous-domaines actifs",overview:"Vue d’ensemble",exportPdfBtn:"Exporter le PDF",
      contactTitle:"Discutons de votre projet",overlineContact:"PRISE DE CONTACT",
      contactIntro:"Nos scientifiques experts peuvent vous aider à accélérer la mise au point de vos procédés (vecteurs adénoviraux, purification, analytique, documentation).",
      labelName:"Nom",labelOrg:"Société",labelEmail:"Email",labelMsg:"Message",sendEmail:"Envoyer par e-mail",
      footerNote:"Europe PMC / PubMed — Hugging Face (optionnel). Aucune instruction expérimentale.",
      searching:"Recherche…", epmcError:"Erreur Europe PMC", open:"Ouvrir", selectAtLeastOne:"Sélectionnez au moins un article.",
      ctx:"Contexte", noActiveSD:"Aucun sous-domaine actif.",
      docsInternal:"Documents internes", literature:"Littérature (Europe PMC / PubMed)", targetedSummary:"Résumé ciblé (~1 page)",
      pdfTitle:"Protocole documentaire — Analyse ciblée", pdfOverview:"Vue d’ensemble", pdfEvidences:"Évidences",
      dom_downstream:"Downstream", dom_upstream:"Upstream", dom_fill:"Fill & Finish", dom_analytics:"Analytique", dom_qa:"Assurance Qualité", dom_cmc:"CMC",
      sdtitle_downstream:"Spécifiez les sous-domaines Downstream", sdtitle_upstream:"Spécifiez les sous-domaines Upstream", sdtitle_fill:"Spécifiez les sous-domaines Fill & Finish",
      sdtitle_analytics:"Spécifiez les sous-domaines Analytiques", sdtitle_qa:"Spécifiez les sous-domaines Assurance Qualité", sdtitle_cmc:"Spécifiez les sous-domaines CMC",
      biomolecule:"Biomolécule", domain:"Domaine", oaTag:"Accès libre", scoreLabel:"score", pageShort:"p."
  },
  en:{brand:"Montes BioPharma",menu:"Menu",navIntro:"Introduction",navApp:"Application",navContact:"Contact",
      kicker:"LITERATURE ASSISTANT",heroTitle:"No learning curve,<br/>no complications",heroSub:"Article search (Europe PMC), internal document upload, AI analysis and documentary protocol creation (adenovirus).",
      introP1:"Article search (Europe PMC), internal document upload, AI analysis and documentary protocol creation (adenovirus).",
      ctaOpenMenu:"Open menu",ctaOpenLearn:"What can I do?",t1Badge:"Upload",t1Title:"Internal documents",t1Text:"PDF, DOCX, TXT — local extraction, no data sent.",
      t2Title:"Article search",t2Text:"Time window, keywords, open access. PubMed links.",t3Title:"Content synthesis",t3Text:"Automatic summaries (Hugging Face) of abstracts / full text.",
      t4Title:"PDF export",t4Text:"Structured documentary protocol (no experimental parameters).",
      overlineStep1:"REQUEST ANALYSIS",step1Title:"Your need",q1:"Which biomolecule do you want to produce?",selectPlaceholder:"— Select —",
      q2:"Which pharmaceutical domain do you want to explore?",detailTitleGeneric:"Specify your need",goNext:"Continue",
      overlineStep2:"DOCUMENTS & LITERATURE",step2Title:"Sources",qDocs:"Do you have internal documents I can use to design the method?",
      yes:"Yes",no:"No",dropTitle:"Drop your files here",dropHint:"or click to select",dropTypes:"Accepted: PDF, DOCX, TXT",
      qLit:"Would you like a literature search based on your domain?",goAnalysis:"Go to analysis",
      litResultsTitle:"Literature results",close:"Close",runContentAnalysis:"Run content analysis",
      overlineStep3:"IN-DEPTH ANALYSIS",step3Title:"Targeted analysis workspace",internalSources:"Internal sources",selectedArticles:"Selected articles",
      activeSubdomains:"Active subdomains",overview:"Overview",exportPdfBtn:"Export PDF",
      contactTitle:"Let's discuss your project",overlineContact:"GET IN TOUCH",
      contactIntro:"Our expert scientists can help accelerate your process development (adenoviral vectors, purification, analytics, documentation).",
      labelName:"Name",labelOrg:"Company",labelEmail:"Email",labelMsg:"Message",sendEmail:"Send Email",
      footerNote:"Europe PMC / PubMed — Hugging Face (optional). No experimental instructions.",
      searching:"Searching…", epmcError:"Europe PMC error", open:"Open", selectAtLeastOne:"Select at least one article.",
      ctx:"Context", noActiveSD:"No active subdomains.",
      docsInternal:"Internal documents", literature:"Literature (Europe PMC / PubMed)", targetedSummary:"Targeted summary (~1 page)",
      pdfTitle:"Documentary protocol — Targeted analysis", pdfOverview:"Overview", pdfEvidences:"Evidences",
      dom_downstream:"Downstream", dom_upstream:"Upstream", dom_fill:"Fill & Finish", dom_analytics:"Analytical", dom_qa:"Quality Assurance", dom_cmc:"CMC",
      sdtitle_downstream:"Specify Downstream subdomains", sdtitle_upstream:"Specify Upstream subdomains", sdtitle_fill:"Specify Fill & Finish subdomains",
      sdtitle_analytics:"Specify Analytical subdomains", sdtitle_qa:"Specify Quality Assurance subdomains", sdtitle_cmc:"Specify CMC subdomains",
      biomolecule:"Biomolecule", domain:"Domain", oaTag:"Open Access", scoreLabel:"score", pageShort:"p."
  }
};
function lang(){return document.documentElement.dataset.lang||'fr';}
function t(k){const L=I[lang()]||I.fr;return (L&&L[k])||(I.fr[k]||k);}

const btnFR=document.getElementById('btnFR'), btnEN=document.getElementById('btnEN');
btnFR.onclick=()=>{setLang('fr');btnFR.classList.add('active');btnEN.classList.remove('active');};
btnEN.onclick=()=>{setLang('en');btnEN.classList.add('active');btnFR.classList.remove('active');};

function setLang(newLang){
  document.documentElement.setAttribute('lang', newLang);
  document.documentElement.dataset.lang = newLang;
  for(const el of document.querySelectorAll('[data-i]')){
    const v = t(el.dataset.i);
    if(/<br\s*\/?>|&nbsp;/.test(v)) el.innerHTML = v; else el.textContent = v;
  }
  renderDomainOptions(state.request.domain);
  if(state.request.domain){ buildDetailChoices(state.request.domain); }
  updateMailto();
}

/* Domaines & sous-domaines */
const SUBDOMAINS = {
  downstream: [
    {id:"clarification", fr:"Clarification", en:"Clarification"},
    {id:"tff_df", fr:"Concentration et Diafiltration", en:"Concentration and Diafiltration"},
    {id:"capture_chrom", fr:"Capture par chromatographie", en:"Capture by chromatography"},
    {id:"polishing", fr:"Polishing", en:"Polishing"},
    {id:"formulation", fr:"Formulation", en:"Formulation"},
    {id:"final_filtration", fr:"Filtration finale", en:"Final Filtration"}
  ],
  upstream: [
    {id:"cell_bank_seed", fr:"Banque cellulaire & Seed train", en:"Cell bank & seed train"},
    {id:"production_bioreactor", fr:"Bioréacteur de production (batch/fed-batch/perfusion)", en:"Production bioreactor (batch/fed-batch/perfusion)"},
    {id:"infection_strategy", fr:"Stratégie d’infection/MOI (si applicable)", en:"Infection/MOI strategy (if applicable)"},
    {id:"harvest_lysis", fr:"Récolte / Lyse", en:"Harvest / Lysis"},
    {id:"ipc", fr:"Contrôles en cours de procédé (IPC)", en:"In-process controls (IPC)"},
    {id:"handoff_ds", fr:"Handoff vers Downstream", en:"Handoff to Downstream"}
  ],
  fill: [
    {id:"hold_bulk", fr:"Hold bulk & cycles freeze/thaw", en:"Hold bulk & freeze/thaw cycles"},
    {id:"aseptic_fill", fr:"Remplissage aseptique (flacons, seringues, cartouches)", en:"Aseptic filling (vials, syringes, cartridges)"},
    {id:"ccc", fr:"Système contenant/fermeture & compatibilité", en:"Container/closure & compatibility"},
    {id:"fit", fr:"Tests d’intégrité filtres", en:"Filter integrity tests"},
    {id:"vi_aql", fr:"Inspection visuelle / AQL", en:"Visual inspection / AQL"},
    {id:"cold_chain", fr:"Chaîne du froid & étiquetage", en:"Cold chain & labeling"}
  ],
  analytics: [
    {id:"identity", fr:"Identité (p. ex. PCR/séquençage)", en:"Identity (e.g., PCR/sequencing)"},
    {id:"potency", fr:"Puissance (infectivité, titres)", en:"Potency (infectivity, titers)"},
    {id:"impurities", fr:"Impuretés (HCP, ADN résiduel, etc.)", en:"Impurities (HCP, residual DNA, etc.)"},
    {id:"size_agg", fr:"Taille/agrégation (p. ex. DLS/TEM)", en:"Size/aggregation (e.g., DLS/TEM)"},
    {id:"qPCR", fr:"Dosage (qPCR/ddPCR)", en:"Assay (qPCR/ddPCR)"},
    {id:"stability_indic", fr:"Méthodes indicatrices de stabilité", en:"Stability-indicating methods"}
  ],
  qa: [
    {id:"change_control", fr:"Change control", en:"Change control"},
    {id:"deviation_capa", fr:"Déviations & CAPA", en:"Deviations & CAPA"},
    {id:"training_qual", fr:"Qualification & formation", en:"Qualification & training"},
    {id:"gxp_docs", fr:"Gestion documentaire GxP", en:"GxP document control"},
    {id:"suppliers", fr:"Qualification fournisseurs & matières", en:"Supplier & material qualification"},
    {id:"bmr", fr:"Revue des dossiers de lot", en:"Batch record review"}
  ],
  cmc: [
    {id:"reg_strategy", fr:"Stratégie réglementaire", en:"Regulatory strategy"},
    {id:"control_strategy", fr:"Control strategy", en:"Control strategy"},
    {id:"specs_release", fr:"Spécifications & libération", en:"Specifications & release"},
    {id:"comparability", fr:"Comparabilité (changements procédé)", en:"Comparability (process changes)"},
    {id:"ppq", fr:"Validation / PPQ", en:"Validation / PPQ"},
    {id:"proc_char", fr:"Caractérisation procédé", en:"Process characterization"}
  ]
};
function L_dom(key){
  const map = {downstream:'dom_downstream', upstream:'dom_upstream', fill:'dom_fill', analytics:'dom_analytics', qa:'dom_qa', cmc:'dom_cmc'};
  const k = map[key];
  return k ? t(k) : (key||'-');
}

/* Réfs DOM & État */
const bioSelect=document.getElementById('bioSelect');
const domainWrap=document.getElementById('domainWrap');
const domainSelect=document.getElementById('domainSelect');
const detailWrap=document.getElementById('detailWrap');
const detailTitle=document.getElementById('detailTitle');
const detailChoices=document.getElementById('detailChoices');
const confirmWrap=document.getElementById('confirmWrap');
const confirmText=document.getElementById('confirmText');
const goToDocs=document.getElementById('goToDocs');

const state={ request:{ biomolecule:null, domain:null, details:[] }, uploads:[], literature:{results:[],selected:[]}, analysis:{targeted:{}} };

/* Initialisation */
function renderDomainOptions(selectedKey){
  const options = [
    {key:'', label: t('selectPlaceholder')},
    {key:'upstream', label: t('dom_upstream')},
    {key:'downstream', label: t('dom_downstream')},
    {key:'fill', label: t('dom_fill')},
    {key:'analytics', label: t('dom_analytics')},
    {key:'qa', label: t('dom_qa')},
    {key:'cmc', label: t('dom_cmc')}
  ];
  domainSelect.innerHTML='';
  options.forEach((o,i)=>{
    const opt=document.createElement('option');
    opt.value=o.key;
    opt.textContent = i===0 ? `— ${o.label} —` : o.label;
    if(selectedKey && o.key===selectedKey) opt.selected=true;
    if(i===0) opt.disabled=true;
    domainSelect.appendChild(opt);
  });
}
window.addEventListener('DOMContentLoaded',()=>{
  Object.values(tabs).forEach(t=>t.classList.remove('active'));
  tabs.intro.classList.add('active');
  setLang('fr');
  document.getElementById('year').textContent=new Date().getFullYear();
  document.getElementById('year2').textContent=new Date().getFullYear();
});

/* Step 1 */
bioSelect.addEventListener('change',()=>{
  state.request.biomolecule = bioSelect.value || null;
  domainWrap.classList.remove('hide');
  detailWrap.classList.add('hide'); confirmWrap.classList.add('hide');
});
domainSelect.addEventListener('change',()=>{
  const key = domainSelect.value || null;
  state.request.domain = key;
  buildDetailChoices(key);
  detailWrap.classList.remove('hide'); confirmWrap.classList.add('hide');
});
function buildDetailChoices(domainKey){
  const items = SUBDOMAINS[domainKey] || [];
  const titleKey = 'sdtitle_' + domainKey;
  detailTitle.textContent = I[lang()][titleKey] || t('detailTitleGeneric');
  detailChoices.innerHTML = "";
  confirmWrap.classList.add('hide');

  const selectedIDs = new Set(state.request.details || []);
  items.forEach(item=>{
    const lbl = (lang()==='fr'?item.fr:item.en);
    const row = document.createElement('label');
    row.className = 'source-item';
    row.innerHTML = `<input type="checkbox" data-id="${item.id}" style="width:auto"><span>${lbl}</span>`;
    const cb = row.querySelector('input');
    cb.checked = selectedIDs.has(item.id);

    cb.addEventListener('change', ()=>{
      const ids = [...detailChoices.querySelectorAll('input:checked')].map(i=>i.dataset.id);
      state.request.details = ids;

      const visibleLabels = ids.map(id => {
        for(const arr of Object.values(SUBDOMAINS)){ const f=arr.find(z=>z.id===id); if(f) return (lang()==='fr'?f.fr:f.en); }
        return id;
      });

      const txtFR = `Parfait. Vous avez choisi : ${t('biomolecule').toLowerCase()} = ${state.request.biomolecule}; ${t('domain').toLowerCase()} = ${L_dom(state.request.domain)}; sous-domaines = ${visibleLabels.join(', ')}. Je garde ces choix en mémoire et nous allons passer à la seconde partie du processus.`;
      const txtEN = `Great. You selected: ${t('biomolecule')} = ${state.request.biomolecule}; ${t('domain')} = ${L_dom(state.request.domain)}; subdomains = ${visibleLabels.join(', ')}. I'll keep these choices in memory and we'll move to the second part of the process.`;

      const hasSel = ids.length > 0;
      confirmWrap.classList.toggle('hide', !hasSel);
      confirmText.textContent = (lang()==='fr') ? txtFR : txtEN;
    });

    detailChoices.appendChild(row);
  });

  if((state.request.details||[]).length){
    const first = detailChoices.querySelector('input');
    if(first){ first.dispatchEvent(new Event('change')); }
  }
}
goToDocs.addEventListener('click',()=>{ showAppSub('step2'); });

/* Step 2 — uploader */
const btnDocYes=document.getElementById('btnDocYes'), btnDocNo=document.getElementById('btnDocNo');
const uploaderWrap=document.getElementById('uploaderWrap'); const drop=document.getElementById('drop'); const input=document.getElementById('fileInput'); const filesList=document.getElementById('filesList');
btnDocYes.onclick=()=>{uploaderWrap.classList.remove('hide');};
btnDocNo.onclick=()=>{uploaderWrap.classList.add('hide');state.uploads=[];filesList.innerHTML='';};

drop?.addEventListener('click',(e)=>{e.preventDefault();input.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true}));});
drop?.addEventListener('dragover',(e)=>{e.preventDefault();drop.classList.add('drag');});
drop?.addEventListener('dragleave',()=>drop.classList.remove('drag'));
drop?.addEventListener('drop',(e)=>{e.preventDefault();drop.classList.remove('drag');handleFiles(e.dataTransfer.files);});
input?.addEventListener('change',(e)=>handleFiles(e.target.files));
function handleFiles(files){
  state.uploads=[...files];
  filesList.innerHTML='';
  state.uploads.forEach(f=>{
    const it=document.createElement('div'); it.className='source-item';
    it.innerHTML=`<input type="checkbox" checked style="width:auto"><span>${f.name} — ${(f.size/1024/1024).toFixed(2)} MB</span>`;
    filesList.appendChild(it);
  });
}

/* Littérature Europe PMC (via AllOrigins) */
const btnLitYes=document.getElementById('btnLitYes'), btnLitNo=document.getElementById('btnLitNo');
const litModal=document.getElementById('litModal'), closeLitModal=document.getElementById('closeLitModal'), litResults=document.getElementById('litResults');
btnLitYes.onclick=()=>{ openLitModalAndSearch(); };
btnLitNo.onclick=()=>{};
closeLitModal.onclick=()=>{ litModal.classList.remove('open'); };

function domainQuery(){
  const key = state.request.domain || 'downstream';
  const bm = (state.request.biomolecule||'Adenovirus');
  const q = {
    downstream: `${bm} (chromatography OR TFF OR diafiltration OR polishing OR formulation OR filtration)`,
    upstream: `${bm} (bioreactor OR perfusion OR seed train OR harvest OR lysis)`,
    fill: `${bm} (aseptic filling OR container closure OR filter integrity OR visual inspection OR cold chain)`,
    analytics: `${bm} (identity OR potency OR impurities OR aggregation OR qPCR OR stability)`,
    qa: `${bm} (GxP OR deviation OR CAPA OR document control OR supplier qualification OR batch record)`,
    cmc: `${bm} (control strategy OR specifications OR PPQ OR comparability OR process characterization)`
  };
  return q[key] || `${bm} purification`;
}
async function openLitModalAndSearch(){
  litModal.classList.add('open');
  litResults.innerHTML=`<div class="muted">${t('searching')}</div>`;
  const q = domainQuery();
  const url = `https://api.allorigins.win/get?url=${encodeURIComponent('https://www.ebi.ac.uk/europepmc/webservices/rest/search?query='+encodeURIComponent(q)+'&pageSize=12&format=json&sort_date:y')}`;
  try{
    const r=await fetch(url); const raw=await r.json(); const j=JSON.parse(raw.contents);
    const res=(j.resultList?.result)||[];
    state.literature.results = res.map(x=>({
      pmid:x.pmid||'', pmcid:x.pmcid||'', title:x.title||'', journal:x.journalTitle||x.source||'', year:x.pubYear||'',
      authors:(x.authorString||'').split(', ').slice(0,6), oa:(x.isOpenAccess==="Y"||x.openAccess=="Y"||x.openAccess)
    }));
    renderLitResults();
  }catch(e){ litResults.innerHTML=`<div class="muted">${t('epmcError')}</div>`; }
}
function esc(s){return (s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}
function renderLitResults(){
  litResults.innerHTML='';
  state.literature.results.forEach((a,idx)=>{
    const link = a.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/` : (a.pmcid?`https://europepmc.org/article/PMC/${a.pmcid}`:'#');
    const el=document.createElement('div'); el.className='pub-card';
    el.innerHTML=`
      <label style="display:flex;gap:10px;align-items:flex-start">
        <input type="checkbox" data-i="${idx}" style="width:auto;margin-top:4px">
        <div>
          <div><strong>${esc(a.title)}</strong> ${a.oa?'<span class="tag">'+t('oaTag')+'</span>':''}</div>
          <div class="muted">${esc(a.journal)} · ${esc(a.year||'—')}</div>
          <div class="muted">${esc(a.authors.join(', '))}</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <a class="tag" href="${link}" target="_blank" rel="noopener">${t('open')}</a>
          </div>
        </div>
      </label>`;
    el.querySelector('input').addEventListener('change',e=>{
      const i=+e.target.dataset.i;
      state.literature.results[i].selected = e.target.checked;
    });
    litResults.appendChild(el);
  });
}

document.getElementById('runLitAnalysis').onclick = async ()=>{
  const chosen = state.literature.results.filter(x=>x.selected);
  if(!chosen.length){ alert(t('selectAtLeastOne')); return; }

  const HF_TOKEN = "hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; // optionnel
  const HF_MODEL = "facebook/bart-large-cnn";
  async function summarize(text){
    if(!HF_TOKEN.startsWith('hf_')) return (text||'').slice(0,1200);
    try{
      const r=await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`,{
        method:'POST',headers:{Authorization:`Bearer ${HF_TOKEN}`,'Content-Type':'application/json'},
        body:JSON.stringify({inputs:text})
      });
      const j=await r.json();
      return Array.isArray(j)&&j[0]?.summary_text ? j[0].summary_text : (text||'').slice(0,1200);
    }catch(_){return (text||'').slice(0,1200);}
  }

  const out=[];
  for(const a of chosen){
    let abs='';
    try{
      if(a.pmid){
        abs = await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/MED/${a.pmid}/abstractText?format=plain`).then(r=>r.text());
      }else if(a.pmcid){
        abs = await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/PMC/${a.pmcid}/abstractText?format=plain`).then(r=>r.text());
      }
    }catch(_){}
    const s = await summarize(abs);
    out.push({meta:a, abstract:abs||'', summary:s});
  }

  state.literature.selected = out;
  litModal.classList.remove('open');
  buildWorkspace();
  showAppSub('step3');
};

document.getElementById('toWorkspace').onclick = ()=>{ buildWorkspace(); showAppSub('step3'); };

/* Moteur d'analyse ciblée */
const REDACT=/\b\d+(?:[\.,]\d+)?\s?(?:mL|ml|L|µL|uL|°C|C|rpm|g|xg|min|h|hours?|days?|M|mM|µM|uM|%|nm|mm|cm|kDa)\b/gi;
function sanitize(txt){return (txt||"").replace(REDACT,"[…]");}
function windowsFromText(text, win=800, overlap=200){
  const markers=[...text.matchAll(/\[\[PAGE:(\d+)\]\]/g)].map(m=>({idx:m.index,num:+m[1]}));
  const clean=text.replace(/\[\[PAGE:\d+\]\]/g,'');
  const out=[]; let i=0; const step = Math.max(64, win-overlap);
  while(i<clean.length){
    const slice=clean.slice(i, i+win);
    const head = clean.slice(Math.max(0,i-200), i+80).toLowerCase();
    let section='';
    if(/materials?|méthodes?|methods?/.test(head)) section='methods';
    else if(/results?/.test(head)) section='results';
    else if(/discussion/.test(head)) section='discussion';
    else if(/introduction/.test(head)) section='introduction';
    else if(/formulation|chromatograph|filtration|tff|diafiltration/.test(head)) section='process';

    const prev = markers.filter(m=>m.idx<=i).pop();
    out.push({start:i, end:i+win, text:sanitize(slice), section:section||'body', page:prev?prev.num:undefined});
    i += step;
  }
  return out;
}
function highlight(html, patterns){
  if(!patterns.length) return html;
  const rx = new RegExp('('+patterns.join('|')+')','gi');
  return html.replace(rx, m=>`<mark>${m}</mark>`);
}
function closeCooccur(txt, rx1, rx2, max=50){
  const arr=[]; let m;
  while((m=rx1.exec(txt))){ arr.push(m.index); if(rx1.lastIndex===m.index) rx1.lastIndex++; }
  let near=false; let n;
  while((n=rx2.exec(txt))){
    const pos=n.index; near = arr.some(i=>Math.abs(i-pos)<=max); if(near) break;
    if(rx2.lastIndex===n.index) rx2.lastIndex++;
  }
  rx1.lastIndex=0; rx2.lastIndex=0;
  return near;
}
function scoreWindow(win, cfg){
  const txt = win.text;
  for(const r of cfg.must){ if(!r.test(txt)) return 0; }
  let s=1.0;
  for(const g of cfg.should){ const [pattern, w]=g; if(pattern.test(txt)) s+=w; }
  if(cfg.must.length>=2 && closeCooccur(txt, new RegExp(cfg.must[0], 'i'), new RegExp(cfg.must[1], 'i'), 60)) s+=0.3;
  for(const [sectRx,boost] of cfg.sectionBoost||[]){ if(sectRx.test(win.section)) s*=boost; }
  for(const ex of cfg.exclude||[]){ if(ex.test(txt)) s-=0.6; }
  return Math.max(0, s);
}
function buildPatternList(sdId){
  const cfg = TA[sdId]; if(!cfg) return {cfg, mark:[]};
  const marks=[];
  cfg.must.forEach(r=>marks.push(r.source));
  (cfg.should||[]).forEach(([r])=>marks.push(r.source));
  return {cfg, mark:marks};
}
async function extractTextFromFile(f){
  const buf=await f.arrayBuffer(); const ext=f.name.toLowerCase().split('.').pop();
  if(ext==='pdf'){
    const pdfLib = window['pdfjsLib'];
    if(!pdfLib) return '';
    const pdf=await pdfLib.getDocument({data:buf}).promise; let out='';
    for(let i=1;i<=pdf.numPages;i++){
      const page=await pdf.getPage(i); const c=await page.getTextContent();
      out += ` [[PAGE:${i}]] ` + c.items.map(it=>it.str).join(' ') + '\n';
    }
    return out.replace(/\s+/g,' ').trim();
  }else if(ext==='docx'){
    const res=await window.mammoth.extractRawText({arrayBuffer:buf});
    return (res.value||'').replace(/\s+/g,' ').trim();
  }else if(ext==='txt'){
    return new TextDecoder().decode(new Uint8Array(buf)).replace(/\s+/g,' ').trim();
  }
  return '';
}
const TA=(()=>{ // taxonomy config
  const ADV = /adenovirus|adeno[-\s]?virus|ad5|ad26|adenoviral/i;
  const SECBOOST = [[/(materials?|methods?|méthodes?)/i, 1.5],[/(results?|discussion)/i, 1.2]];
  function cfg(must2, shouldGroups, exclude=[]){ return { must:[ADV, must2], should:shouldGroups, exclude, sectionBoost:SECBOOST }; }
  return {
    clarification: cfg(/clarifi|centrifug|depth\s?filter|floccul|turbid|harvest/i, [[/depth\s?filter|clari|centrifug/i, 1.2],[/floccul|polydadmac|turbidity/i, 1.0]], [/AAV|adeno[-\s]?associated|lentivirus|retrovirus/i]),
    tff_df: cfg(/diafiltrat|ultra?filtrat|tff|membrane/i, [[/tff|ultra?filtrat/i, 1.5],[/diafiltrat|buffer exchange/i, 1.2],[/membrane|cassette|NMWL|cut[\s-]?off/i, 1.0]]),
    capture_chrom: cfg(/chromatograph|column|resin|ligand/i, [[/affinity|AVB|heparin|monolith|membrane adsorber/i, 2.0],[/anion exchange|AEX|quaternary amine|QA/i, 1.5],[/cation exchange|CEX|carboxymethyl/i, 1.2]]),
    polishing: cfg(/polish|ion\s?exchange|SEC|size exclusion|flow[-\s]?through/i, [[/AEX|CEX|multimodal|hydrophobic/i, 1.4],[/aggregate|host cell protein|DNA residual/i, 1.1]]),
    formulation: cfg(/formulat|excipient|stability|buffer|surfactant|trehalose|sucrose/i, [[/pH|osmol|surfactant|polysorbate/i, 1.2],[/cryoprotect|stabilit/i, 1.1]]),
    final_filtration: cfg(/final\s?filtrat|steril(e|ity)\s?filter|0[.,]2\s?μ?m/i, [[/bioburden|sterility/i, 1.2]]),
    cell_bank_seed: cfg(/cell\sbank|seed\s?train|master\s?cell\sbank/i, [[/seed\s?train/i,1.2]]),
    production_bioreactor: cfg(/bioreactor|bioréacteur|perfusion|fed[-\s]?batch|batch/i, [[/perfusion|ATF|TFF\s?loop/i,1.4]]),
    infection_strategy: cfg(/infection|MOI|multiplicity/i, [[/MOI|infection strategy/i,1.4]]),
    harvest_lysis: cfg(/harvest|lysi(s|e)|detergent|benzonase|nuclease/i, [[/harvest|clarification/i,1.1]]),
    ipc: cfg(/in[-\s]?process|IPC|process control|en[-\s]?cours\sde\sprocédé/i, [[/specification|criteria/i,1.0]]),
    handoff_ds: cfg(/handoff|tech\s?transfer|transfer|intermediate/i, [[/hold\s?time|storage/i,1.0]]),
    hold_bulk: cfg(/hold\s?bulk|freeze\/?thaw|storage/i, [[/freeze|thaw|stability/i,1.2]]),
    aseptic_fill: cfg(/aseptic|filling|vials?|syringes?|cartridges?/i, [[/grade\s?A|B|C|isolator/i,1.1]]),
    ccc: cfg(/container|closure|compatib|extractable|leachable/i, [[/compatibility|E&L/i,1.2]]),
    fit: cfg(/filter\s?integrity|bubble\s?point|diffusion/i, [[/integrity|sterile/i,1.2]]),
    vi_aql: cfg(/visual|inspection|AQL/i, [[/defects?|cosmetic/i,1.0]]),
    cold_chain: cfg(/cold\s?chain|refrigerated|frozen|label/i, [[/shipping|logistics/i,1.0]]),
    identity: cfg(/identity|PCR|sequenc/i, [[/qPCR|sequencing/i,1.2]]),
    potency: cfg(/potency|infectiv|titer|titre/i, [[/TCID50|plaque assay|FFU/i,1.4]]),
    impurities: cfg(/impurit|HCP|host\s?cell\s?protein|residual\s?DNA/i, [[/BCA|PicoGreen|dd?PCR/i,1.2]]),
    size_agg: cfg(/size|aggregation|DLS|TEM|SEC/i, [[/hydrodynamic|aggregate/i,1.1]]),
    qPCR: cfg(/qPCR|ddPCR|quantitative\s?PCR/i, [[/primers?|amplicon/i,1.1]]),
    stability_indic: cfg(/stability[-\s]?indicat|degradation|stress/i, [[/ICH|accelerated/i,1.2]]),
    change_control: cfg(/change\s?control/i, [[/impact assessment|risk/i,1.1]]),
    deviation_capa: cfg(/deviation|CAPA/i, [[/root cause|investigation/i,1.1]]),
    training_qual: cfg(/training|qualification|competenc/i, [[/program|matrix/i,1.0]]),
    gxp_docs: cfg(/GxP|GMP|documentation|SOP|record/i, [[/document control|revision/i,1.1]]),
    suppliers: cfg(/supplier|vendor|qualification|material/i, [[/audit|certificate/i,1.0]]),
    bmr: cfg(/batch\s?record|BMR|review/i, [[/deviation|reconciliation/i,1.0]]),
    reg_strategy: cfg(/regulator|CTA|IND|BLA|dossier/i, [[/strategy|pathway/i,1.0]]),
    control_strategy: cfg(/control\s?strategy|CPP|CQA|design\s?space/i, [[/risk assessment|QbD/i,1.2]]),
    specs_release: cfg(/specifications?|release|acceptance/i, [[/limits?|criteria/i,1.1]]),
    comparability: cfg(/comparab|process\s?change/i, [[/equivalence|pre|post/i,1.0]]),
    ppq: cfg(/PPQ|process\s?validation|conformance/i, [[/protocol|report|runs?/i,1.1]]),
    proc_char: cfg(/process\s?characteri[sz]ation|DoE|design of experiments/i, [[/parameters?|responses?/i,1.1]])
  };
})();

function buildPatternListForID(sdId){
  const cfg = TA[sdId]; if(!cfg) return {cfg, mark:[]};
  const marks=[]; cfg.must.forEach(r=>marks.push(r.source)); (cfg.should||[]).forEach(([r])=>marks.push(r.source));
  return {cfg, mark:marks};
}

async function targetedAnalyze(){
  state.analysis.targeted = {};
  const sdIds = state.request.details||[];
  if(!sdIds.length) return;

  const docTexts=[];
  for(const f of state.uploads){ const t = await extractTextFromFile(f); docTexts.push({name:f.name, text:t}); }

  for(const sdId of sdIds){
    const {cfg, mark} = buildPatternListForID(sdId);
    if(!cfg){ continue; }
    const results = { labelFR:'', labelEN:'', docs:[], papers:[], summary:'' };
    for(const arr of Object.values(SUBDOMAINS)){ const m=arr.find(z=>z.id===sdId); if(m){ results.labelFR=m.fr; results.labelEN=m.en; break; } }

    for(const d of docTexts){
      if(!d.text) continue;
      const wins = windowsFromText(d.text, 850, 250);
      const scored = wins.map(w=>({ ...w, score: scoreWindow(w, cfg) }))
                         .filter(x=>x.score>0)
                         .sort((a,b)=>b.score-a.score)
                         .slice(0,8);
      if(!scored.length) continue;
      const avg = scored.slice(0,5).reduce((a,c)=>a+c.score,0)/Math.min(5,scored.length);
      results.docs.push({
        name:d.name, score:+avg.toFixed(2),
        snippets: scored.map(s=>({
          score:+s.score.toFixed(2),
          section:s.section, page:s.page,
          html: highlight(s.text, mark)
        }))
      });
    }
    results.docs.sort((a,b)=>b.score-a.score);

    for(const p of (state.literature.selected||[])){
      const abs = (p.abstract||'').replace(/\s+/g,' ');
      if(!abs) continue;
      const wins = windowsFromText(abs, 700, 200);
      const scored = wins.map(w=>({ ...w, score: scoreWindow(w, cfg) }))
                         .filter(x=>x.score>0);
      scored.sort((a,b)=>b.score-a.score);
      const top = scored.slice(0,5);
      if(!top.length) continue;
      const avg = top.slice(0,3).reduce((a,c)=>a+c.score,0)/Math.min(3,top.length);
      const link = p.meta.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${p.meta.pmid}/` : (p.meta.pmcid?`https://europepmc.org/article/PMC/${p.meta.pmcid}`:'#');
      results.papers.push({
        title:p.meta.title, year:p.meta.year, journal:p.meta.journal, score:+avg.toFixed(2), link,
        snippets: top.map(s=>({ score:+s.score.toFixed(2), html:highlight(s.text, mark) }))
      });
    }
    results.papers.sort((a,b)=>b.score-a-score);

    const HF_TOKEN = "hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
    const HF_MODEL = "facebook/bart-large-cnn";
    const baseText = [
      ...results.docs.flatMap(d=>d.snippets.slice(0,3).map(s=>s.html.replace(/<[^>]+>/g,' '))),
      ...results.papers.flatMap(p=>p.snippets.slice(0,2).map(s=>s.html.replace(/<[^>]+>/g,' ')))
    ].join(' ');
    async function summarize(t){
      if(!HF_TOKEN.startsWith('hf_')) return (t||'').split(/[\.\!\?]\s/).filter(x=>x.length>40).slice(0,12).join('. ') + '.';
      try{
        const r=await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`,{
          method:'POST',headers:{Authorization:`Bearer ${HF_TOKEN}`,'Content-Type':'application/json'},
          body:JSON.stringify({inputs:(t||'').slice(0,7000)})
        });
        const j=await r.json();
        return Array.isArray(j)&&j[0]?.summary_text ? j[0].summary_text : (t||'').slice(0,1400);
      }catch(_){return (t||'').slice(0,1400);}
    }
    results.summary = sanitize(await summarize(baseText));

    state.analysis.targeted[sdId] = results;
  }
}

/* Rendu workspace */
function renderTargeted(){
  const cont=document.getElementById('sdResults'); cont.innerHTML='';
  const chips=[...document.querySelectorAll('#sdChips .chip')];
  const activeIds = chips.filter(c=>c.classList.contains('active')).map(c=>c.dataset.id);
  if(!activeIds.length){ cont.innerHTML=`<div class="muted">${t('noActiveSD')}</div>`; return; }

  activeIds.forEach(id=>{
    const pack=state.analysis.targeted[id]; if(!pack) return;
    const title = (lang()==='fr'?pack.labelFR:pack.labelEN) || id;
    const sec=document.createElement('section'); sec.className='panel';
    sec.innerHTML = `<h3>${esc(title)}</h3>`;

    if(pack.docs.length){
      const docsWrap=document.createElement('div');
      docsWrap.innerHTML=`<div class="result-meta"><strong>${t('docsInternal')}</strong></div>`;
      pack.docs.forEach(d=>{
        const card=document.createElement('div'); card.className='result-card';
        card.innerHTML=`
          <div><strong>${esc(d.name)}</strong></div>
          <div class="bar"><span style="width:${Math.min(100, d.score*12)}%"></span></div>
          ${d.snippets.map(s=>`
            <div class="snip">
              <div class="meta">${t('scoreLabel')} ${s.score}${s.page?` · ${t('pageShort')} ${s.page}`:''}${s.section?` · ${s.section}`:''}</div>
              <div>${s.html}</div>
            </div>
          `).join('')}
        `;
        docsWrap.appendChild(card);
      });
      sec.appendChild(docsWrap);
    }

    if(pack.papers.length){
      const papWrap=document.createElement('div');
      papWrap.style.marginTop='10px';
      papWrap.innerHTML=`<div class="result-meta"><strong>${t('literature')}</strong></div>`;
      pack.papers.forEach(p=>{
        const card=document.createElement('div'); card.className='result-card';
        card.innerHTML=`
          <div><strong>${esc(p.title)}</strong></div>
          <div class="result-meta">${esc(p.journal||'')} · ${esc(p.year||'')}</div>
          <div class="bar"><span style="width:${Math.min(100, p.score*12)}%"></span></div>
          ${p.snippets.map(s=>`
            <div class="snip">
              <div class="meta">${t('scoreLabel')} ${s.score}</div>
              <div>${s.html}</div>
            </div>
          `).join('')}
          <div><a class="tag" href="${p.link}" target="_blank" rel="noopener">${t('open')}</a></div>
        `;
        papWrap.appendChild(card);
      });
      sec.appendChild(papWrap);
    }

    const sum=document.createElement('div'); sum.style.marginTop='10px';
    sum.innerHTML=`
      <div class="result-meta"><strong>${t('targetedSummary')}</strong></div>
      <pre class="code">${esc(pack.summary||'(empty)')}</pre>
    `;
    sec.appendChild(sum);

    cont.appendChild(sec);
  });
}
function buildWorkspace(){
  const docList=document.getElementById('docList'); docList.innerHTML='';
  state.uploads.forEach(f=>{
    const it=document.createElement('div'); it.className='source-item';
    it.innerHTML=`<input type="checkbox" checked style="width:auto"><span>${esc(f.name||'Document')}</span>`;
    docList.appendChild(it);
  });

  const artList=document.getElementById('artList'); artList.innerHTML='';
  (state.literature.selected||[]).forEach((a,i)=>{
    const it=document.createElement('div'); it.className='source-item';
    it.innerHTML=`<input type="checkbox" checked data-i="${i}" style="width:auto"><span>${esc(a.meta.title||'Article')}</span>`;
    artList.appendChild(it);
  });

  const chips = document.getElementById('sdChips'); chips.innerHTML='';
  const ids = state.request.details||[];
  const L = (id)=>{ for(const arr of Object.values(SUBDOMAINS)){const f=arr.find(z=>z.id===id); if(f) return (lang()==='fr'?f.fr:f.en); } return id; };
  ids.forEach(id=>{
    const chip=document.createElement('button'); chip.className='chip active'; chip.dataset.id=id;
    chip.textContent = L(id);
    chip.onclick=()=>{ chip.classList.toggle('active'); renderTargeted(); };
    chips.appendChild(chip);
  });

  const ov=document.getElementById('overview');
  const d=state.request;
  ov.innerHTML = `
    <div class="pub-card">
      <div><strong>${t('ctx')}</strong></div>
      <div class="muted">${t('biomolecule')}: ${esc(d.biomolecule||'-')} · ${t('domain')}: ${esc(L_dom(d.domain)||'-')}</div>
    </div>
  `;

  targetedAnalyze().then(renderTargeted);
}

/* Export PDF */
document.getElementById('exportPdf').onclick = async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt',format:'a4'});
  const M=56, W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();
  pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F');

  try{ const r=await fetch('./assets/montes-biopharma-logo.jpg'); const b=await r.blob(); const data=await blobToDataURL(b); pdf.addImage(data,'JPEG',M,M-8,160,40,'','FAST'); }catch(e){}
  setText(pdf,'#3A49FF',18,'bold'); pdf.text(t('pdfTitle'), M+180, M+14);
  pdf.setDrawColor(58,73,255); pdf.setLineWidth(2); pdf.line(M, M+50, W-M, M+50);
  let y=M+74;

  y = putHeading(pdf, t('pdfOverview'), y, 13, '#3A49FF', M,W,H);
  const d=state.request; const domainLabel = L_dom(d.domain||'downstream');
  y=putParagraph(pdf,`${t('biomolecule')}: ${d.biomolecule||'-'} · ${t('domain')}: ${domainLabel||'-'}`,y,M,W,H,11);

  const activeIds = (state.request.details||[]);
  for(const id of activeIds){
    const pack=state.analysis.targeted[id]; if(!pack) continue;
    const title=(lang()==='fr'?pack.labelFR:pack.labelEN)||id;
    y = putHeading(pdf, title, y, 13, '#3A49FF', M,W,H);
    y = putParagraph(pdf, pack.summary||'(no summary)', y, M,W,H,11);
    y = putParagraph(pdf, t('pdfEvidences')+':', y, M,W,H,11);
    for(const d of pack.docs.slice(0,3)){
      y = putParagraph(pdf, `• ${d.name} [${t('scoreLabel')} ${d.score}]`, y, M,W,H,11);
      for(const s of d.snippets.slice(0,2)){ y = putParagraph(pdf, `   - ${s.page?(`${t('pageShort')}${s.page} `):''}${s.section?(`[${s.section}] `:'')}${s.html.replace(/<[^>]+>/g,' ')}`, y, M,W,H,10); }
    }
    for(const p of pack.papers.slice(0,3)){
      y = putParagraph(pdf, `• ${p.title} (${p.journal||''} ${p.year||''}) [${t('scoreLabel')} ${p.score}]`, y, M,W,H,11);
      for(const s of p.snippets.slice(0,1)){ y = putParagraph(pdf, `   - ${s.html.replace(/<[^>]+>/g,' ')}`, y, M,W,H,10); }
    }
  }

  pdf.save((lang()==='fr'?'protocole-documentaire-analyse-ciblee.pdf':'documentary-protocol-targeted.pdf'));
};
function setText(pdf,hex,size,weight){const [r,g,b]=hexToRGB(hex); pdf.setTextColor(r,g,b); pdf.setFont('helvetica', weight==='bold'?'bold':'normal'); pdf.setFontSize(size);}
function putHeading(pdf,text,y,size,color,M,W,H){ if(y + size + 18 > H - M){ pdf.addPage(); y=M; } const [r,g,b]=hexToRGB(color); pdf.setTextColor(r,g,b); pdf.setFont('helvetica','bold'); pdf.setFontSize(size); pdf.text(text,M,y); pdf.setDrawColor(210,210,210); pdf.setLineWidth(.6); pdf.line(M,y+6,W-M,y+6); return y+18;}
function putParagraph(pdf,text,y,M,W,H,size=11){ pdf.setTextColor(0,0,0); pdf.setFont('helvetica','normal'); pdf.setFontSize(size); const chunks=pdf.splitTextToSize(text,W-2*M); for(const ln of chunks){ if(y>H-M){ pdf.addPage(); y=M; } pdf.text(ln,M,y); y+=14; } return y+4;}
function hexToRGB(hex){const h=hex.replace('#','');const n=parseInt(h,16);return [(n>>16)&255,(n>>8)&255,n&255];}
function blobToDataURL(blob){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(blob);});}

/* Contact mailto */
function updateMailto(){
  const name = document.getElementById('c_name').value || '';
  const org  = document.getElementById('c_org').value || '';
  const email= document.getElementById('c_email').value || '';
  const msg  = document.getElementById('c_msg').value || '';
  const subject = encodeURIComponent( lang()==='fr' ? 'Contact — Projet bioprocédé' : 'Contact — Bioprocess project' );
  const body = encodeURIComponent(
    `${lang()==='fr'?'Nom':'Name'}: ${name}\n${lang()==='fr'?'Société':'Company'}: ${org}\nEmail: ${email}\n\n${msg}`
  );
  document.getElementById('c_mailto').href = `mailto:info@montes-biopharma.com?subject=${subject}&body=${body}`;
}
['c_name','c_org','c_email','c_msg'].forEach(id=>document.getElementById(id).addEventListener('input', updateMailto));
updateMailto();

/* Init années */
document.getElementById('year').textContent=new Date().getFullYear();
document.getElementById('year2').textContent=new Date().getFullYear();
</script>
</body>
</html>

<!doctype html>
<html lang="fr" data-lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Montes BioPharma — AI Literature Assistant</title>
<meta name="color-scheme" content="dark"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#060b19;--bg2:#0b1326;--text:#eaf2ff;--muted:#a6b8d6;
  --g:#7CF45B;--b:#2456FF;--glass:rgba(15,26,45,.42);--border:rgba(124,244,91,.38);
  --inner:rgba(36,86,255,.10);--radius:16px;--danger:#ff6b6b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Roboto,system-ui,-apple-system,"Segoe UI",Ubuntu,Arial,sans-serif;color:var(--text);
  background:
    radial-gradient(1000px 500px at 20% -10%, rgba(36,86,255,.22), transparent 60%),
    radial-gradient(900px 480px at 85% -8%, rgba(124,244,91,.12), transparent 65%),
    linear-gradient(180deg, var(--bg1), var(--bg2) 40%, #0a1122 100%);
  overflow-x:hidden;
}
#particlesCanvas{position:fixed;inset:0;z-index:0;pointer-events:none}

header{
  position:sticky;top:0;z-index:15;
  background:linear-gradient(90deg, rgba(124,244,91,.10), rgba(36,86,255,.16));
  backdrop-filter:blur(10px) saturate(160%);
  border-bottom:1px solid var(--border);
}
.nav{max-width:1180px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;gap:12px}
.logo{height:42px;width:auto;object-fit:contain}
.brand{font-weight:700;letter-spacing:.35px}
.lang{margin-left:auto;display:flex;gap:8px}
.lang button{background:rgba(9,20,40,.6);border:1px solid rgba(124,244,91,.35);color:var(--text);border-radius:999px;padding:6px 10px;cursor:pointer}
.lang button.active{background:linear-gradient(90deg,var(--g),var(--b));color:#02121f;border:none}

.container{max-width:1180px;margin:24px auto;padding:0 18px;position:relative;z-index:1}
.hero{display:flex;align-items:center;gap:16px;margin:14px 0}
.hero h1{
  margin:0;font-size:clamp(22px,4vw,36px);
  background:linear-gradient(90deg, var(--g), var(--b));-webkit-background-clip:text;background-clip:text;color:transparent;
  text-shadow:0 0 32px rgba(124,244,91,.55), 0 0 32px rgba(36,86,255,.45);
}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 30%), var(--glass);
  border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:0 18px 40px rgba(0,0,0,.55), inset 0 0 0 1px var(--inner);
  backdrop-filter: blur(12px) saturate(120%);
  padding:20px;margin-bottom:18px;
}
.muted{color:var(--muted)} a{color:var(--g)} a:hover{text-decoration:underline}
.btn{
  appearance:none;border:none;cursor:pointer;font-weight:700;border-radius:12px;
  padding:12px 18px;background:linear-gradient(90deg,var(--g),var(--b));color:#02121f;
  box-shadow:0 10px 28px rgba(36,86,255,.24),0 10px 28px rgba(124,244,91,.28);
}
.btn.secondary{background:rgba(9,20,40,.6);color:var(--text);border:1px solid rgba(124,244,91,.3)}
.controls{display:flex;gap:10px;flex-wrap:wrap}

.step{display:none} .step.active{display:block}
.grid{display:grid;gap:14px}
.row{display:grid;gap:10px}
@media(min-width:760px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
input,select,textarea{
  width:100%;background:rgba(9,20,40,.55);color:var(--text);
  border:1px solid rgba(124,244,91,.30);border-radius:12px;padding:12px 14px;outline:none;backdrop-filter: blur(6px);
  transition:border .2s, box-shadow .2s, background .2s;box-shadow: inset 0 0 0 1px rgba(36,86,255,.10);
}
input:focus,select:focus,textarea:focus{
  border-color:var(--g);background:rgba(9,20,40,.68);
  box-shadow:0 0 0 3px rgba(124,244,91,.18), inset 0 0 0 1px rgba(36,86,255,.12);
}
.pub-card{
  border:1px solid rgba(124,244,91,.28);border-radius:14px;padding:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%), rgba(12,21,42,.38);
  display:grid;gap:8px;backdrop-filter: blur(10px) saturate(120%);box-shadow: inset 0 0 0 1px rgba(36,86,255,.10);
}
.tag{font-size:11px;padding:4px 8px;border:1px solid rgba(124,244,91,.28);border-radius:999px;color:#cfe6ff;background:rgba(9,20,40,.45)}
hr.sep{border:none;border-top:1px solid rgba(124,244,91,.25);margin:10px 0}
pre#preview{white-space:pre-wrap}

/* Progress bar */
.progress{position:sticky;top:70px;z-index:10;margin:10px 0 16px;background:rgba(9,20,40,.5);border:1px solid rgba(124,244,91,.25);border-radius:999px;overflow:hidden;height:10px}
.progress .bar{height:100%;width:0;background:linear-gradient(90deg,var(--g),var(--b));box-shadow:0 0 18px rgba(124,244,91,.6)}
.warn{color:var(--danger);font-weight:600}
</style>
</head>
<body>
<canvas id="particlesCanvas"></canvas>

<header>
  <div class="nav">
    <img src="./assets/montes-biopharma-logo.svg" alt="Montes BioPharma" class="logo">
    <div class="brand">Montes BioPharma</div>
    <div class="lang">
      <button id="btnFR" class="active">FR</button>
      <button id="btnEN">EN</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="hero">
    <img src="./assets/montes-biopharma-logo.svg" alt="Montes BioPharma" class="logo" style="height:72px;filter:drop-shadow(0 10px 26px rgba(124,244,91,.30)) drop-shadow(0 12px 30px rgba(36,86,255,.22))">
    <h1 data-i="heroTitle">Purification Adenovirus — Guided literature & protocol synthesis</h1>
  </div>

  <div class="progress"><div class="bar" id="pbar"></div></div>

  <!-- Étape 1: Contexte -->
  <section id="step1" class="card step active">
    <h2 data-i="s1Title">Step 1 — Context & compliance</h2>
    <p class="muted" data-i="s1Text">Professional use only. This application provides a literature-based documentary scaffold. <b>No experimental parameters or operational SOP are provided.</b></p>
    <label style="display:flex;align-items:flex-start;gap:10px;margin-top:8px">
      <input type="checkbox" id="compliance" style="width:auto;margin-top:4px">
      <span data-i="s1Check">I confirm I am a qualified professional and rely on validated internal SOPs.</span>
    </label>
    <div class="controls" style="margin-top:10px">
      <button class="btn" id="to2" data-i="btnContinue">Continue</button>
    </div>
  </section>

  <!-- Étape 2: Paramètres -->
  <section id="step2" class="card step">
    <h2 data-i="s2Title">Step 2 — Parameters & techniques</h2>
    <div class="row row-3">
      <div><label data-i="labVector">Vector</label><input id="vector" placeholder="Adenovirus"></div>
      <div><label data-i="labSerotype">Serotype</label><input id="serotype" placeholder="Ad5"></div>
      <div><label data-i="labCellLine">Cell line</label><input id="cellLine" placeholder="HEK293 / PER.C6"></div>
    </div>

    <div class="card" style="padding:14px;margin-top:12px">
      <strong data-i="techTitle">Downstream techniques</strong>
      <div class="row row-3" style="margin-top:8px">
        <label><input type="checkbox" class="tech" value="Clarification"> <span data-i="tClar">Clarification</span></label>
        <label><input type="checkbox" class="tech" value="Capture"> <span data-i="tCapt">Capture (affinity / AEX)</span></label>
        <label><input type="checkbox" class="tech" value="Polishing"> <span data-i="tPol">Polishing</span></label>
        <label><input type="checkbox" class="tech" value="TFF"> <span data-i="tTff">TFF (Concentration / Diafiltration)</span></label>
        <label><input type="checkbox" class="tech" value="QC"> <span data-i="tQc">Quality controls (attributes)</span></label>
        <label><input type="checkbox" class="tech" value="Formulation"> <span data-i="tForm">Formulation / Documentation</span></label>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label data-i="labKeywords">Additional keywords</label><input id="keywords" placeholder="chromatography, anion exchange, membrane, affinity"></div>
    </div>

    <div class="row row-2" style="margin-top:8px">
      <div>
        <label data-i="labYears">Recency window</label>
        <select id="yearsWindow">
          <option value="1">1</option><option value="2" selected>2</option><option value="5">5</option><option value="10">10</option>
        </select>
      </div>
      <div>
        <label data-i="labMax">Max articles</label>
        <select id="retMax"><option value="5">5</option><option value="10" selected>10</option><option value="20">20</option><option value="50">50</option></select>
      </div>
    </div>

    <label style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <input type="checkbox" id="onlyOA" checked style="width:auto">
      <span data-i="labOA">Only open access (full text)</span>
    </label>

    <div class="controls" style="margin-top:12px">
      <button class="btn secondary" id="back2" data-i="btnBack">Back</button>
      <button class="btn" id="to3" data-i="btnContinue">Continue</button>
    </div>
  </section>

  <!-- Étape 3: Recherche -->
  <section id="step3" class="card step">
    <h2 data-i="s3Title">Step 3 — Search (Europe PMC, abstracts & full text)</h2>
    <div class="controls" style="margin-top:8px">
      <button class="btn" id="runSearch" data-i="btnSearch">Run search</button>
      <span id="searchInfo" class="muted"></span>
    </div>
    <hr class="sep">
    <div id="results" class="grid"></div>
    <div class="controls" style="margin-top:12px">
      <button class="btn secondary" id="back3" data-i="btnBack">Back</button>
      <button class="btn" id="to4" data-i="btnContinue">Continue</button>
    </div>
  </section>

  <!-- Étape 4: Sélection & Analyse IA -->
  <section id="step4" class="card step">
    <h2 data-i="s4Title">Step 4 — Selection & AI analysis</h2>
    <p class="muted" data-i="s4Text">Select <b>at least 5 articles</b> then run analysis. We extract relevant sentences and request the AI to produce a high-level protocol (no operational parameters). Footnotes will cite sources.</p>
    <div class="controls">
      <button class="btn" id="analyzeBtn" data-i="btnAnalyze">Analyze selected articles</button>
      <span id="selInfo" class="muted"></span>
    </div>
    <hr class="sep">
    <div id="selectedList" class="grid"></div>
    <div class="controls" style="margin-top:12px">
      <button class="btn secondary" id="back4" data-i="btnBack">Back</button>
      <button class="btn" id="to5" data-i="btnContinue">Continue</button>
    </div>
  </section>

  <!-- Étape 5: Aperçu & PDF -->
  <section id="step5" class="card step">
    <h2 data-i="s5Title">Step 5 — Preview & PDF</h2>
    <div class="card" style="padding:14px;margin:8px 0">
      <div class="warn" data-i="safety">Safety note: output is a literature-based documentary scaffold. It must not be used as experimental instructions or as a substitute for validated SOPs.</div>
    </div>
    <pre id="preview"></pre>
    <div class="controls" style="margin-top:10px">
      <button class="btn" id="exportPdf" data-i="btnPdf">Export PDF</button>
      <button class="btn secondary" id="restart" data-i="btnRestart">Restart</button>
    </div>
  </section>

  <p class="muted" style="text-align:center;margin:28px 0 48px">
    © <span id="year"></span> Montes BioPharma — Europe PMC / PubMed. Open-access filtering enabled. No experimental parameters or SOPs.
  </p>
</main>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script>
/* ===== Particules ===== */
const cv=document.getElementById('particlesCanvas'),cx=cv.getContext('2d');let W,H,PTS=[];
function size(){W=cv.width=innerWidth;H=cv.height=innerHeight} size(); addEventListener('resize',size);
function R(a,b){return a+Math.random()*(b-a)}
function spawn(){return{x:R(0,W),y:R(0,H),vx:R(-.06,.06),vy:-R(.05,.16),r:R(.9,2.1),t:R(0,6.28),tw:R(.5,1.0)}}
PTS=Array.from({length:Math.min(220,Math.round((W*H)/15000))},spawn);
(function loop(){requestAnimationFrame(loop);cx.clearRect(0,0,W,H);
for(const p of PTS){p.t+=.02;const a=.2+.4*Math.abs(Math.sin(p.t))*p.tw;p.x+=p.vx+Math.sin(p.t*.5)*.04;p.y+=p.vy;
if(p.x<-5)p.x=W+5;if(p.x>W+5)p.x=-5;if(p.y<-5){p.y=H+5;p.x=Math.random()*W;}
cx.beginPath();cx.arc(p.x,p.y,p.r,0,6.283);cx.fillStyle=`rgba(124,244,91,${a})`;cx.shadowColor='rgba(124,244,91,.75)';cx.shadowBlur=8;cx.fill();cx.shadowBlur=0;}})();

/* ===== i18n ===== */
const I={
  fr:{heroTitle:"Purification Adénovirus — Sélection & Synthèse bibliographique",s1Title:"Étape 1 — Contexte & conformité",s1Text:"Usage strictement professionnel. Cette application fournit une ossature documentaire issue de la littérature. Aucun paramètre expérimental ou SOP opératoire n’est fourni.",s1Check:"Je confirme être un professionnel habilité et m’appuyer sur des SOP internes validées.",btnContinue:"Continuer",s2Title:"Étape 2 — Paramètres & techniques",labVector:"Vecteur",labSerotype:"Sérotype",labCellLine:"Lignée cellulaire",techTitle:"Techniques Downstream",tClar:"Clarification",tCapt:"Capture (affinité / AEX)",tPol:"Polishing",tTff:"TFF (Concentration / Diafiltration)",tQc:"Contrôles qualité (attributs)",tForm:"Formulation / Documentation",labKeywords:"Mots-clés complémentaires",labYears:"Fenêtre (années récentes)",labMax:"Nombre max. d’articles",labOA:"Uniquement open access (texte intégral)",btnBack:"Retour",s3Title:"Étape 3 — Recherche (Europe PMC, abstracts & texte intégral)",btnSearch:"Lancer la recherche",s4Title:"Étape 4 — Sélection & analyse IA",s4Text:"Coche au moins 5 articles puis lance l’analyse. Nous extrayons des phrases pertinentes et demandons à l’IA de produire un protocole de haut niveau (sans paramètres opératoires). Les notes de bas de page citent les sources.",btnAnalyze:"Analyser les articles sélectionnés",s5Title:"Étape 5 — Aperçu & PDF",safety:"Note sécurité : sortie à visée documentaire issue de la littérature, non utilisable comme instructions expérimentales ou substitut d’une SOP validée.",btnPdf:"Exporter le PDF",btnRestart:"Recommencer"},
  en:{heroTitle:"Adenovirus Purification — Guided Literature & Protocol Synthesis",s1Title:"Step 1 — Context & compliance",s1Text:"Professional use only. This application provides a literature-based documentary scaffold. No experimental parameters or operational SOP are provided.",s1Check:"I confirm I am a qualified professional and rely on validated internal SOPs.",btnContinue:"Continue",s2Title:"Step 2 — Parameters & techniques",labVector:"Vector",labSerotype:"Serotype",labCellLine:"Cell line",techTitle:"Downstream techniques",tClar:"Clarification",tCapt:"Capture (affinity / AEX)",tPol:"Polishing",tTff:"TFF (Concentration / Diafiltration)",tQc:"Quality controls (attributes)",tForm:"Formulation / Documentation",labKeywords:"Additional keywords",labYears:"Recency window",labMax:"Max articles",labOA:"Only open access (full text)",btnBack:"Back",s3Title:"Step 3 — Search (Europe PMC, abstracts & full text)",btnSearch:"Run search",s4Title:"Step 4 — Selection & AI analysis",s4Text:"Select at least 5 articles then run analysis. We extract relevant sentences and request the AI to produce a high-level protocol (no operational parameters). Footnotes will cite sources.",btnAnalyze:"Analyze selected articles",s5Title:"Step 5 — Preview & PDF",safety:"Safety note: output is a literature-based documentary scaffold. It must not be used as experimental instructions or as a substitute for validated SOPs.",btnPdf:"Export PDF",btnRestart:"Restart"}
};
function setLang(lang){
  document.documentElement.setAttribute('lang',lang);
  document.documentElement.dataset.lang=lang;
  for(const el of document.querySelectorAll('[data-i]')){
    const k=el.dataset.i; el.textContent = I[lang][k] || el.textContent;
  }
  document.getElementById('btnFR').classList.toggle('active',lang==='fr');
  document.getElementById('btnEN').classList.toggle('active',lang==='en');
}
document.getElementById('btnFR').onclick=()=>setLang('fr');
document.getElementById('btnEN').onclick=()=>setLang('en');

/* ===== Wizard & Progress ===== */
const steps=['step1','step2','step3','step4','step5']; const pbar=document.getElementById('pbar');
function show(id){steps.forEach(s=>document.getElementById(s).classList.remove('active'));document.getElementById(id).classList.add('active');updateProgress(id);window.scrollTo({top:0,behavior:'smooth'});}
function updateProgress(id){const idx=steps.indexOf(id); const pct=Math.round(((idx+1)/steps.length)*100); pbar.style.width=pct+'%';}
document.getElementById('year').textContent=new Date().getFullYear();
document.getElementById('to2').onclick=()=>{if(!document.getElementById('compliance').checked){alert(I[document.documentElement.dataset.lang].s1Check);return;}show('step2');};
document.getElementById('back2').onclick=()=>show('step1');
document.getElementById('to3').onclick=()=>show('step3');
document.getElementById('back3').onclick=()=>show('step2');
document.getElementById('to4').onclick=()=>show('step4');
document.getElementById('back4').onclick=()=>show('step3');
document.getElementById('to5').onclick=()=>show('step5');
document.getElementById('restart').onclick=()=>{localStorage.removeItem('mbp_state');location.reload();};
setLang(document.documentElement.dataset.lang||'fr'); updateProgress('step1');

/* ===== State & utils ===== */
const state={
  vector:"", serotype:"", cellLine:"",
  techniques:[],
  yearsWindow:2, retMax:10, onlyOA:true,
  articles:[], abstracts:{}, fulltexts:{}, summaries:{}, aiProtocol:null, citations:[]
};
const TECH_KEYWORDS={
  Clarification:["clarification","depth filter","microfiltration","centrifugation","filter"],
  Capture:["capture","affinity","anion exchange","aex","ion exchange","chromatography","membrane"],
  Polishing:["polishing","sec","size exclusion","mixed-mode","anion exchange","cation exchange"],
  TFF:["tff","tangential flow","diafiltration","buffer exchange","concentration"],
  QC:["quality","analytics","potency","purity","endotoxin","rca","residual"],
  Formulation:["formulation","stability","storage","buffer","excipient"]
};
const REDACT=/\b\d+(?:[\.,]\d+)?\s?(?:mL|ml|L|µL|uL|°C|C|rpm|g|xg|min|h|hours?|days?|M|mM|µM|uM|%|nm|mm|cm|kDa)\b/gi;
function sanitize(txt){return (txt||"").replace(REDACT,"[…]");}
function esc(s){return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}

/* ===== Europe PMC Search (OA + abstracts) ===== */
document.getElementById('runSearch').onclick=runSearchEPMC;
async function runSearchEPMC(){
  state.vector=document.getElementById('vector').value.trim()||'adenovirus';
  state.serotype=document.getElementById('serotype').value.trim();
  state.cellLine=document.getElementById('cellLine').value.trim();
  const extra=(document.getElementById('keywords').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  state.yearsWindow=+document.getElementById('yearsWindow').value||2;
  state.retMax=+document.getElementById('retMax').value||10;
  state.onlyOA=document.getElementById('onlyOA').checked;

  const minYear=(new Date().getFullYear()-state.yearsWindow);
  const terms=[state.vector,state.serotype,state.cellLine,...extra].filter(Boolean).join(' ');
  let q = `${terms} AND PUB_YEAR:[${minYear} TO 3000] AND HAS_ABSTRACT:Y`;
  if(state.onlyOA) q += ` AND OPEN_ACCESS:Y`;
  const url = `https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(q)}&pageSize=${state.retMax}&format=json&sort_date:y`;

  document.getElementById('searchInfo').textContent = (document.documentElement.dataset.lang==='fr'?'Recherche…':'Searching…');
  try{
    const r=await fetch(url); const j=await r.json(); const res=(j.resultList?.result)||[];
    state.articles = res.map(x=>{
      const id = x.pmid ? x.pmid : x.pmcid; const src = x.pmid ? 'MED' : 'PMC';
      return {
        id, src, pmid: x.pmid || '', doi:x.doi||'',
        title: x.title || '',
        source: x.journalTitle || x.source || '',
        year: x.pubYear || '',
        authors: (x.authorString||'').split(', ').slice(0,6),
        oa: (x.isOpenAccess==="Y" || x.openAccess=="Y" || x.openAccess),
        selected:false,
        hasAbstractInline: !!x.abstractText,
        abstractInline: x.abstractText || ''
      };
    });
    renderResults();
    document.getElementById('searchInfo').textContent=`${state.articles.length} ${document.documentElement.dataset.lang==='fr'?'article(s)':'result(s)'} — Europe PMC.`;
  }catch(e){
    console.error(e);
    document.getElementById('results').innerHTML='<div class="card">Europe PMC error.</div>';
    document.getElementById('searchInfo').textContent='';
  }
}

function renderResults(){
  const box=document.getElementById('results'); box.innerHTML='';
  state.articles.forEach((a,idx)=>{
    const el=document.createElement('div'); el.className='pub-card';
    const link = a.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/` : `https://europepmc.org/article/${a.src}/${a.id}`;
    el.innerHTML=`
      <label style="display:flex;gap:10px;align-items:flex-start">
        <input type="checkbox" data-id="${a.id}" style="width:auto;margin-top:4px">
        <div>
          <div><strong>${esc(a.title)}</strong> ${a.oa?'<span class="tag">Open Access</span>':''}</div>
          <div class="muted">${esc(a.source)} · ${esc(a.year||'—')}</div>
          <div class="muted">${esc(a.authors.join(', '))}</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <span class="tag">${a.src}:${a.id}${a.pmid?` · PMID:${a.pmid}`:''}${a.doi?` · DOI:${a.doi}`:''}</span>
            <a class="tag" href="${link}" target="_blank" rel="noopener noreferrer">${document.documentElement.dataset.lang==='fr'?'Voir':'Open'}</a>
          </div>
          <div id="abs-${idx}" class="muted" style="margin-top:6px;font-size:13px"></div>
          ${a.oa?`<button class="btn secondary" data-full="${idx}" style="margin-top:8px">${document.documentElement.dataset.lang==='fr'?'Charger le texte intégral':'Load full text'}</button>`:''}
        </div>
      </label>`;
    el.querySelector('input').addEventListener('change',e=>{a.selected=e.target.checked; updateSelectionInfo();});
    box.appendChild(el);

    // show abstract inline
    const absEl=el.querySelector(`#abs-${idx}`);
    if(a.abstractInline){absEl.textContent = a.abstractInline;}
    else if(a.pmid){ // fallback quick abstract via EPMC detail
      fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/MED/${a.pmid}/abstractText?format=plain`).then(r=>r.text()).then(t=>absEl.textContent=t).catch(()=>{});
    }

    // load full text if OA
    const btn=el.querySelector(`[data-full="${idx}"]`);
    if(btn){
      btn.onclick=async()=>{
        btn.disabled=true;
        const url=`https://www.ebi.ac.uk/europepmc/webservices/rest/${a.src}/${a.id}/fullTextXML`;
        try{
          const r=await fetch(url); const xml=await r.text();
          state.fulltexts[a.id]=xml;
          btn.textContent=document.documentElement.dataset.lang==='fr'?'Texte intégral chargé':'Full text loaded';
          btn.classList.remove('secondary');
        }catch(e){btn.disabled=false;btn.textContent='Retry';}
      };
    }
  });
  updateSelectionInfo();
}

function updateSelectionInfo(){
  const n=state.articles.filter(a=>a.selected).length;
  const txt = `${n} ${document.documentElement.dataset.lang==='fr'?'article(s) sélectionné(s) — minimum requis : 5':'selected — minimum required: 5'}`;
  const selInfo=document.getElementById('selInfo'); if(selInfo) selInfo.textContent=txt;
  const L=document.getElementById('selectedList'); if(!L) return;
  const chosen=state.articles.filter(a=>a.selected);
  L.innerHTML = chosen.length
    ? chosen.map(a=>`<div class="pub-card"><strong>${esc(a.title)}</strong><div class="muted">${esc(a.source)} · ${esc(a.year||'—')} — ${a.src}:${a.id}${a.doi?` — DOI:${a.doi}`:''}</div></div>`).join('')
    : `<div class="pub-card muted">${document.documentElement.dataset.lang==='fr'?'Aucune sélection pour l’instant.':'No selection yet.'}</div>`;
}

/* ===== Analyse IA (full text + abstracts) ===== */
document.getElementById('analyzeBtn').onclick=analyzeSelected;

async function analyzeSelected(){
  const chosen=state.articles.filter(a=>a.selected);
  if(chosen.length<5){alert(document.documentElement.dataset.lang==='fr'?'Sélectionne au moins 5 articles.':'Select at least 5 articles.');return;}
  const techs=[...document.querySelectorAll('.tech:checked')].map(x=>x.value);
  if(!techs.length){alert(document.documentElement.dataset.lang==='fr'?'Sélectionne au moins une technique (Étape 2).':'Select at least one technique (Step 2).');return;}

  // Compile texts for AI: prefer fulltext XML (OA), fallback to abstracts
  const docs = [];
  for(const a of chosen){
    if(state.fulltexts[a.id]){ // XML → extract sections text
      const txt = extractTextFromFullTextXML(state.fulltexts[a.id]);
      docs.push({id:a.id,title:a.title,source:a.source,year:a.year,pmid:a.pmid,doi:a.doi,text:txt});
    }else{
      const abs = a.abstractInline || await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/${a.src}/${a.id}/abstractText?format=plain`).then(r=>r.text()).catch(()=> '');
      docs.push({id:a.id,title:a.title,source:a.source,year:a.year,pmid:a.pmid,doi:a.doi,text:abs});
    }
  }

  // User intent summary
  const intent = {
    lang: document.documentElement.dataset.lang,
    vector: document.getElementById('vector').value || 'Adenovirus',
    serotype: document.getElementById('serotype').value || '',
    cellLine: document.getElementById('cellLine').value || '',
    techniques: techs,
    keywords: (document.getElementById('keywords').value||'')
  };

  // Call backend IA
  try{
    const resp=await fetch('https://montes-bio.vercel.app/api/analyse',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ intent, docs })
    });
    if(!resp.ok){ throw new Error('AI backend error'); }
    const data=await resp.json();
    state.aiProtocol=data.protocol;   // markdown-like with [n] footnotes
    state.citations=data.citations;   // [{n,title,year,source,pmid,doi,url}]
  }catch(e){
    alert(document.documentElement.dataset.lang==='fr'?'Erreur IA (backend). Vérifie le déploiement /api/analyse et la clé OpenAI.':'AI error (backend). Check /api/analyse deployment and OpenAI key.');
    return;
  }

  renderPreview();
  alert(document.documentElement.dataset.lang==='fr'?'Analyse IA terminée.':'AI analysis complete.');
  show('step5');
}

function extractTextFromFullTextXML(xmlString){
  // naive XML text extraction: Materials/Methods/Results/Discussion when present
  const parser=new DOMParser();
  let text=''; try{
    const xml=parser.parseFromString(xmlString,'text/xml');
    const wanted=['materials','methods','materials and methods','results','discussion','introduction','conclusion'];
    const secs=[...xml.querySelectorAll('sec')];
    for(const s of secs){
      const title=(s.querySelector('title')?.textContent||'').toLowerCase();
      if(wanted.some(w=>title.includes(w))){
        const ps=[...s.querySelectorAll('p')].map(p=>p.textContent.trim()).join('\n');
        text += (title?(`\n\n### ${title}\n`):'\n\n') + ps;
      }
    }
    if(!text){ text = [...xml.querySelectorAll('p')].map(p=>p.textContent.trim()).join('\n'); }
  }catch(e){/* ignore */}
  return text;
}

/* ===== Aperçu & PDF ===== */
function renderPreview(){
  const lang=document.documentElement.dataset.lang;
  const meta=[
    document.getElementById('vector').value?`${lang==='fr'?'Vecteur':'Vector'} : ${document.getElementById('vector').value}`:null,
    document.getElementById('serotype').value?`${lang==='fr'?'Sérotype':'Serotype'} : ${document.getElementById('serotype').value}`:null,
    document.getElementById('cellLine').value?`${lang==='fr'?'Lignée cellulaire':'Cell line'} : ${document.getElementById('cellLine').value}`:null
  ].filter(Boolean).join('\n');

  // Header section
  const header = (lang==='fr'?
`# Protocole documentaire — Purification Adénovirus

${meta}

## Résumé de la demande & méthodologie
Interprétation IA de la demande utilisateur et revue de littérature (Europe PMC / PubMed) focalisée sur les sections pertinentes (Matériels & Méthodes, Résultats, Discussion) des articles open access sélectionnés. Sortie non-opérationnelle, sans paramètres expérimentaux. Citations en bas de page.`:
`# Documentary protocol — Adenovirus purification

${meta}

## Request summary & methodology
AI interpretation of the user request and literature review (Europe PMC / PubMed) focused on relevant sections (Materials & Methods, Results, Discussion) of the selected open-access articles. Non-operational output, no experimental parameters. Footnote citations included.`);

  // AI protocol body
  const body = state.aiProtocol || (lang==='fr'?'[En attente de génération IA]':'[Awaiting AI generation]');
  // Footnotes
  const foot = (state.citations||[]).map(c=>`[${c.n}] ${c.title} (${c.year}), ${c.source}${c.doi?` — DOI:${c.doi}`:''}${c.pmid?` — PMID:${c.pmid}`:''} — ${c.url}`).join('\n');

  const doc = `${header}

${body}

${lang==='fr'?'## Références (notes de bas de page)':'## References (footnotes)'}
${foot||'(none)'}
`;
  document.getElementById('preview').textContent=doc;
}

document.getElementById('exportPdf').onclick=exportPDF;

async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt',format:'a4'});
  const M=56, W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();

  // fond blanc
  pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F');

  // logo
  try{
    const res=await fetch('./assets/montes-biopharma-logo.svg'); const blob=await res.blob();
    const data=await blobToDataURL(blob);
    pdf.addImage(data,'PNG',M,M-8,160,40,'','FAST');
  }catch(e){}

  // titre
  const lang=document.documentElement.dataset.lang;
  setText(pdf,'#2456FF',18,'bold');
  pdf.text(lang==='fr'?'Protocole documentaire — Purification Adénovirus':'Documentary protocol — Adenovirus purification', M+180, M+14);
  setText(pdf,'#3a3a3a',11,'normal');

  // barres colorées
  pdf.setDrawColor(124,244,91); pdf.setLineWidth(2); pdf.line(M, M+50, W-M, M+50);
  pdf.setDrawColor(36,86,255); pdf.setLineWidth(2); pdf.line(M, M+54, W-M, M+54);

  // contenu
  let y=M+80;
  const content=document.getElementById('preview').textContent||'';
  const lines=content.split('\n');
  for(const raw of lines){
    const line=raw.trim();
    if(!line){ y+=6; continue; }
    if(line.startsWith('# ')){ y=putHeading(pdf,line.replace(/^#\s+/,'').trim(),y,16,'#2456FF',M,W,H); }
    else if(line.startsWith('## ')){ y=putHeading(pdf,line.replace(/^##\s+/,'').trim(),y,13,'#7CF45B',M,W,H); }
    else if(line.startsWith('### ')){ y=putHeading(pdf,line.replace(/^###\s+/,'').trim(),y,12,'#7CF45B',M,W,H); }
    else { y=putParagraph(pdf,line,y,M,W,H,11); }
  }
  pdf.save(lang==='fr'?'protocole-documentaire-adenovirus.pdf':'documentary-protocol-adenovirus.pdf');
}

function setText(pdf,hex,size,weight){
  const [r,g,b]=hexToRGB(hex); pdf.setTextColor(r,g,b);
  pdf.setFont('helvetica', weight==='bold'?'bold':'normal'); pdf.setFontSize(size);
}
function putHeading(pdf,text,y,size,color,M,W,H){
  if(y + size + 18 > H - M){ pdf.addPage(); pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F'); y=M; }
  setText(pdf,color,size,'bold'); pdf.text(text,M,y); y += size<14?12:16;
  pdf.setDrawColor(210,210,210); pdf.setLineWidth(.6); pdf.line(M,y,W-M,y);
  return y+12;
}
function putParagraph(pdf,text,y,M,W,H,size=11){
  setText(pdf,'#000000',size,'normal');
  const safe=sanitize(text);
  const chunks=pdf.splitTextToSize(safe,W-2*M);
  for(const ln of chunks){
    if(y > H - M){ pdf.addPage(); pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F'); y=M; }
    pdf.text(ln,M,y); y += 14;
  }
  return y+4;
}
function hexToRGB(hex){const h=hex.replace('#','');const n=parseInt(h,16);return [(n>>16)&255,(n>>8)&255,n&255];}
function blobToDataURL(blob){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(blob);});}
</script>
</body>
</html>

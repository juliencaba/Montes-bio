<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Montes BioPharma — Assistant (ossature sûre)</title>
  <meta name="color-scheme" content="dark"/>
  <!-- Police Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-1:#060b19;
      --bg-2:#0b1326;
      --text:#eaf2ff;
      --muted:#a6b8d6;

      /* Palette (fidèle capture) */
      --accentG:#7CF45B; /* vert fluo */
      --accentB:#2456FF; /* bleu profond */

      --card: rgba(15, 26, 45, .42);           /* verre fumé */
      --card-border: rgba(124,244,91,.38);     /* vert fluo bord */
      --card-inner: rgba(36,86,255,.10);       /* petit liseré bleu interne */
      --radius:16px;
      --shadow:0 18px 40px rgba(0,0,0,.55);
      --glowG:0 0 36px rgba(124,244,91,.58);
      --glowB:0 0 34px rgba(36,86,255,.42);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Roboto,system-ui,-apple-system,"Segoe UI",Ubuntu,"Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      /* OPTION B — halo bleu/vert diffus en haut pour profondeur */
      background:
        radial-gradient(1000px 500px at 20% -10%, rgba(36,86,255,.22), transparent 60%),
        radial-gradient(900px 480px at 85% -8%, rgba(124,244,91,.12), transparent 65%),
        linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 40%, #0a1122 100%);
      overflow-x:hidden;
    }

    /* Canvas particules : sous l'UI */
    #particlesCanvas{ position:fixed; inset:0; z-index:0; pointer-events:none; }

    header{
      position:sticky; top:0; z-index:3;
      background:linear-gradient(90deg, rgba(124,244,91,.10), rgba(36,86,255,.16));
      backdrop-filter:saturate(160%) blur(10px);
      border-bottom:1px solid rgba(124,244,91,.22);
      box-shadow:inset 0 -1px 0 rgba(255,255,255,.05);
    }
    .nav{ max-width:1180px; margin:0 auto; padding:12px 18px; display:flex; align-items:center; gap:14px; }
    .logo{ display:block; height:auto; width:auto; object-fit:contain; }
    .brand{ font-weight:700; letter-spacing:.35px; color:#eaf2ff }

    .container{ max-width:1180px; margin:28px auto; padding:0 18px; position:relative; z-index:2 }

    .hero{ display:flex; align-items:center; gap:16px; margin:16px 0 14px }
    .hero h1{
      margin:0; font-size:clamp(22px, 4vw, 36px);
      background:linear-gradient(90deg, var(--accentG), var(--accentB));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: var(--glowG), var(--glowB);
    }

    /* Cartes translucides “verre fumé” des étapes */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 30%), var(--card);
      border-radius:var(--radius);
      border:1px solid var(--card-border);
      box-shadow: var(--shadow), inset 0 0 0 1px var(--card-inner);
      backdrop-filter: blur(12px) saturate(120%);
      padding:20px;
    }

    /* Barre de progression + chips */
    .progress-wrap{ margin:14px 0 18px }
    .progress{
      height:12px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden;
      box-shadow: inset 0 0 12px rgba(124,244,91,.15), inset 0 0 14px rgba(36,86,255,.12);
    }
    .progress > span{ display:block; height:100%; width:0%;
      background:linear-gradient(90deg, var(--accentG), var(--accentB));
      box-shadow: var(--glowG), var(--glowB);
      transition:width .45s cubic-bezier(.2,.7,.2,1);
    }

    .steps{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px }
    .chip{
      --size:42px;
      width:var(--size); height:var(--size); border-radius:50%;
      display:grid; place-items:center; color:#b9c9e6;
      border:1px solid rgba(124,244,91,.38);
      background:linear-gradient(180deg, rgba(9,20,40,.48), rgba(9,20,40,.30));
      box-shadow: inset 0 2px 10px rgba(36,86,255,.16), inset 0 -2px 10px rgba(124,244,91,.18);
      font-weight:700; font-size:14px;
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
      backdrop-filter: blur(8px);
    }
    .chip.active{
      color:#061427; border-color:transparent;
      background:linear-gradient(135deg, rgba(124,244,91,.95), rgba(36,86,255,.95));
      box-shadow: var(--glowG), var(--glowB);
      transform: translateY(-1px);
    }

    /* Grilles et champs */
    .grid{ display:grid; gap:16px }
    .row{ display:grid; gap:12px }
    @media(min-width:760px){ .row-2{ grid-template-columns:1fr 1fr } .row-3{ grid-template-columns:1fr 1fr 1fr } }
    label{ display:block; font-size:14px; margin-bottom:6px; color:var(--muted) }
    input, select, textarea{
      width:100%; background:rgba(9,20,40,.55); color:var(--text);
      border:1px solid rgba(124,244,91,.30); border-radius:12px; padding:12px 14px;
      outline:none; backdrop-filter: blur(6px);
      transition: border .2s ease, box-shadow .2s ease, background .2s ease;
      box-shadow: inset 0 0 0 1px rgba(36,86,255,.10);
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--accentG);
      background:rgba(9,20,40,.68);
      box-shadow: 0 0 0 3px rgba(124,244,91,.18), inset 0 0 0 1px rgba(36,86,255,.12);
    }

    /* Boutons */
    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700; padding:12px 18px; border-radius:12px;
      background:linear-gradient(90deg, var(--accentG), var(--accentB)); color:#02121f;
      box-shadow:0 10px 28px rgba(36,86,255,.24), 0 10px 28px rgba(124,244,91,.28);
      transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover{ filter:brightness(1.06); box-shadow:0 14px 36px rgba(36,86,255,.28), 0 14px 36px rgba(124,244,91,.32) }
    .btn:active{ transform: translateY(1px) }
    .btn.secondary{ background:rgba(9,20,40,.55); color:var(--text); border:1px solid rgba(124,244,91,.35) }
    .btn.ghost{ background:transparent; color:var(--text); border:1px dashed rgba(124,244,91,.38) }

    /* État des étapes (fidèle à ta capture) */
    .step-card{
      border:1px solid var(--card-border);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%), rgba(12,21,42,.38);
      padding:16px; display:grid; gap:8px; backdrop-filter: blur(10px) saturate(120%);
      box-shadow: inset 0 0 0 1px var(--card-inner);
    }
    .step-card h3{ margin:0; font-size:16px; color:var(--accentG); text-shadow: 0 0 10px rgba(124,244,91,.35); }
    .step-card p{ margin:0; color:#cfe0ff }

    /* Étapes visibles / masquées */
    .step{ display:none }
    .step.active{ display:block }

    /* Résultats PubMed */
    .pub-card{ border:1px solid rgba(124,244,91,.28); border-radius:14px; padding:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%), rgba(12,21,42,.38);
      display:grid; gap:8px; backdrop-filter: blur(10px) saturate(120%); box-shadow: inset 0 0 0 1px rgba(36,86,255,.10); }
    .pub-actions{ display:flex; gap:8px; flex-wrap:wrap }
    .tag{ font-size:11px; padding:4px 8px; border:1px solid rgba(124,244,91,.28); border-radius:999px; color:#cfe6ff; background:rgba(9,20,40,.45) }
    .score{ font-weight:700; color:var(--accentG); text-shadow: 0 0 6px rgba(124,244,91,.5) }
    .muted{ color:var(--muted) }

    .footer{ text-align:center; color:var(--muted); font-size:12px; padding:18px 0 48px }
    a{ color:var(--accentG); text-decoration:none }
    a:hover{ text-decoration:underline }
  </style>
</head>

<body>
  <!-- Particules vertes flottantes -->
  <canvas id="particlesCanvas"></canvas>

  <!-- Barre de navigation avec logo officiel (fichier séparé, fond transparent) -->
  <header>
    <div class="nav">
      <img src="./montes-biopharma-logo.png" alt="Montes BioPharma" class="logo" style="height:42px"/>
      <div class="brand">Montes BioPharma</div>
      <div style="margin-left:auto" class="muted">Assistant IA (ossature sûre)</div>
    </div>
  </header>

  <main class="container">
    <!-- Hero -->
    <div class="hero">
      <img src="./assets/montes-biopharma-logo.svg" alt="Montes BioPharma" class="logo"
           style="height:78px; filter: drop-shadow(0 10px 26px rgba(124,244,91,.30)) drop-shadow(0 12px 30px rgba(36,86,255,.22))"/>
      <h1>Purification Adénovirus — Assistant d’aide à la documentation &amp; bibliographie</h1>
    </div>

    <!-- Progression + puces étapes -->
    <div class="card">
      <div class="progress"><span id="progressBar"></span></div>
      <div class="steps" id="stepsChips"></div>
    </div>

    <!-- Wizard -->
    <section class="card">
      <!-- Étape 1 -->
      <div id="step-1" class="step active" data-title="1">
        <div class="grid">
          <div class="step-card">
            <h3>Étape 1 — Contexte & conformité</h3>
            <p class="muted">Usage strictement professionnel. L’application génère une <em>ossature documentaire</em> — pas de paramètres ni de procédures expérimentales.</p>
          </div>

          <div class="row row-2">
            <div>
              <label>Organisation / Société</label>
              <input id="org" placeholder="ex: Thermo Fisher Scientific" />
            </div>
            <div>
              <label>Rôle</label>
              <input id="role" placeholder="ex: GMP Operations Manager" />
            </div>
          </div>

          <div class="step-card">
            <label style="display:flex; gap:10px; align-items:flex-start">
              <input type="checkbox" id="complianceChk" style="width:auto; margin-top:3px"/>
              <span>Je confirme être un professionnel au sein d’une organisation habilitée et n’utiliser que des <strong>SOP internes approuvées</strong>. Pas d’usage domestique.</span>
            </label>
          </div>

          <div style="display:flex; gap:10px; margin-top:4px">
            <button class="btn" data-next>Continuer</button>
          </div>
        </div>
      </div>

      <!-- Étape 2 -->
      <div id="step-2" class="step" data-title="2">
        <div class="step-card"><h3>Étape 2 — Paramètres biologiques (métadonnées)</h3></div>
        <div class="row row-3">
          <div>
            <label>Type de vecteur</label>
            <select id="vectorType">
              <option value="">— Sélectionner —</option>
              <option>Adénovirus</option>
              <option disabled>Autres (désactivés)</option>
            </select>
          </div>
          <div>
            <label>Sérotype</label>
            <input id="serotype" placeholder="ex: Ad5"/>
          </div>
          <div>
            <label>Lignée cellulaire</label>
            <input id="cellLine" placeholder="ex: HEK293 / PER.C6"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Mots-clés supplémentaires (pour la recherche biblio)</label>
            <input id="keywords" placeholder="ex: chromatography, TFF, affinity, anion exchange"/>
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="btn secondary" data-prev>Retour</button>
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <!-- Étape 3 -->
      <div id="step-3" class="step" data-title="3">
        <div class="step-card"><h3>Étape 3 — Choix des grandes étapes</h3></div>
        <div class="row row-2">
          <div class="step-card">
            <label><input type="checkbox" id="upstream" style="width:auto; margin-right:10px">Upstream (métadonnées uniquement)</label>
            <p class="muted">Décrire objectifs, points CQ, références internes (SOP-UP-###). <em>Pas de paramètres opératoires.</em></p>
          </div>
          <div class="step-card">
            <label><input type="checkbox" id="downstream" style="width:auto; margin-right:10px">Downstream (métadonnées uniquement)</label>
            <p class="muted">Structure documentaire aval (catégories & SOP-DS-###). <em>Pas de volumes ni vitesses.</em></p>
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="btn secondary" data-prev>Retour</button>
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <!-- Étape 4 -->
      <div id="step-4" class="step" data-title="4">
        <div class="step-card"><h3>Étape 4 — Sous-étapes (catégories)</h3></div>
        <div class="grid">
          <div class="step-card">
            <h3>Upstream — catégories</h3>
            <div class="row row-3">
              <label><input type="checkbox" class="up-cat" value="Conception & contrôles d’entrée (métadonnées)"/> Conception & contrôles d’entrée (métadonnées)</label>
              <label><input type="checkbox" class="up-cat" value="Qualité des matières (métadonnées)"/> Qualité des matières (métadonnées)</label>
              <label><input type="checkbox" class="up-cat" value="Contrôles en cours & libération (métadonnées)"/> Contrôles en cours & libération (métadonnées)</label>
            </div>
          </div>
          <div class="step-card">
            <h3>Downstream — catégories</h3>
            <div class="row row-3">
              <label><input type="checkbox" class="ds-cat" value="Clarification (métadonnées)"/> Clarification (métadonnées)</label>
              <label><input type="checkbox" class="ds-cat" value="Capture (métadonnées)"/> Capture (métadonnées)</label>
              <label><input type="checkbox" class="ds-cat" value="Polishing (métadonnées)"/> Polishing (métadonnées)</label>
              <label><input type="checkbox" class="ds-cat" value="Concentration & échange de tampon (métadonnées)"/> Concentration & échange de tampon (métadonnées)</label>
              <label><input type="checkbox" class="ds-cat" value="Contrôles qualité & attributs critiques (métadonnées)"/> Contrôles qualité & attributs critiques (métadonnées)</label>
              <label><input type="checkbox" class="ds-cat" value="Conditionnement documentaire (métadonnées)"/> Conditionnement documentaire (métadonnées)</label>
            </div>
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="btn secondary" data-prev>Retour</button>
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <!-- Étape 5 -->
      <div id="step-5" class="step" data-title="5">
        <div class="step-card"><h3>Étape 5 — Recherche PubMed</h3></div>
        <div class="grid" style="grid-template-columns:1fr 1.15fr; gap:16px">
          <div class="step-card">
            <div class="row">
              <div>
                <label>Activer la recherche d’articles récents</label>
                <label style="display:flex; gap:8px; align-items:center">
                  <input type="checkbox" id="enablePubMed" style="width:auto"> <span>Oui</span>
                </label>
              </div>
              <div class="row row-2">
                <div>
                  <label>Fenêtre (années récentes)</label>
                  <select id="yearsWindow">
                    <option value="1">1 an</option>
                    <option value="2" selected>2 ans</option>
                    <option value="5">5 ans</option>
                    <option value="10">10 ans</option>
                  </select>
                </div>
                <div>
                  <label>Nombre max. d’articles</label>
                  <select id="retMax">
                    <option>10</option><option selected>20</option><option>50</option>
                  </select>
                </div>
              </div>
              <div>
                <button id="runSearch" class="btn">Lancer la recherche</button>
              </div>
              <p class="muted">Seules des informations bibliographiques sont affichées (titres, auteurs, journaux, liens). <strong>Aucune procédure expérimentale.</strong></p>
            </div>
          </div>
          <div id="pubResults" class="grid"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="btn secondary" data-prev>Retour</button>
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <!-- Étape 6 -->
      <div id="step-6" class="step" data-title="6">
        <div class="step-card"><h3>Étape 6 — Ossature du protocole (à compléter par vos SOP)</h3></div>
        <div class="step-card">
          <div class="row row-2">
            <div>
              <label>Titre du document</label>
              <input id="docTitle" placeholder="Ossature protocole – Adénovirus (exemple)"/>
            </div>
            <div>
              <label>Identifiants internes (SOP, version, référence)</label>
              <input id="internalRefs" placeholder="ex: SOP-DS-001 v1.2 ; SOP-UP-003 v3.0"/>
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <div>
              <label>Résumé / But (sans paramètres expérimentaux)</label>
              <textarea id="summary" rows="4" placeholder="But, portée, définitions, CQ, responsabilités."></textarea>
            </div>
            <div>
              <label>Contraintes réglementaires & QMS</label>
              <textarea id="qms" rows="4" placeholder="ISO 13485, GMP, ALCOA+, data integrity, change control…"></textarea>
            </div>
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="btn secondary" data-prev>Retour</button>
          <button class="btn" data-next>Continuer</button>
        </div>
      </div>

      <!-- Étape 7 -->
      <div id="step-7" class="step" data-title="7">
        <div class="step-card"><h3>Étape 7 — Aperçu & export PDF</h3></div>
        <div id="preview" class="step-card" style="white-space:pre-wrap"></div>
        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
          <button class="btn" id="exportPdf">Exporter en PDF</button>
          <button class="btn ghost" id="startOver">Recommencer</button>
          <button class="btn secondary" data-prev>Retour</button>
        </div>
      </div>
    </section>

    <p class="footer">
      © <span id="year"></span> Montes BioPharma — Front-end client-side. Cette application n’inclut aucun protocole expérimental ni paramètre opératoire.
    </p>
  </main>

  <!-- jsPDF CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

  <script>
    /* ========= THEME ========= */
    const THEME = { green:"#7CF45B", blue:"#2456FF", text:"#111", gray:"#555" };

    /* ========= ÉTAT ========= */
    const stepsEls = [...document.querySelectorAll('.step')];
    const bar = document.getElementById('progressBar');
    const chips = document.getElementById('stepsChips');
    const state = {
      org:"", role:"",
      vectorType:"", serotype:"", cellLine:"", keywords:"",
      upstream:false, downstream:false,
      upCats:[], dsCats:[],
      enablePubMed:false, yearsWindow:2, retMax:20,
      articles:[], // {uid,title,source,year,authors,pmid,url,score,selected}
      docTitle:"", internalRefs:"", summary:"", qms:""
    };

    /* ========= INIT ========= */
    function init(){
      document.getElementById('year').textContent = new Date().getFullYear();

      chips.innerHTML = stepsEls.map((s,i)=>`<span class="chip" data-chip="${i}">${i+1}</span>`).join('');

      document.querySelectorAll('[data-next]').forEach(b=>b.addEventListener('click', ()=>gotoStep(currentStep+1)));
      document.querySelectorAll('[data-prev]').forEach(b=>b.addEventListener('click', ()=>gotoStep(currentStep-1)));

      // Bind inputs
      bind('org'); bind('role'); bind('serotype'); bind('cellLine'); bind('keywords');
      document.getElementById('vectorType').addEventListener('change', e=>{state.vectorType=e.target.value; persist();});
      document.getElementById('upstream').addEventListener('change', e=>{state.upstream=e.target.checked; persist();});
      document.getElementById('downstream').addEventListener('change', e=>{state.downstream=e.target.checked; persist();});
      document.querySelectorAll('.up-cat').forEach(c=>c.addEventListener('change', syncCats));
      document.querySelectorAll('.ds-cat').forEach(c=>c.addEventListener('change', syncCats));
      document.getElementById('enablePubMed').addEventListener('change', e=>{state.enablePubMed=e.target.checked; persist();});
      document.getElementById('yearsWindow').addEventListener('change', e=>{state.yearsWindow=+e.target.value; persist();});
      document.getElementById('retMax').addEventListener('change', e=>{state.retMax=+e.target.value; persist();});
      document.getElementById('runSearch').addEventListener('click', runPubMedSearch);
      bind('docTitle'); bind('internalRefs'); bind('summary', true); bind('qms', true);

      document.getElementById('exportPdf').addEventListener('click', exportPDF);
      document.getElementById('startOver').addEventListener('click', ()=>{ localStorage.removeItem('mbp_state'); location.reload(); });

      // restore
      try{
        const saved = JSON.parse(localStorage.getItem('mbp_state')||"null");
        if(saved){ Object.assign(state, saved); hydrate(); }
      }catch(e){}

      renderPreview();
      startParticles();
    }
    function bind(id, isTextArea=false){
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', e=>{ state[id]=e.target.value; persist(); });
    }
    function syncCats(){
      state.upCats = [...document.querySelectorAll('.up-cat:checked')].map(c=>c.value);
      state.dsCats = [...document.querySelectorAll('.ds-cat:checked')].map(c=>c.value);
      persist();
    }

    let currentStep = 0;
    function gotoStep(i){
      if(i>0){
        const ok = document.getElementById('complianceChk').checked;
        if(!ok){ alert("Veuillez valider la déclaration de conformité (usage professionnel)."); return; }
      }
      if(i<0 || i>=stepsEls.length) return;
      stepsEls[currentStep].classList.remove('active');
      currentStep = i;
      stepsEls[currentStep].classList.add('active');
      const percent = Math.round(((currentStep+1)/stepsEls.length)*100);
      bar.style.width = percent+"%";
      [...chips.children].forEach((chip,idx)=>chip.classList.toggle('active', idx===currentStep));
      renderPreview();
      persist();
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function hydrate(){
      const set = (id, v, prop='value')=>{ const el=document.getElementById(id); if(el && v) el[prop]=v; };
      set('org', state.org); set('role', state.role); set('vectorType', state.vectorType);
      set('serotype', state.serotype); set('cellLine', state.cellLine); set('keywords', state.keywords);
      document.getElementById('upstream').checked = !!state.upstream;
      document.getElementById('downstream').checked = !!state.downstream;
      document.querySelectorAll('.up-cat').forEach(c=>c.checked = state.upCats.includes(c.value));
      document.querySelectorAll('.ds-cat').forEach(c=>c.checked = state.dsCats.includes(c.value));
      document.getElementById('enablePubMed').checked = !!state.enablePubMed;
      set('yearsWindow', state.yearsWindow); set('retMax', state.retMax);
      set('docTitle', state.docTitle); set('internalRefs', state.internalRefs);
      set('summary', state.summary, 'value'); set('qms', state.qms, 'value');
      if(state.articles?.length) renderArticles(state.articles);
    }

    function persist(){ localStorage.setItem('mbp_state', JSON.stringify(state)); }

    /* ========= PubMed (biblio uniquement) ========= */
    async function runPubMedSearch(){
      if(!state.enablePubMed){ alert("Activez la recherche."); return; }
      const base = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/';
      const terms = [
        'adenovirus',
        (state.serotype||'').trim(),
        (state.cellLine||'').trim(),
        ...(state.keywords||'').split(',').map(s=>s.trim()).filter(Boolean)
      ].filter(Boolean).join(' ');
      const mindate = new Date(); mindate.setFullYear(mindate.getFullYear()- (+state.yearsWindow||2));
      const yfrom = mindate.getFullYear();

      try{
        const esearchUrl = `${base}esearch.fcgi?db=pubmed&retmode=json&sort=date&retmax=${encodeURIComponent(state.retMax||20)}&term=${encodeURIComponent(terms)}+AND+(${yfrom}%3A3000%5Bdp%5D)`;
        const esResp = await fetch(esearchUrl);
        const es = await esResp.json();
        const ids = es.esearchresult?.idlist || [];
        if(!ids.length){ renderArticles([]); alert("Aucun article trouvé avec ces critères."); return; }

        const esumUrl = `${base}esummary.fcgi?db=pubmed&retmode=json&id=${ids.join(',')}`;
        const sumResp = await fetch(esumUrl);
        const sum = await sumResp.json();
        const recs = Object.values(sum.result||{}).filter(v=>v?.uid);

        const kw = (state.keywords||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
        const scored = recs.map(r=>{
          const title = r.title||'';
          const journal = r.fulljournalname||r.source||'';
          const year = (r.pubdate||'').slice(0,4);
          const authors = (r.authors||[]).map(a=>a.name).slice(0,6);
          const pmid = r.uid;
          const url = `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`;
          let score = 0;
          const t = title.toLowerCase();
          if((state.serotype||'').toLowerCase() && t.includes((state.serotype||'').toLowerCase())) score+=2;
          if((state.cellLine||'').toLowerCase() && t.includes((state.cellLine||'').toLowerCase())) score+=2;
          kw.forEach(k=>{ if(k && (t.includes(k) || journal.toLowerCase().includes(k))) score+=1; });
          const y = parseInt(year||'0',10); const now = new Date().getFullYear();
          if(y && now-y <= 2) score+=2; else if(y && now-y<=5) score+=1;
          return {uid:pmid, title, source:journal, year, authors, pmid, url, score, selected:false};
        }).sort((a,b)=>b.score-a.score);

        state.articles = scored;
        renderArticles(scored);
        persist();
      }catch(err){
        console.error(err);
        alert("Erreur lors de la recherche PubMed (connexion ou limites d’API).");
      }
    }

    function renderArticles(list){
      const box = document.getElementById('pubResults');
      if(!list.length){ box.innerHTML = '<div class="step-card muted">Aucun résultat pour l’instant.</div>'; return; }
      box.innerHTML = '';
      list.forEach(rec=>{
        const el = document.createElement('div');
        el.className = 'pub-card';
        el.innerHTML = `
          <div><strong>${sanitize(rec.title)}</strong></div>
          <div class="muted">${sanitize(rec.source)} · ${sanitize(rec.year||'—')}</div>
          <div class="muted">Auteurs: ${sanitize((rec.authors||[]).join(', '))}</div>
          <div class="pub-actions">
            <span class="tag">PMID: ${rec.pmid}</span>
            <span class="tag">Score: <span class="score">${rec.score}</span></span>
            <a class="tag" href="${rec.url}" target="_blank" rel="noopener noreferrer">Voir sur PubMed</a>
            <button class="btn secondary" data-toggle="${rec.uid}">${rec.selected?'Désélectionner':'Sélectionner'}</button>
          </div>
        `;
        el.querySelector(`[data-toggle="${rec.uid}"]`).addEventListener('click', ()=>{
          rec.selected = !rec.selected;
          renderArticles(state.articles); persist(); renderPreview();
        });
        box.appendChild(el);
      });
    }

    /* ========= Aperçu (ossature) ========= */
    function renderPreview(){
      const meta = [
        state.org ? `Organisation : ${state.org}` : null,
        state.role ? `Rôle : ${state.role}` : null,
      ].filter(Boolean).join('\n');

      const selections = [
        state.vectorType ? `Vecteur : ${state.vectorType}` : null,
        state.serotype ? `Sérotype : ${state.serotype}` : null,
        state.cellLine ? `Lignée cellulaire : ${state.cellLine}` : null,
        state.upstream ? `Sections Upstream (métadonnées)` : null,
        ...state.upCats.map(c=>'  • '+c),
        state.downstream ? `Sections Downstream (métadonnées)` : null,
        ...state.dsCats.map(c=>'  • '+c),
      ].filter(Boolean).join('\n');

      const refs = (state.articles||[]).filter(a=>a.selected).map(a=>`- ${a.title} (${a.year}). ${a.source}. PMID:${a.pmid} — ${a.url}`);

      const outline = `# ${state.docTitle || 'Ossature protocole — Adénovirus (exemple)'}\n
${meta}\n
## 1. But, portée et définitions
${state.summary || 'Décrire la finalité du document, la portée, les définitions clés et les responsabilités. Ne pas inclure de paramètres expérimentaux.'}

## 2. Référentiel qualité et conformité
${state.qms || 'Lister les référentiels applicables (ex. ISO 13485, GMP), data integrity (ALCOA+), gestion documentaire, change control, training, risk management.'}

## 3. Métadonnées du produit et du procédé
${selections || 'Renseigner les métadonnées du procédé (sans paramètres opératoires). Inclure références internes de SOP.'}
  - Références internes : ${state.internalRefs || 'à compléter'}

## 4. Vue d’ensemble des sections (sans procédures)
- Upstream (si applicable) : objectifs, CQ d’entrée, références SOP-*** (sans détails).
- Downstream (si applicable) : catégories documentaires (clarification, capture, polishing, TFF, CQ), références SOP-***.

## 5. Références bibliographiques (sélectionnées)
${refs.length ? refs.join('\n') : 'Aucune référence sélectionnée pour le moment.'}

## 6. Annexes (gabarits & check-lists)
- Check-list de préparation documentaire (gabarit).
- Matrice de traçabilité & data integrity (gabarit).
- Registre des versions et change control.
`;
      document.getElementById('preview').textContent = outline;
    }

    /* ========= Export PDF (clair, texte noir, titres aux couleurs thème, logo à gauche) ========= */
    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({unit:'pt', format:'a4'});
      const margin = 56;
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      // fond blanc
      pdf.setFillColor(255,255,255);
      pdf.rect(0,0,pageW,pageH,'F');

      // charger logo externe (même fichier que l'app)
      let logoData = null;
      try{
        logoData = await fetchAsDataURL('./assets/montes-biopharma-logo.svg');
      }catch(e){ /* ignore */ }

      // entête
      const headerY = margin;
      if(logoData){
        try{ pdf.addImage(logoData, 'PNG', margin, headerY-8, 160, 40, undefined, 'FAST'); }catch(e){}
      }

      // Titre et sous-titre
      setText(pdf, THEME.blue, 18, 'bold');
      const title = state.docTitle || 'Ossature protocole — Adénovirus';
      pdf.text(title, margin + (logoData?180:0), headerY + 14);

      setText(pdf, '#3a3a3a', 11, 'normal');
      pdf.text((state.internalRefs || ''), margin + (logoData?180:0), headerY + 34);

      // Double règle colorée
      pdf.setDrawColor(...hexToRGB(THEME.green)); pdf.setLineWidth(2);
      pdf.line(margin, headerY+50, pageW - margin, headerY+50);
      pdf.setDrawColor(...hexToRGB(THEME.blue)); pdf.setLineWidth(2);
      pdf.line(margin, headerY+54, pageW - margin, headerY+54);

      let y = headerY + 80;

      // Contenu
      const content = document.getElementById('preview').textContent;
      const blocks = content.split('\n');

      for(let raw of blocks){
        const line = raw.trim();
        if(!line){ y += 6; continue; }
        if(line.startsWith('# ')){
          y = putHeading(pdf, line.replace(/^#\s+/,''), y, 16, THEME.blue, margin, pageW, pageH);
        }else if(line.startsWith('## ')){
          y = putHeading(pdf, line.replace(/^##\s+/,''), y, 13, THEME.green, margin, pageW, pageH);
        }else{
          y = putParagraph(pdf, line, y, margin, pageW, pageH, 11);
        }
      }

      pdf.save((title.replace(/\s+/g,'-').toLowerCase())+'.pdf');
    }

    async function fetchAsDataURL(url){
      const res = await fetch(url);
      const blob = await res.blob();
      return await new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onerror = reject;
        fr.onload = ()=> resolve(fr.result);
        fr.readAsDataURL(blob);
      });
    }
    function setText(pdf, hex, size, weight){
      const rgb = hexToRGB(hex);
      pdf.setTextColor(rgb[0], rgb[1], rgb[2]);
      pdf.setFont('helvetica', weight==='bold'?'bold':'normal');
      pdf.setFontSize(size);
    }
    function putHeading(pdf, text, y, size, color, M, W, H){
      if(y + size + 18 > H - M){ pdf.addPage(); pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F'); y = M; }
      setText(pdf, color, size, 'bold');
      pdf.text(text, M, y);
      y += size < 14 ? 12 : 16;
      pdf.setDrawColor(210,210,210); pdf.setLineWidth(0.6);
      pdf.line(M, y, W - M, y);
      return y + 12;
    }
    function putParagraph(pdf, text, y, M, W, H, size=11){
      setText(pdf, '#000000', size, 'normal');
      const lines = pdf.splitTextToSize(text, W - 2*M);
      for(const ln of lines){
        if(y > H - M){ pdf.addPage(); pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F'); y = M; }
        pdf.text(ln, M, y); y += 14;
      }
      return y + 4;
    }
    function hexToRGB(hex){
      const h = hex.replace('#',''); const n = parseInt(h,16);
      return [(n>>16)&255, (n>>8)&255, n&255];
    }
    function sanitize(s){ return (s||'').replace(/[<>&]/g, c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])); }

    /* ========= Particules vertes (drift + twinkle) ========= */
    let P = []; let ctx, W, H, rafId;
    function startParticles(){
      const canvas = document.getElementById('particlesCanvas');
      ctx = canvas.getContext('2d');
      const setSize = ()=>{ W = canvas.width = innerWidth; H = canvas.height = innerHeight; };
      setSize(); addEventListener('resize', setSize);

      const count = Math.min(200, Math.round((W*H)/15000)); // densité douce
      P = Array.from({length:count}, ()=>spawnParticle());
      cancelAnimationFrame(rafId);
      loopParticles();
    }
    function spawnParticle(){
      const r = rnd(0.9, 2.2);
      return {
        x: Math.random()*W, y: Math.random()*H,
        vx: rnd(-0.08, 0.08), vy: -rnd(0.05, 0.16),
        r, t: Math.random()*1000, tw: rnd(0.5, 1.0)
      };
    }
    function loopParticles(){
      rafId = requestAnimationFrame(loopParticles);
      ctx.clearRect(0,0,W,H);
      for(const p of P){
        p.t += 0.02; const a = 0.20 + 0.40*Math.abs(Math.sin(p.t))*p.tw;
        p.x += p.vx + Math.sin(p.t*0.5)*0.04;
        p.y += p.vy;
        if(p.x<-5) p.x=W+5; if(p.x>W+5) p.x=-5; if(p.y<-5){ p.y=H+5; p.x=Math.random()*W; }
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,6.283);
        ctx.fillStyle = `rgba(124,244,91,${a})`;
        ctx.shadowColor = 'rgba(124,244,91,.75)'; ctx.shadowBlur = 8;
        ctx.fill(); ctx.shadowBlur = 0;
      }
    }
    const rnd=(a,b)=>a+Math.random()*(b-a);

    /* ========= GO ========= */
    init();
  </script>
</body>
</html>
